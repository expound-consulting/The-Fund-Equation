<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>VC Waterfall Calculator</title>
    
    <!-- Chart.js CDN for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* CSS Variables for theming */
        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --primary-light: #e6f2ff;
            --success: #00a854;
            --warning: #ffb700;
            --danger: #e63946;
            --dark: #1a1a1a;
            --gray-dark: #4a4a4a;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --light: #f8f9fa;
            --white: #ffffff;
            
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --border-radius: 8px;
            --transition: all 0.3s ease;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
        }

        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            font-size: 16px;
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, var(--light) 0%, var(--white) 100%);
            min-height: 100vh;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
            border-bottom: 2px solid var(--gray-light);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            color: var(--gray);
            font-size: 1.1rem;
        }

        /* Tooltip System */
        .tooltip {
            position: relative;
            border-bottom: 1px dotted var(--primary);
            cursor: help;
            color: var(--primary);
        }

        .tooltip-portal {
            position: fixed;
            z-index: 10000;
            pointer-events: none;
            display: none;
        }

        .tooltip-portal-content {
            background: var(--dark);
            color: var(--white);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            max-width: 250px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: tooltipFadeIn 0.2s ease;
        }

        .tooltip-portal-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .tooltip-portal-arrow.top {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-color: var(--dark) transparent transparent;
        }

        .tooltip-portal-arrow.bottom {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 6px 6px;
            border-color: transparent transparent var(--dark);
        }

        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-2px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Allow multiline tooltips */
        .tooltip.multiline::before {
            white-space: normal;
            text-align: center;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .nav-link {
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            text-decoration: none;
            color: var(--gray-dark);
            font-weight: 500;
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
        }

        .nav-link:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .nav-link.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        /* Main content area */
        .main-content {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            min-height: 400px;
        }

        /* Cards */
        .card {
            background: var(--white);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .card-header[data-collapsible] {
            cursor: pointer;
            position: relative;
        }

        .collapse-icon {
            font-family: monospace;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--gray);
            transition: transform 0.3s ease;
        }
        
        .collapse-icon::before {
            content: '-';
        }
        
        .card.collapsed .collapse-icon::before {
             content: '+';
        }
        
        .card-content {
            transition: opacity 0.3s ease, padding-top 0.4s ease, padding-bottom 0.4s ease;
        }

        .card.collapsed .card-header {
            margin-bottom: 0;
            border-bottom: 1px solid transparent;
        }

        .card.collapsed .card-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* Timeline */
        .timeline {
            display: flex;
            align-items: center;
            padding: 1rem;
            overflow-x: auto;
            gap: 0;
        }

        .timeline-node {
            width: 120px;
            height: 100px;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
        }

        .timeline-node:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .timeline-node.available {
            cursor: pointer;
        }

        .timeline-connector {
            width: 30px;
            height: 2px;
            transition: all 0.3s ease;
        }

        /* Round cards */
        .round-card {
            border-left: 4px solid var(--primary);
            animation: slideIn 0.3s ease;
        }
        
        .rounds-list {
            max-height: none;
            overflow: visible;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block;
            text-align: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(1px) scale(0.98);
            box-shadow: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray);
            color: var(--white);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Multiple buttons in header */
        .header-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Tabs for results view - Fixed for mobile stability */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-light);
            position: relative; /* Add positioning context */
            overflow-x: auto; /* Allow horizontal scroll on mobile */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scroll-behavior: smooth;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--gray);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            bottom: -2px;
            white-space: nowrap; /* Prevent text wrapping */
            flex-shrink: 0; /* Prevent button compression */
            -webkit-tap-highlight-color: transparent; /* Remove iOS tap highlight */
            touch-action: manipulation; /* Prevent double-tap zoom */
        }

        .tab-button:hover {
            color: var(--primary);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            pointer-events: none; /* Prevent re-clicking active tab */
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Chart containers */
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        /* Sensitivity table styling */
        .sensitivity-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .sensitivity-table thead {
             background: #003d7a;
        }

        .sensitivity-table tr {
            transition: background 0.3s ease;
        }
        
        .sensitivity-table tr:hover {
            background: var(--primary-light) !important;
            cursor: pointer;
        }
        
        .sensitivity-table tr.current-scenario {
            box-shadow: inset 0 0 0 2px var(--primary);
        }

        /* Input groups */
        .input-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-dark);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .input-field:disabled {
            background: var(--gray-light);
            cursor: not-allowed;
        }
        
        /* Validation Styles */
        .input-field.is-invalid {
            border-color: var(--danger);
        }

        .input-field.is-valid {
            border-color: var(--success);
            padding-right: 35px;
        }
        
        .input-field.is-invalid:focus {
             border-color: var(--danger);
             box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.1);
        }
        
        .input-field.is-valid:focus {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(0, 168, 84, 0.1);
        }

        .error-message {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            min-height: 1.2em;
            transition: opacity 0.3s;
        }
        
        .warning-message {
            color: #d46b08; /* From .warning-box strong */
            font-size: 0.875rem;
            margin-top: 0.25rem;
            min-height: 1.2em;
            transition: opacity 0.3s;
        }

        .input-wrapper {
            position: relative;
        }

        .input-valid-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--success);
            font-weight: bold;
            pointer-events: none;
        }
        
        .validation-summary {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            animation: fadeIn 0.3s;
        }

        .warning-box {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        .warning-box strong {
            color: #d46b08;
        }

        /* Grid system */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        .grid-5 {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        
        .grid-payment {
            grid-template-columns: 2fr 1fr 1fr auto;
            align-items: center;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--gray-dark);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ownership badge */
        .ownership-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 1rem;
        }

        /* Safe card */
        .safe-card {
            background: var(--light);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            margin-left: 2rem;
        }
        
        .safe-card.highlight {
            animation: highlightPulse 1s ease;
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.3);
        }

        @keyframes highlightPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 102, 204, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 102, 204, 0.5); }
        }

        /* Checkbox styling & Toggle Switch */
        .checkbox-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            margin: -0.5rem; /* Counteract padding to maintain layout */
            border-radius: 4px;
        }
        .checkbox-label input {
            margin-right: 0.75rem;
        }
        .checkbox-label:active {
            background: var(--primary-light);
        }
        input[type="checkbox"] {
            width: 16px !important;
            min-width: 16px !important;
            max-width: 16px !important;
            height: 16px !important;
            min-height: 16px !important;
            max-height: 16px !important;
        }


        select.input-field {
            cursor: pointer;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-light);
            transition: var(--transition);
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: var(--white);
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        /* Calculation breakdown styles */
        #calculation-details {
            border: 1px solid var(--primary-light);
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            animation: fadeIn 0.5s ease;
        }
        .breakdown-step {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
        }
        .breakdown-step:last-child {
            border-bottom: none;
        }
        .breakdown-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }
        .breakdown-formula {
            background: var(--light);
            padding: 0.75rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .breakdown-item {
            padding: 0.5rem;
            margin-left: 2rem;
            border-left: 3px solid var(--gray-light);
        }
        .highlight-mechanism {
            background: var(--success);
            color: var(--white);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* Educational Popup */
        .educational-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        .educational-content {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            border-top: 4px solid var(--primary);
        }

        .educational-content h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .educational-content p {
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .educational-content button {
            display: block;
            width: 100%;
            margin-top: 1.5rem;
            padding: 0.75rem;
            border: none;
            background: var(--primary);
            color: var(--white);
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .educational-content button:hover {
            background: var(--primary-dark);
        }

        /* Learn page specific styles */
        .waterfall-diagram {
            font-family: monospace;
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            overflow-x: auto;
            white-space: pre;
            line-height: 1.3;
            font-size: 0.85rem;
            color: var(--dark);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .comparison-table th {
            background: #004a94; /* Darker blue for better contrast */
            color: var(--white);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 0.75rem;
            border: 1px solid var(--gray-light);
        }

        .comparison-table tr:nth-child(even) {
            background: var(--light);
        }

        .term-box {
            background: var(--primary-light);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .term-box h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .example-calc {
            background: var(--light);
            padding: 1rem;
            border-radius: var(--border-radius);
            font-family: monospace;
            margin: 1rem 0;
        }

        .step-number {
            display: inline-block;
            background: var(--primary);
            color: var(--white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 0.5rem;
            font-weight: 600;
        }
        
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            height: 60px;
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(60px + env(safe-area-inset-bottom));
        }

        .mobile-nav-link {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--gray);
            padding: 4px 0;
            transition: var(--transition);
        }

        .mobile-nav-link .icon {
            font-size: 1.25rem;
        }

        .mobile-nav-link .label {
            font-size: 0.7rem;
        }

        .mobile-nav-link.active {
            color: var(--primary);
        }
        
        .mobile-nav-link:active {
            background: var(--primary-light);
            transform: scale(0.97);
        }
        
        .table-scroll-wrapper {
            position: relative;
            isolation: isolate; /* Create new stacking context */
        }

        .table-scroll-wrapper table {
            border-collapse: collapse; /* Ensure borders don't double up */
            min-width: 600px; /* Force scrolling on smaller screens */
        }
        
        /* Make the first column sticky with proper layering */
        .table-scroll-wrapper th:first-child,
        .table-scroll-wrapper td:first-child {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            left: 0;
            z-index: 10; /* Increased z-index to stay above other content */
            /* Add a shadow to indicate scrollability */
            box-shadow: 5px 0 5px -5px rgba(0,0,0,0.1);
        }

        /* Ensure header stays on top with higher z-index */
        .table-scroll-wrapper th:first-child {
            z-index: 11; /* Higher than body cells */
        }

        /* Set background colors to prevent text overlap during scroll */
        .table-scroll-wrapper thead th {
            background: var(--primary);
            color: var(--white);
        }

        /* Important: Ensure sticky cells have solid backgrounds */
        .table-scroll-wrapper tbody tr td:first-child {
            background: var(--white) !important; /* Force solid background */
        }

        .table-scroll-wrapper tbody tr:nth-child(even) td:first-child {
            background: var(--light) !important; /* Force solid background */
        }

        /* Hover state for sticky column must also be handled */
        .table-scroll-wrapper tbody tr:hover td:first-child {
            background: var(--primary-light) !important;
        }

        /* Touch target improvements */
        button, .btn, input[type="radio"], select {
            min-height: 44px;
            min-width: 44px;
        }

        /* Ensure clickable areas are large enough */
        .nav-link, .mobile-nav-link, .tab-button {
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive */
        /* --- MOBILE: max-width: 767px --- */
        @media (max-width: 767px) {
            body {
                padding-bottom: calc(60px + env(safe-area-inset-bottom));
            }
            .container {
                padding: 1rem;
            }
            
            .nav {
                display: none;
            }
            .mobile-nav {
                display: flex;
            }

            .header h1 {
                font-size: 1.75rem;
            }
            .header p {
                font-size: 1rem;
            }

            .main-content {
                padding: 1rem;
                max-height: none;
            }
            
            .grid-2, .grid-3, .grid-4, .grid-5, .chart-grid, .grid-payment {
                grid-template-columns: 1fr;
            }

            .timeline {
                flex-direction: column;
                gap: 1rem;
                align-items: center; 
            }
            
            .timeline-node {
                width: 90%;
                max-width: 300px;
                height: auto;
                padding: 1rem;
            }

            .timeline-connector {
                width: 2px;
                height: 30px;
                margin: 0 auto;
            }
            
            .header-buttons {
                flex-direction: column;
                width: 100%;
                align-items: stretch;
            }
            
            .header-buttons .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .safe-card {
                margin-left: 0; 
            }
            
            .btn {
                 padding: 0.9rem 1.5rem;
            }

            .btn-sm {
                min-height: 44px;
                min-width: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            
            .card > .table-scroll-wrapper {
                margin: 0 -1rem; /* Allow table to use full screen width */
                padding: 0 1rem;
            }
            
            .waterfall-diagram {
                font-size: 0.7rem;
            }

            /* Mobile-specific fixes for overlapping elements */
            .header-buttons {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .header-buttons .btn {
                width: 100%;
                min-height: 44px; /* Touch target minimum */
                margin: 0;
            }
            
            /* Sensitivity analysis specific */
            #card-sensitivity-chart .header-buttons {
                flex-direction: column;
            }
            
            /* Chart container adjustments */
            .chart-container {
                min-height: 300px;
                max-height: 400px;
            }
            
            input[type="number"],
            input[type="date"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .input-field {
                min-height: 44px; /* Apple's recommended touch target */
            }

            /* Tab improvements for mobile */
            .tabs {
                scroll-snap-type: x mandatory; /* Snap to tabs while scrolling */
                padding-bottom: 0.5rem; /* Extra space for scroll indicator */
            }
            
            .tab-button {
                scroll-snap-align: start; /* Snap alignment */
                min-width: 100px; /* Minimum width for readability */
            }
            
            /* Ensure waterfall visualization doesn't break layout */
            .card-content {
                overflow-x: hidden; /* Prevent horizontal overflow */
            }
            
            /* Fix table sticky column backgrounds */
            .table-scroll-wrapper tbody tr td:first-child {
                background-color: var(--white) !important;
                opacity: 1;
            }
            
            .table-scroll-wrapper tbody tr:nth-child(even) td:first-child {
                background-color: var(--light) !important;
                opacity: 1;
            }
            
            /* Table total row fix */
            .table-scroll-wrapper tbody tr:last-child td:first-child {
                background: #003d7a !important;
                color: var(--white) !important;
            }
            
            /* Table scroll improvements */
            .table-scroll-wrapper {
                margin: 0 -1rem;
                padding: 0 1rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior-x: contain; /* Prevent parent scroll */
            }
        }
        
        /* --- TABLET: 768px to 1024px --- */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                padding: 1.5rem;
            }
            
            .header h1 {
                font-size: 2.25rem;
            }

            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
             .chart-grid {
                gap: 1.5rem;
            }
        }


        /* Utility classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--gray); }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .p-3 { padding: 1.5rem; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        
        // VC Waterfall Calculator

        // Code: MIT License (see LICENSE)
        // Content: CC BY-SA 4.0 (see LICENSE-CONTENT)

       //  © 2025 Expound Consulting — Ken Cheney & Robert Gibson
        
        // VC Waterfall Calculator - Complete Implementation
        const WaterfallCalculator = {
            // State Management
            state: {
                // Input data
                rounds: [],
                safes: [],
                exitDetails: {
                    grossValue: 100000000,
                    debt: 5000000,
                    legalFees: 500000,
                    advisorFeePercent: 2,
                    otherExpenses: 0,
                    exitDate: new Date().toISOString().split('T')[0],
                    managementCarveout: {
                        enabled: false,
                        percent: 10
                    },
                    mip: {
                        enabled: false,
                        percent: 0
                    },
                    escrowDetails: {
                        allocationMethod: 'proRata'
                    },
                    payments: [
                        { name: 'Closing Payment', date: new Date().toISOString().split('T')[0], percent: 90, isImmediate: true },
                        { name: 'Escrow Release', date: '', percent: 10, isImmediate: false }
                    ],
                    npvSettings: {
                        enabled: false,
                        discountRate: 10,
                        showBothValues: true
                    },
                    dragAlong: {
                        enabled: false,
                        commonThreshold: 50,
                        preferredThreshold: 50,
                        overrideUsed: false,
                        consentModel: 'model'
                    }
                },
                
                // Calculated results
                results: null,
                
                // UI state
                view: 'input',
                errors: {}, 
                warnings: {},
                collapsibleState: {},
                sensitivity: {
                    minExit: 0,
                    maxExit: 0,
                    stepCount: 10
                },
                validationMode: {
                    enabled: false,
                    ledger: [],
                    startTime: null,
                    endTime: null,
                    reconciliation: {
                        expected: 0,
                        actual: 0,
                        delta: 0,
                        balanced: false
                    }
                }
            },
            
            descriptionTimer: null,

            // Tooltip mapping for automated tooltips
            fieldTooltips: {
                'exitDetails.grossValue': 'Total sale price before any deductions. Industry standard: 2-10x capital raised for successful exits',
                'exitDetails.legalFees': 'Transaction costs for lawyers, accountants, and closing. Typical: 1-3% of exit value',
                'exitDetails.advisorFeePercent': 'Investment banker success fee. Industry standard: 1-3% for large deals, up to 5% for smaller deals',
                'exitDetails.otherExpenses': 'Additional costs like retention bonuses, integration costs. Varies widely by deal',
                'exitDetails.dragAlong.consentModel': 'Simulates whether shareholders would approve the sale. Model shows voting mechanics, Assume bypasses this check',
                'exitDetails.dragAlong.commonThreshold': 'Percentage of each class needed to approve sale. Standard: 50-67% for common, 50-67% for preferred',
                'exitDetails.dragAlong.preferredThreshold': 'Percentage of each class needed to approve sale. Standard: 50-67% for common, 50-67% for preferred',
                'exitDetails.npvSettings.discountRate': 'Rate to discount future cash flows. VC standard: 10-20% reflecting risk and time value'
            },

            // Funding Sequence Configuration
            fundingSequence: {
                order: ['founders', 'optionPool', 'safes', 'seed', 'seriesA', 'seriesB', 'seriesC'],
                
                roundDefaults: {
                    founders: {
                        name: 'Founders',
                        type: 'founders',
                        investment: 0,
                        shares: 10000000,
                        liquidationPref: 0,
                        participating: true,
                        isCommon: true,
                        removable: false,
                        icon: '👥',
                        splitRatio: 1
                    },
                    optionPool: {
                        name: 'Option Pool',
                        type: 'optionPool',
                        investment: 0,
                        shares: 1000000,
                        liquidationPref: 0,
                        participating: true,
                        isCommon: true,
                        removable: true,
                        icon: '🧑‍💼',
                        splitRatio: 1,
                        poolDetails: {
                            vestedPercent: 100,
                            exercisedPercent: 100,
                            strikePrice: 0
                        }
                    },
                    safes: {
                        name: 'SAFE Notes',
                        type: 'safes',
                        investment: 0,
                        shares: 0,
                        valuation: 0,
                        liquidationPref: 0,
                        participating: false,
                        removable: true,
                        icon: '📄'
                    },
                    seed: {
                        name: 'Seed Round',
                        type: 'seed',
                        investment: 2000000,
                        shares: 2000000,
                        valuation: 10000000,
                        liquidationPref: 1,
                        participating: false,
                        antiDilution: 'none',
                        antiDilutionBase: 'broad',
                        removable: true,
                        icon: '🌱',
                        seniority: 2,
                        participationCap: 0,
                        dividend: { enabled: false, ratePct: 8, issuedOn: '' },
                        payToPlay: { enabled: false, participated: true },
                        warrant: { enabled: false, coveragePct: 10, strike: 0.01 },
                        prefInterest: { enabled: false, ratePct: 5, startISO: '' },
                        redemption: { enabled: false, startISO: '', multiple: 1 },
                        splitRatio: 1
                    },
                    seriesA: {
                        name: 'Series A',
                        type: 'seriesA',
                        investment: 10000000,
                        shares: 2000000,
                        valuation: 50000000,
                        liquidationPref: 1,
                        participating: true,
                        antiDilution: 'none',
                        antiDilutionBase: 'broad',
                        removable: true,
                        icon: 'A',
                        seniority: 2,
                        participationCap: 0,
                        dividend: { enabled: false, ratePct: 8, issuedOn: '' },
                        payToPlay: { enabled: false, participated: true },
                        warrant: { enabled: false, coveragePct: 10, strike: 0.01 },
                        prefInterest: { enabled: false, ratePct: 5, startISO: '' },
                        redemption: { enabled: false, startISO: '', multiple: 1 },
                        splitRatio: 1
                    },
                    seriesB: {
                        name: 'Series B',
                        type: 'seriesB',
                        investment: 25000000,
                        shares: 2500000,
                        valuation: 150000000,
                        liquidationPref: 1,
                        participating: true,
                        antiDilution: 'none',
                        antiDilutionBase: 'broad',
                        removable: true,
                        icon: 'B',
                        seniority: 2,
                        participationCap: 0,
                        dividend: { enabled: false, ratePct: 8, issuedOn: '' },
                        payToPlay: { enabled: false, participated: true },
                        warrant: { enabled: false, coveragePct: 10, strike: 0.01 },
                        prefInterest: { enabled: false, ratePct: 5, startISO: '' },
                        redemption: { enabled: false, startISO: '', multiple: 1 },
                        splitRatio: 1
                    },
                    seriesC: {
                        name: 'Series C',
                        type: 'seriesC',
                        investment: 50000000,
                        shares: 2000000,
                        valuation: 500000000,
                        liquidationPref: 1,
                        participating: true,
                        antiDilution: 'none',
                        antiDilutionBase: 'broad',
                        removable: true,
                        icon: 'C',
                        seniority: 2,
                        participationCap: 0,
                        dividend: { enabled: false, ratePct: 8, issuedOn: '' },
                        payToPlay: { enabled: false, participated: true },
                        warrant: { enabled: false, coveragePct: 10, strike: 0.01 },
                        prefInterest: { enabled: false, ratePct: 5, startISO: '' },
                        redemption: { enabled: false, startISO: '', multiple: 1 },
                        splitRatio: 1
                    }
                },
                
                canAdd(type) {
                    const hasThis = WaterfallCalculator.state.rounds.some(r => r.type === type);
                    if (hasThis) return false;
                    
                    if (type === 'founders') return true;
                    
                    const hasFounders = WaterfallCalculator.state.rounds.some(r => r.type === 'founders');
                    if (!hasFounders) return false;
                    
                    if (type === 'optionPool' || type === 'safes' || type === 'seed') return true;
                    
                    if (type === 'seriesA') {
                        return WaterfallCalculator.state.rounds.some(r => r.type === 'seed');
                    }
                    
                    if (type === 'seriesB') {
                        return WaterfallCalculator.state.rounds.some(r => r.type === 'seriesA');
                    }
                    
                    if (type === 'seriesC') {
                        return WaterfallCalculator.state.rounds.some(r => r.type === 'seriesB');
                    }
                    
                    return false;
                },
                
                getDependents(type) {
                    const dependents = [];
                    
                    if (type === 'seed') {
                        ['seriesA', 'seriesB', 'seriesC'].forEach(seriesType => {
                            if (WaterfallCalculator.state.rounds.some(r => r.type === seriesType)) {
                                dependents.push(seriesType);
                            }
                        });
                    } else if (type === 'seriesA') {
                        ['seriesB', 'seriesC'].forEach(seriesType => {
                            if (WaterfallCalculator.state.rounds.some(r => r.type === seriesType)) {
                                dependents.push(seriesType);
                            }
                        });
                    } else if (type === 'seriesB') {
                        if (WaterfallCalculator.state.rounds.some(r => r.type === 'seriesC')) {
                            dependents.push('seriesC');
                        }
                    }
                    
                    return dependents;
                },
                
                cascadeRemove(type) {
                    const dependents = this.getDependents(type);
                    const typesToRemove = [type, ...dependents];
                    
                    WaterfallCalculator.state.rounds = WaterfallCalculator.state.rounds.filter(r => 
                        !typesToRemove.includes(r.type)
                    );
                    
                    if (type === 'safes') {
                        WaterfallCalculator.state.safes = [];
                    }
                }
            },

            // Routes
            routes: {
                '#/': 'renderInput',
                '#/results': 'renderResults',
                '#/sensitivity': 'renderSensitivity',
                '#/learn': 'renderLearn',
                '#/about': 'renderAbout'
            },

            // Example Scenarios
            exampleScenarios: {
                currentScenario: null,
                currentScenarioModified: false,
            
                earlySeed: {
                    name: 'Early Stage Success',
                    description: 'See how SAFEs convert and dilute at exit, and how early investors benefit from modest exits relative to their investment.',
                    rounds: [
                        { name: 'Founders', type: 'founders', investment: 0, shares: 8000000, liquidationPref: 0, participating: true, isCommon: true, removable: false, icon: '👥', splitRatio: 1 },
                        { name: 'SAFE Notes', type: 'safes', investment: 0, shares: 0, valuation: 0, liquidationPref: 0, participating: false, removable: true, icon: '📄' },
                        { name: 'Seed Round', type: 'seed', investment: 2000000, shares: 2000000, valuation: 10000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: '🌱', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2023-01-10' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 }
                    ],
                    safes: [{ amount: 500000, valuationCap: 4000000, discount: 20, capType: 'pre-money', mfnEnabled: false }],
                    exitDetails: {
                        grossValue: 25000000, debt: 500000, legalFees: 200000, advisorFeePercent: 2, otherExpenses: 100000, exitDate: '2025-09-01', 
                        managementCarveout: { enabled: false, percent: 10 }, 
                        mip: { enabled: false, percent: 0 }, 
                        escrowDetails: { allocationMethod: 'proRata' },
                        payments: [
                            { name: 'Closing Payment', date: '2025-09-01', percent: 90, isImmediate: true },
                            { name: 'Escrow Release', date: '2026-09-01', percent: 10, isImmediate: false }
                        ],
                        npvSettings: { enabled: false, discountRate: 10, showBothValues: true },
                        dragAlong: { enabled: false, commonThreshold: 50, preferredThreshold: 50, overrideUsed: false }
                    }
                },
                seriesAGrowth: {
                    name: 'Series A Growth',
                    description: 'Watch how liquidation preferences protect investors while founders still get meaningful returns in a successful exit.',
                    rounds: [
                        { name: 'Founders', type: 'founders', investment: 0, shares: 7000000, liquidationPref: 0, participating: true, isCommon: true, removable: false, icon: '👥', splitRatio: 1 },
                        { name: 'Seed Round', type: 'seed', investment: 2000000, shares: 1750000, valuation: 8000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: '🌱', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2022-06-15' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series A', type: 'seriesA', investment: 8000000, shares: 2250000, valuation: 32000000, liquidationPref: 1, participating: false, antiDilution: 'weightedAverage', antiDilutionBase: 'broad', removable: true, icon: 'A', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2023-09-01' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 }
                    ],
                    safes: [],
                    exitDetails: {
                        grossValue: 80000000, debt: 1000000, legalFees: 400000, advisorFeePercent: 2, otherExpenses: 200000, exitDate: '2025-11-20', 
                        managementCarveout: { enabled: true, percent: 8 }, 
                        mip: { enabled: false, percent: 0 }, 
                        escrowDetails: { allocationMethod: 'proRata' },
                        payments: [
                            { name: 'Closing Payment', date: '2025-11-20', percent: 90, isImmediate: true },
                            { name: 'Escrow Release', date: '2026-11-20', percent: 10, isImmediate: false }
                        ],
                        npvSettings: { enabled: false, discountRate: 10, showBothValues: true },
                        dragAlong: { enabled: false, commonThreshold: 50, preferredThreshold: 50, overrideUsed: false }
                    }
                },
                lateStageWin: {
                    name: 'Late Stage Winner',
                    description: 'See how founders can still win big even with multiple funding rounds and participating preferred when exits are large enough.',
                    rounds: [
                        { name: 'Founders', type: 'founders', investment: 0, shares: 6000000, liquidationPref: 0, participating: true, isCommon: true, removable: false, icon: '👥', splitRatio: 1 },
                        { name: 'Seed Round', type: 'seed', investment: 2000000, shares: 1500000, valuation: 8000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: '🌱', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2021-03-01' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series A', type: 'seriesA', investment: 10000000, shares: 2000000, valuation: 40000000, liquidationPref: 1, participating: false, antiDilution: 'weightedAverage', antiDilutionBase: 'broad', removable: true, icon: 'A', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2022-05-20' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series B', type: 'seriesB', investment: 20000000, shares: 1750000, valuation: 100000000, liquidationPref: 1, participating: true, antiDilution: 'weightedAverage', antiDilutionBase: 'broad', removable: true, icon: 'B', seniority: 2, participationCap: 0, dividend: { enabled: true, ratePct: 8, issuedOn: '2023-06-15' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series C', type: 'seriesC', investment: 40000000, shares: 1250000, valuation: 300000000, liquidationPref: 1, participating: true, antiDilution: 'weightedAverage', antiDilutionBase: 'broad', removable: true, icon: 'C', seniority: 2, participationCap: 0, dividend: { enabled: true, ratePct: 8, issuedOn: '2024-08-20' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: true, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 }
                    ],
                    safes: [],
                    exitDetails: {
                        grossValue: 600000000, debt: 5000000, legalFees: 1500000, advisorFeePercent: 2, otherExpenses: 2000000, exitDate: '2026-07-01', 
                        managementCarveout: { enabled: true, percent: 5 }, 
                        mip: { enabled: true, percent: 10 }, 
                        escrowDetails: { allocationMethod: 'proRata' },
                        payments: [
                            { name: 'Closing Payment', date: '2026-07-01', percent: 90, isImmediate: true },
                            { name: 'Escrow Release', date: '2027-07-01', percent: 10, isImmediate: false }
                        ],
                        npvSettings: { enabled: false, discountRate: 10, showBothValues: true },
                        dragAlong: { enabled: false, commonThreshold: 50, preferredThreshold: 50, overrideUsed: false }
                    }
                },
                distressedSale: {
                    name: 'Distressed Sale',
                    description: 'Observe how liquidation preferences protect investors when exit values are below total raised capital.',
                    rounds: [
                        { name: 'Founders', type: 'founders', investment: 0, shares: 7000000, liquidationPref: 0, participating: true, isCommon: true, removable: false, icon: '👥', splitRatio: 1 },
                        { name: 'Seed Round', type: 'seed', investment: 3000000, shares: 2000000, valuation: 12000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: '🌱', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2022-02-10' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series A', type: 'seriesA', investment: 12000000, shares: 3000000, valuation: 48000000, liquidationPref: 1, participating: false, antiDilution: 'weightedAverage', antiDilutionBase: 'broad', removable: true, icon: 'A', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2023-04-05' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series B', type: 'seriesB', investment: 25000000, shares: 3500000, valuation: 125000000, liquidationPref: 1, participating: true, antiDilution: 'weightedAverage', antiDilutionBase: 'broad', removable: true, icon: 'B', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2024-06-18' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 }
                    ],
                    safes: [],
                    exitDetails: {
                        grossValue: 30000000, debt: 2000000, legalFees: 500000, advisorFeePercent: 2, otherExpenses: 300000, exitDate: '2025-10-01', 
                        managementCarveout: { enabled: false, percent: 10 }, 
                        mip: { enabled: false, percent: 0 }, 
                        escrowDetails: { allocationMethod: 'proRata' },
                        payments: [
                            { name: 'Closing Payment', date: '2025-10-01', percent: 90, isImmediate: true },
                            { name: 'Escrow Release', date: '2026-10-01', percent: 10, isImmediate: false }
                        ],
                        npvSettings: { enabled: false, discountRate: 10, showBothValues: true },
                        dragAlong: { enabled: true, commonThreshold: 50, preferredThreshold: 50, overrideUsed: false }
                    }
                },
                downRoundImpact: {
                    name: 'Down Round Impact',
                    description: 'See how anti-dilution provisions protect early investors when later rounds are raised at lower valuations.',
                    rounds: [
                        { name: 'Founders', type: 'founders', investment: 0, shares: 8000000, liquidationPref: 0, participating: true, isCommon: true, removable: false, icon: '👥', splitRatio: 1 },
                        { name: 'Seed Round', type: 'seed', investment: 2000000, shares: 1000000, valuation: 18000000, liquidationPref: 1, participating: false, antiDilution: 'weightedAverage', antiDilutionBase: 'broad', removable: true, icon: '🌱', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2022-08-01' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series A', type: 'seriesA', investment: 8000000, shares: 1500000, valuation: 42000000, liquidationPref: 1, participating: false, antiDilution: 'weightedAverage', antiDilutionBase: 'broad', removable: true, icon: 'A', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2023-10-15' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series B', type: 'seriesB', investment: 15000000, shares: 6000000, valuation: 35000000, liquidationPref: 1, participating: true, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: 'B', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2024-12-01' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 }
                    ],
                    safes: [],
                    exitDetails: {
                        grossValue: 45000000, debt: 1000000, legalFees: 300000, advisorFeePercent: 2, otherExpenses: 200000, exitDate: '2026-02-01', 
                        managementCarveout: { enabled: false, percent: 10 }, 
                        mip: { enabled: false, percent: 0 }, 
                        escrowDetails: { allocationMethod: 'proRata' },
                        payments: [
                            { name: 'Closing Payment', date: '2026-02-01', percent: 90, isImmediate: true },
                            { name: 'Escrow Release', date: '2027-02-01', percent: 10, isImmediate: false }
                        ],
                        npvSettings: { enabled: false, discountRate: 10, showBothValues: true },
                        dragAlong: { enabled: false, commonThreshold: 50, preferredThreshold: 50, overrideUsed: false }
                    }
                },
                payToPlayImpact: {
                    name: 'Pay-to-Play Impact',
                    description: 'Demonstrates how a Pay-to-Play provision penalizes a non-participating round, forcing it to convert to common and lose its preference.',
                    rounds: [
                        { name: 'Founders', type: 'founders', investment: 0, shares: 8000000, liquidationPref: 0, participating: true, isCommon: true, removable: false, icon: '👥', splitRatio: 1 },
                        { name: 'Seed Round', type: 'seed', investment: 2000000, shares: 2000000, valuation: 10000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: '🌱', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2022-10-01' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series A', type: 'seriesA', investment: 5000000, shares: 1250000, valuation: 40000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: 'A', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2023-12-01' }, payToPlay: { enabled: true, participated: false }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 }
                    ],
                    safes: [],
                    exitDetails: {
                        grossValue: 10000000, debt: 1000000, legalFees: 250000, advisorFeePercent: 2, otherExpenses: 0, exitDate: '2025-10-31', 
                        managementCarveout: { enabled: false, percent: 10 }, 
                        mip: { enabled: false, percent: 0 }, 
                        escrowDetails: { allocationMethod: 'proRata' },
                        payments: [
                            { name: 'Closing Payment', date: '2025-10-31', percent: 90, isImmediate: true },
                            { name: 'Escrow Release', date: '2026-10-31', percent: 10, isImmediate: false }
                        ],
                        npvSettings: { enabled: false, discountRate: 10, showBothValues: true },
                        dragAlong: { enabled: false, commonThreshold: 50, preferredThreshold: 50, overrideUsed: false }
                    }
                },
                redemptionRightsTriggered: {
                    name: 'Redemption Rights Triggered',
                    description: 'Shows how redemption rights can force a minimum return for an investor in a low-exit scenario, taking proceeds from more junior stakeholders.',
                    rounds: [
                        { name: 'Founders', type: 'founders', investment: 0, shares: 7000000, liquidationPref: 0, participating: true, isCommon: true, removable: false, icon: '👥', splitRatio: 1 },
                        { name: 'Seed Round', type: 'seed', investment: 2000000, shares: 2000000, valuation: 10000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: '🌱', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2022-01-01' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 1 },
                        { name: 'Series A', type: 'seriesA', investment: 8000000, shares: 1000000, valuation: 48000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: 'A', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2023-06-01' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: true, startISO: '2025-06-01', multiple: 2 }, splitRatio: 1 }
                    ],
                    safes: [],
                    exitDetails: {
                        grossValue: 15000000, debt: 1000000, legalFees: 500000, advisorFeePercent: 2, otherExpenses: 200000, exitDate: '2025-07-01', 
                        managementCarveout: { enabled: false, percent: 10 }, 
                        mip: { enabled: false, percent: 0 }, 
                        escrowDetails: { allocationMethod: 'proRata' },
                        payments: [
                            { name: 'Closing Payment', date: '2025-07-01', percent: 90, isImmediate: true },
                            { name: 'Escrow Release', date: '2026-07-01', percent: 10, isImmediate: false }
                        ],
                        npvSettings: { enabled: false, discountRate: 10, showBothValues: true },
                        dragAlong: { enabled: false, commonThreshold: 50, preferredThreshold: 50, overrideUsed: false }
                    }
                },
                stockSplitScenario: {
                    name: 'Stock Split Scenario',
                    description: 'Demonstrates how a stock split adjusts the share counts and effective price per share for all rounds, while keeping ownership percentages constant.',
                    rounds: [
                        { name: 'Founders', type: 'founders', investment: 0, shares: 8000000, liquidationPref: 0, participating: true, isCommon: true, removable: false, icon: '👥', splitRatio: 2 },
                        { name: 'Seed Round', type: 'seed', investment: 2000000, shares: 2000000, valuation: 10000000, liquidationPref: 1, participating: false, antiDilution: 'none', antiDilutionBase: 'broad', removable: true, icon: '🌱', seniority: 2, participationCap: 0, dividend: { enabled: false, ratePct: 8, issuedOn: '2023-01-01' }, payToPlay: { enabled: false, participated: true }, warrant: { enabled: false, coveragePct: 10, strike: 0.01 }, prefInterest: { enabled: false, ratePct: 5 }, redemption: { enabled: false, startISO: '', multiple: 1 }, splitRatio: 2 }
                    ],
                    safes: [],
                    exitDetails: {
                        grossValue: 50000000, debt: 1000000, legalFees: 200000, advisorFeePercent: 2, otherExpenses: 100000, exitDate: '2025-09-01', 
                        managementCarveout: { enabled: false, percent: 10 }, 
                        mip: { enabled: false, percent: 0 }, 
                        escrowDetails: { allocationMethod: 'proRata' },
                        payments: [
                            { name: 'Closing Payment', date: '2025-09-01', percent: 90, isImmediate: true },
                            { name: 'Escrow Release', date: '2026-09-01', percent: 10, isImmediate: false }
                        ],
                        npvSettings: { enabled: false, discountRate: 10, showBothValues: true },
                        dragAlong: { enabled: false, commonThreshold: 50, preferredThreshold: 50, overrideUsed: false }
                    }
                }
            },
            
            renderMobileNav() {
                const currentRoute = window.location.hash || '#/';
                return `
                    <nav class="mobile-nav">
                        <a href="#/" class="mobile-nav-link ${currentRoute === '#/' ? 'active' : ''}" data-route="#/">
                            <span class="icon">📊</span><span class="label">Calc</span>
                        </a>
                        <a href="#/results" class="mobile-nav-link ${currentRoute === '#/results' ? 'active' : ''}" data-route="#/results">
                            <span class="icon">📈</span><span class="label">Results</span>
                        </a>
                        <a href="#/sensitivity" class="mobile-nav-link ${currentRoute === '#/sensitivity' ? 'active' : ''}" data-route="#/sensitivity">
                            <span class="icon">🎯</span><span class="label">Sens</span>
                        </a>
                        <a href="#/learn" class="mobile-nav-link ${currentRoute === '#/learn' ? 'active' : ''}" data-route="#/learn">
                            <span class="icon">📚</span><span class="label">Learn</span>
                        </a>
                        <a href="#/about" class="mobile-nav-link ${currentRoute === '#/about' ? 'active' : ''}" data-route="#/about">
                            <span class="icon">ℹ️</span><span class="label">About</span>
                        </a>
                    </nav>
                `;
            },

            // Templates
            templates: {
                renderInput() {
                    const availableRounds = WaterfallCalculator.fundingSequence.order.filter(type => 
                        WaterfallCalculator.fundingSequence.canAdd(type)
                    );
                    const totalShares = WaterfallCalculator.getTotalShares();
                    const hasErrors = Object.keys(WaterfallCalculator.state.errors).length > 0;
                    
                    return `
                        <div class="header">
                            <h1>🚀 VC <span class="tooltip multiline" data-tooltip="Sequential order of who gets paid at exit">Waterfall</span> Calculator</h1>
                            <p>Understand how venture capital distributions work at exit</p>
                        </div>

                        ${this.renderScenarioBadgeForCalculator()}

                        <div class="nav">
                            <a href="#/" class="nav-link active" data-route="#/">
                                📊 Calculator
                            </a>
                            <a href="#/results" class="nav-link" data-route="#/results">
                                📈 Results
                            </a>
                            <a href="#/sensitivity" class="nav-link" data-route="#/sensitivity">
                                🎯 Sensitivity
                            </a>
                            <a href="#/learn" class="nav-link" data-route="#/learn">
                                📚 Learn
                            </a>
                            <a href="#/about" class="nav-link" data-route="#/about">ℹ️ About</a>
                        </div>

                        <div class="main-content">
                            ${this.renderValidationSummary()}

                            <div class="card" id="card-examples" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 1px solid #0066cc33;">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title" style="color: var(--primary);">
                                        🎓 Learning Examples
                                    </h2>
                                    <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content" style="padding-top: 0.5rem;">
                                    <div class="input-group" style="margin-bottom: 0.5rem;">
                                        <label class="input-label" style="color: var(--primary); font-weight: 600;">
                                            Load Example Scenario
                                        </label>
                                        <select class="input-field" id="exampleScenarioSelect" style="background: white; border: 2px solid var(--primary-light);">
                                            <option value="">-- Select an Example --</option>
                                            <option value="earlySeed" ${this.exampleScenarios.currentScenario === 'earlySeed' ? 'selected' : ''}>Early Stage Success: Seed + SAFE</option>
                                            <option value="seriesAGrowth" ${this.exampleScenarios.currentScenario === 'seriesAGrowth' ? 'selected' : ''}>Series A Growth: Balanced Returns</option>
                                            <option value="lateStageWin" ${this.exampleScenarios.currentScenario === 'lateStageWin' ? 'selected' : ''}>Late Stage Winner: Multi-Round Success</option>
                                            <option value="distressedSale" ${this.exampleScenarios.currentScenario === 'distressedSale' ? 'selected' : ''}>Distressed Sale: Below Raised Capital</option>
                                            <option value="downRoundImpact" ${this.exampleScenarios.currentScenario === 'downRoundImpact' ? 'selected' : ''}>Down Round Impact: Anti-Dilution in Action</option>
                                            <option value="payToPlayImpact" ${this.exampleScenarios.currentScenario === 'payToPlayImpact' ? 'selected' : ''}>Pay-to-Play Impact: Provision Triggered</option>
                                            <option value="redemptionRightsTriggered" ${this.exampleScenarios.currentScenario === 'redemptionRightsTriggered' ? 'selected' : ''}>Redemption Rights Triggered</option>
                                            <option value="stockSplitScenario" ${this.exampleScenarios.currentScenario === 'stockSplitScenario' ? 'selected' : ''}>Stock Split Scenario</option>
                                        </select>
                                    </div>
                                    <div id="scenarioDescription" style="display: none; padding: 0.75rem; background: white; border-radius: 6px; border-left: 3px solid var(--primary); margin-top: 0.5rem;">
                                        <p style="margin: 0; color: var(--gray-dark); font-size: 0.9rem;"></p>
                                    </div>
                                    <p style="font-size: 0.85rem; color: var(--gray); margin: 0.5rem 0 0 0;">
                                        ${WaterfallCalculator.state.rounds.length > 1 || WaterfallCalculator.state.safes.length > 0 ? 
                                            '⚠️ Loading an example will replace your current data' : 
                                            '💡 Try an example to see how waterfall distributions work'}
                                    </p>
                                </div>
                            </div>

                            ${WaterfallCalculator.renderFundingTimeline()}

                            ${WaterfallCalculator.renderExitDetails()}
                            
                            ${WaterfallCalculator.renderPaymentSchedule()}

                            ${WaterfallCalculator.renderDilutionImpact()}

                            <div class="card" id="card-funding-rounds">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">📈 Funding Rounds</h2>
                                    <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    ${availableRounds.length > 0 ? `
                                        <div class="header-buttons" style="margin-top: 1rem;">
                                            ${availableRounds.map(type => `
                                                <button class="btn btn-primary btn-sm" 
                                                        data-action="addRound" 
                                                        data-round-type="${type}">
                                                    + ${WaterfallCalculator.fundingSequence.roundDefaults[type].name}
                                                </button>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <span class="text-muted">All available rounds added</span>
                                    `}
                                
                                    ${WaterfallCalculator.state.rounds.length === 0 ? `
                                        <div class="empty-state">
                                            <div class="empty-state-icon">💰</div>
                                            <div class="empty-state-title">No funding rounds yet</div>
                                            <p>Start by adding founder equity to begin your cap table</p>
                                            <button class="btn btn-primary mt-2" 
                                                    data-action="addRound" 
                                                    data-round-type="founders">
                                                Add Founders Equity
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="rounds-list">
                                            ${WaterfallCalculator.state.rounds.map((round, index) => 
                                                WaterfallCalculator.renderRoundCard(round, index, totalShares)
                                            ).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button class="btn btn-primary" 
                                        data-action="calculate" 
                                        ${hasErrors || WaterfallCalculator.state.rounds.length === 0 ? 'disabled' : ''}>
                                    Calculate Distribution →
                                </button>
                            </div>
                        </div>
                    `;
                },

                renderResults() {
                    if (!WaterfallCalculator.state.results) {
                        return `
                            <div class="header">
                                <h1>📈 Distribution Results</h1>
                                <p>View your <span class="tooltip" data-tooltip="Sequential order of who gets paid at exit">waterfall</span> distribution analysis</p>
                            </div>
                            <div class="nav">
                                <a href="#/" class="nav-link" data-route="#/">📊 Calculator</a>
                                <a href="#/results" class="nav-link active" data-route="#/results">📈 Results</a>
                                <a href="#/sensitivity" class="nav-link" data-route="#/sensitivity">🎯 Sensitivity</a>
                                <a href="#/learn" class="nav-link" data-route="#/learn">📚 Learn</a>
                            </div>
                            <div class="main-content">
                                <div class="empty-state">
                                    <div class="empty-state-icon">📊</div>
                                    <div class="empty-state-title">No results yet</div>
                                    <p>Run a calculation first to see distribution results</p>
                                    <a href="#/" class="btn btn-primary mt-2">
                                        Go to Calculator
                                    </a>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="header">
                            <h1>📈 Distribution Results</h1>
                            ${this.renderScenarioBadge()}
                            <p><span class="tooltip" data-tooltip="Sequential order of who gets paid at exit">Waterfall</span> distribution analysis for a $${this.formatValue(this.state.results.grossExit)} exit</p>
                        </div>
                        <div class="nav">
                            <a href="#/" class="nav-link" data-route="#/">📊 Calculator</a>
                            <a href="#/results" class="nav-link active" data-route="#/results">📈 Results</a>
                            <a href="#/sensitivity" class="nav-link" data-route="#/sensitivity">🎯 Sensitivity</a>
                            <a href="#/learn" class="nav-link" data-route="#/learn">📚 Learn</a>
                            <a href="#/about" class="nav-link" data-route="#/about">ℹ️ About</a>
                        </div>
                        <div class="main-content">
                            ${this.state.results.dragAlongOverride ? `
                                <div class="warning-box">
                                    <strong>⚠️ Drag-Along Rights Invoked:</strong> The sale proceeded because drag-along rights were enabled, compelling minority shareholders despite consent thresholds not being met.
                                    <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                                        <li>Common Consent: <strong>${this.state.results.consentDetails.commonVotes}%</strong> (Threshold: ${this.state.results.exitDetails.dragAlong.commonThreshold}%)</li>
                                        <li>Preferred Consent: <strong>${this.state.results.consentDetails.preferredVotes}%</strong> (Threshold: ${this.state.results.exitDetails.dragAlong.preferredThreshold}%)</li>
                                    </ul>
                                </div>
                            ` : ''}
                            ${this.state.results.redemptionNotice ? `
                                <div class="warning-box" style="border-left-color: var(--danger); background: #fff1f0; border-color: #ffa39e;">
                                    <strong style="color: var(--danger);">Redemption Rights Triggered:</strong> One or more investor classes chose to redeem their shares at a fixed price, overriding the standard waterfall for their tranche.
                                </div>
                            ` : ''}
                            ${WaterfallCalculator.renderResultsSummary()}
                            <div class="card" id="card-calc-details">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">Calculation Details</h2>
                                     <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    ${WaterfallCalculator.renderCalculationDetails()}
                                </div>
                            </div>
                            <div class="tabs">
                                <button class="tab-button active" data-tab="table">📋 Table View</button>
                                <button class="tab-button" data-tab="charts">📊 Charts</button>
                                <button class="tab-button" data-tab="breakdown">💰 Breakdown</button>
                                <button class="tab-button" data-tab="ledger">📋 Ledger</button>
                            </div>
                            <div id="table-tab" class="tab-content active">
                                ${WaterfallCalculator.renderCapTable()}
                            </div>
                            <div id="charts-tab" class="tab-content">
                                <div class="card" id="card-chart-waterfall">
                                     <div class="card-header" data-collapsible="true">
                                        <h2 class="card-title">📊 <span class="tooltip" data-tooltip="Sequential order of who gets paid at exit">Waterfall</span> Distribution Chart</h2>
                                        <span class="collapse-icon"></span>
                                    </div>
                                    <div class="card-content">
                                        <div class="chart-container">
                                            <canvas id="waterfallChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-grid">
                                    <div class="card" id="card-chart-pie">
                                        <div class="card-header" data-collapsible="true">
                                            <h3 class="card-title">🥧 Distribution Pie Chart</h3>
                                            <span class="collapse-icon"></span>
                                        </div>
                                        <div class="card-content">
                                            <div class="chart-container">
                                                <canvas id="pieChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card" id="card-chart-dilution">
                                        <div class="card-header" data-collapsible="true">
                                            <h3 class="card-title">📉 Ownership Dilution</h3>
                                             <span class="collapse-icon"></span>
                                        </div>
                                        <div class="card-content">
                                            <div class="chart-container">
                                                ${WaterfallCalculator.state.results.safes && WaterfallCalculator.state.results.safes.length > 0 ? `
                                                    <canvas id="dilutionChart"></canvas>
                                                ` : `
                                                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--gray);">
                                                        <div class="text-center">
                                                            <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                                                            <p>No <span class="tooltip" data-tooltip="Converts to equity at exit or next funding round">SAFE</span> notes to show dilution impact</p>
                                                            <p class="text-muted">Add <span class="tooltip" data-tooltip="Converts to equity at exit or next funding round">SAFE</span> notes to see ownership dilution</p>
                                                        </div>
                                                    </div>
                                                `}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="breakdown-tab" class="tab-content">
                                ${WaterfallCalculator.renderWaterfallFlow()}
                                ${WaterfallCalculator.renderExpenseBreakdown()}
                            </div>
                            <div id="ledger-tab" class="tab-content">
                                ${WaterfallCalculator.renderValidationLedger()}
                            </div>
                            <div class="text-center mt-3">
                                <a href="#/" class="btn btn-secondary">← Back to Calculator</a>
                            </div>
                        </div>
                    `;
                },

                renderSensitivity() {
                    if (!WaterfallCalculator.state.rounds || WaterfallCalculator.state.rounds.length === 0) {
                        return `
                            <div class="header">
                                <h1>🎯 Sensitivity Analysis</h1>
                                <p>Analyze returns across different exit scenarios</p>
                            </div>
                            <div class="nav">
                                <a href="#/" class="nav-link" data-route="#/">📊 Calculator</a>
                                <a href="#/results" class="nav-link" data-route="#/results">📈 Results</a>
                                <a href="#/sensitivity" class="nav-link active" data-route="#/sensitivity">🎯 Sensitivity</a>
                                <a href="#/learn" class="nav-link" data-route="#/learn">📚 Learn</a>
                            </div>
                            <div class="main-content">
                                <div class="empty-state">
                                    <div class="empty-state-icon">🎯</div>
                                    <div class="empty-state-title">No cap table configured</div>
                                    <p>Set up your funding rounds first to run sensitivity analysis</p>
                                    <a href="#/" class="btn btn-primary mt-2">Go to Calculator</a>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (this.state.sensitivity.maxExit === 0) {
                        const sourceRounds = this.state.results ? this.state.results.originalRounds : this.state.rounds;
                        const sourceSafes = this.state.results ? this.state.results.safes : this.state.safes;
                        const totalRaised = this.safeSum(sourceRounds.map(r => r.investment)) + this.safeSum(sourceSafes.map(s => s.amount));
                        
                        this.state.sensitivity.minExit = totalRaised > 0 ? totalRaised * 0.5 : 1000000;
                        this.state.sensitivity.maxExit = totalRaised > 0 ? totalRaised * 10 : 100000000;
                    }
                    
                    const { minExit, maxExit, stepCount } = this.state.sensitivity;
                    const stepSize = stepCount > 1 ? (maxExit - minExit) / (stepCount - 1) : 0;
                    const scenarios = WaterfallCalculator.sensitivity.calculateScenarios(minExit, maxExit, stepSize);
                    const insights = WaterfallCalculator.sensitivity.generateInsights(scenarios);

                    return `
                        <div class="header">
                            <h1>🎯 Sensitivity Analysis</h1>
                             ${this.renderScenarioBadge()}
                            <p>Analyze returns across different exit scenarios</p>
                        </div>
                        <div class="nav">
                           <a href="#/" class="nav-link" data-route="#/">📊 Calculator</a>
                           <a href="#/results" class="nav-link" data-route="#/results">📈 Results</a>
                           <a href="#/sensitivity" class="nav-link active" data-route="#/sensitivity">🎯 Sensitivity</a>
                           <a href="#/learn" class="nav-link" data-route="#/learn">📚 Learn</a>
                           <a href="#/about" class="nav-link" data-route="#/about">ℹ️ About</a>
                        </div>
                        <div class="main-content">
                            <!-- Dynamic Range Controls -->
                            ${WaterfallCalculator.sensitivity.renderControls()}
                            
                             <!-- Interactive Chart -->
                            <div class="card" id="card-sensitivity-chart">
                                <div class="card-header">
                                    <h2 class="card-title">📈 Distribution Trends</h2>
                                    <div class="header-buttons">
                                        <button class="btn btn-secondary btn-sm" data-action="downloadSensitivityChart">Download Chart (PNG)</button>
                                        <button class="btn btn-secondary btn-sm" data-action="exportSensitivityCSV">Export Data (CSV)</button>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="chart-container">
                                        <canvas id="sensitivityChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card" id="card-sensitivity-insights">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">💡 Key Insights</h2>
                                     <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    <div class="grid grid-2">
                                        ${insights.map(insight => `
                                            <div style="padding: 0.75rem; background: var(--light); border-radius: var(--border-radius);">
                                                <strong style="color: var(--primary);">${insight.label}</strong>
                                                <div style="font-size: 1.2rem; margin-top: 0.25rem;">$${WaterfallCalculator.formatValue(Math.round(insight.value))}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="card" id="card-sensitivity-table">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">📊 Scenario Analysis</h2>
                                     <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    ${WaterfallCalculator.sensitivity.renderTable(scenarios)}
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <a href="#/" class="btn btn-secondary">← Back to Calculator</a>
                            </div>
                        </div>
                    `;
                },

                renderLearn() {
                    return `
                        <div class="header">
                            <h1>📚 Learn About VC Waterfalls</h1>
                            <p>Complete guide to understanding venture capital distributions</p>
                        </div>

                        <div class="nav">
                            <a href="#/" class="nav-link" data-route="#/">📊 Calculator</a>
                            <a href="#/results" class="nav-link" data-route="#/results">📈 Results</a>
                            <a href="#/sensitivity" class="nav-link" data-route="#/sensitivity">🎯 Sensitivity</a>
                            <a href="#/learn" class="nav-link active" data-route="#/learn">📚 Learn</a>
                            <a href="#/about" class="nav-link" data-route="#/about">ℹ️ About</a>
                        </div>

                        <div class="main-content">
                            <div class="card" id="card-learn-1">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">💧 Understanding the Waterfall</h2>
                                    <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    <p>
                                        A waterfall distribution determines how proceeds from a liquidity event (like an acquisition or IPO) 
                                        are distributed among stakeholders in a specific order of priority. Think of it like water flowing 
                                        down a series of pools - each pool must be filled before water flows to the next level.
                                    </p>
                                    <h3 style="margin-top: 1.5rem; color: var(--primary);">Visual Flow Diagram</h3>
                                    <div class="waterfall-diagram">
┌─────────────────────────────┐
│    GROSS EXIT VALUE         │ 
│      $100,000,000           │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  1️⃣ DEBT & EXPENSES = $8M   │ ◄── First Priority
│    - Outstanding Debt       │
│    - Legal Fees             │
│    - Advisor Fees (%)       │
└──────────┬──────────────────┘
           │ Remaining: $92M
           ▼
┌─────────────────────────────┐
│  2️⃣ MANAGEMENT CARVE-OUT    │ ◄── If Enabled (from Net)
│    10% of remaining         │
│    = $9,200,000             │
└──────────┬──────────────────┘
           │ Remaining: $82.8M
           ▼
┌─────────────────────────────┐
│  3️⃣ LIQUIDATION PREFERENCES │ ◄── Preferred Shareholders
│    Series C: 1x = $20M      │     (In order of seniority)
│    Series B: 1x = $15M      │
│    Series A: 1x = $10M      │
│    Seed: 1x = $2M           │
│    + Accrued Dividends      │
└──────────┬──────────────────┘
           │ Remaining: $35.8M
           ▼
┌─────────────────────────────┐
│  4️⃣ MGMT INCENTIVE PLAN (MIP) │ ◄── If Enabled (from Participation Pool)
│    10% of remaining         │
│    = $3.58M                 │
└──────────┬──────────────────┘
           │ Remaining: $32.22M
           ▼
┌─────────────────────────────┐
│  5️⃣ PARTICIPATION/COMMON    │ ◄── Pro-Rata Distribution
│    - Participating Pref     │
│    - Common Stock           │
│    - Converted SAFEs        │
└─────────────────────────────┘</div>
                                    <div style="margin-top: 1rem; padding: 1rem; background: var(--primary-light); border-radius: var(--border-radius);">
                                        <strong>Key Principle:</strong> Money flows from top to bottom. Each tier must be satisfied before 
                                        the next tier receives anything. This protects investors with higher priority (like debt holders 
                                        and preferred shareholders).
                                    </div>
                                </div>
                            </div>
                            <div class="card" id="card-learn-2">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">📖 Key Terms Explained</h2>
                                    <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    <div class="term-box">
                                        <h4>🔄 SAFE (Simple Agreement for Future Equity)</h4>
                                        <p><strong>Definition:</strong> A financing contract that converts to equity at a future trigger event (like an exit or next funding round).</p>
                                        <p><strong>Example:</strong> An investor puts in $500K with a $5M valuation cap. At exit valued at $100M with 10M shares outstanding, they convert at the cap price ($5M ÷ 10M = $0.50/share), getting 1M shares.</p>
                                        <p><strong>Key Features:</strong></p>
                                        <ul style="margin-left: 1.5rem;">
                                            <li>No interest or maturity date</li>
                                            <li>Converts at the lower of cap or discount price</li>
                                            <li>Dilutes existing shareholders at conversion</li>
                                        </ul>
                                    </div>
                                    <div class="term-box">
                                        <h4>💎 Liquidation Preference</h4>
                                        <p><strong>Definition:</strong> The amount an investor gets back before common shareholders receive anything.</p>
                                        <p><strong>Example:</strong> Series A invested $10M with 1.5x preference. They get $15M back first, before any common distributions.</p>
                                        <p><strong>Multiples:</strong></p>
                                        <ul style="margin-left: 1.5rem;">
                                            <li><strong>1x:</strong> Return original investment</li>
                                            <li><strong>1.5x:</strong> Return 150% of investment</li>
                                            <li><strong>2x:</strong> Return double the investment</li>
                                        </ul>
                                    </div>
                                     <div class="term-box">
                                        <h4>💰 Cumulative Dividends</h4>
                                        <p><strong>Definition:</strong> A guaranteed annual return (e.g., 8%) on an investment that accrues over time and is paid out at exit. It adds to the liquidation preference.</p>
                                        <p><strong>Example:</strong> A $10M investment with an 8% cumulative dividend held for 3 years accrues $2.4M ($10M * 8% * 3). The total preference becomes $12.4M.</p>
                                        <p><strong>Impact:</strong> Increases the total amount returned to investors before common shareholders receive proceeds.</p>
                                    </div>
                                    <div class="term-box">
                                        <h4>✋ Pay-to-Play Provision</h4>
                                        <p><strong>Definition:</strong> A term that penalizes existing investors if they do not participate in a subsequent, qualified financing round (especially a down round).</p>
                                        <p><strong>Purpose:</strong> To ensure investors continue to support the company financially when new capital is needed.</p>
                                        <p><strong>Common Penalties:</strong></p>
                                        <ul style="margin-left: 1.5rem;">
                                            <li><strong>Forced Conversion:</strong> Preferred stock is converted to common stock, losing its liquidation preference.</li>
                                            <li><strong>Loss of Anti-Dilution:</strong> The investor loses their anti-dilution protection against future down rounds.</li>
                                        </ul>
                                    </div>
                                    <div class="term-box">
                                        <h4>🎯 Participating Preferred</h4>
                                        <p><strong>Definition:</strong> Investors who receive their preference AND participate in remaining distributions.</p>
                                        <p><strong>Example:</strong> Series B has $25M investment with 1x participating preferred and 20% ownership. They get:
                                            <br>1) Their $25M preference back first
                                            <br>2) PLUS 20% of whatever remains</p>
                                        <p><strong>Impact:</strong> This "double dip" significantly enhances returns for later-stage investors.</p>
                                    </div>
                                    <div class="term-box">
                                        <h4>📊 MOIC (Multiple on Invested Capital)</h4>
                                        <p><strong>Definition:</strong> Total return divided by the amount invested.</p>
                                        <p><strong>Calculation:</strong> MOIC = Total Proceeds ÷ Investment</p>
                                        <p><strong>Examples:</strong></p>
                                        <ul style="margin-left: 1.5rem;">
                                            <li>0.5x = Lost half the investment</li>
                                            <li>1x = Broke even</li>
                                            <li>3x = Tripled the investment</li>
                                            <li>10x = "Home run" return</li>
                                        </ul>
                                    </div>
                                    <div class="term-box">
                                        <h4>🏆 Management Carve-out</h4>
                                        <p><strong>Definition:</strong> A percentage of proceeds set aside for management/employees, paid before investor distributions.</p>
                                        <p><strong>Example:</strong> 10% carve-out on $90M net proceeds = $9M to management pool.</p>
                                        <p><strong>Purpose:</strong> Incentivizes management in acquisition scenarios where their equity might be worthless.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card" id="card-learn-3">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">⚖️ Participating vs Non-Participating Preferred</h2>
                                    <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    <div class="table-scroll-wrapper">
                                        <table class="comparison-table">
                                            <thead>
                                                <tr>
                                                    <th>Aspect</th>
                                                    <th>Non-Participating</th>
                                                    <th>Participating</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><strong>Choice</strong></td>
                                                    <td>Must choose: preference OR common</td>
                                                    <td>Gets both: preference AND common</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Best for investor when</strong></td>
                                                    <td>Exit is very high (>10x)</td>
                                                    <td>Always beneficial</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Impact on founders</strong></td>
                                                    <td>Better for founders</td>
                                                    <td>Worse for founders</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Example</strong></td>
                                                    <td>$10M investment, 20% ownership:<br>
                                                        Exit at $30M: Takes $10M pref<br>
                                                        Exit at $100M: Takes $20M common</td>
                                                    <td>$10M investment, 20% ownership:<br>
                                                        Exit at $30M: $10M + $4M = $14M<br>
                                                        Exit at $100M: $10M + $18M = $28M</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Typical use</strong></td>
                                                    <td>Early stage (Seed, Series A)</td>
                                                    <td>Later stage (Series B+)</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="card" id="card-learn-4">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">🎭 Common Exit Scenarios</h2>
                                    <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Scenario Outcomes Table</h3>
                                    <div class="table-scroll-wrapper">
                                        <table class="comparison-table">
                                            <thead>
                                                <tr>
                                                    <th>Exit Value</th>
                                                    <th>Type</th>
                                                    <th>Who Gets Paid</th>
                                                    <th>Key Dynamic</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><strong>&lt; Total Debt</strong></td>
                                                    <td style="color: var(--danger);">Distressed</td>
                                                    <td>Debt holders only (partial)</td>
                                                    <td>Everyone loses</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>= Total Raised</strong></td>
                                                    <td style="color: var(--warning);">Break-even</td>
                                                    <td>Preferred shareholders only</td>
                                                    <td>Founders get $0</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>2-3x Raised</strong></td>
                                                    <td style="color: var(--primary);">Modest</td>
                                                    <td>Preferred + some common</td>
                                                    <td>Founders see small returns</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>5-10x Raised</strong></td>
                                                    <td style="color: var(--success);">Success</td>
                                                    <td>Everyone participates</td>
                                                    <td>Non-participating may convert</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>>10x Raised</strong></td>
                                                    <td style="color: var(--success);"><strong>Home Run</strong></td>
                                                    <td>Common dominates</td>
                                                    <td>Preferences less relevant</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--light); border-radius: var(--border-radius);">
                                        <h4 style="color: var(--primary);">Real-World Example: $100M Exit</h4>
                                        <p><strong>Setup:</strong> Founders (60%), Seed $2M (15%), Series A $10M (25% participating)</p>
                                        <p><strong>After $7.5M expenses:</strong> $92.5M to distribute</p>
                                        <ol style="margin-left: 1.5rem;">
                                            <li>Series A preference: $10M</li>
                                            <li>Seed preference: $2M</li>
                                            <li>Remaining $80.5M split by ownership:
                                                <ul>
                                                    <li>Founders (60%): $48.3M</li>
                                                    <li>Series A (25%): $20.1M (plus their $10M = $30.1M total)</li>
                                                    <li>Seed (15%): $12.1M (plus their $2M = $14.1M total)</li>
                                                </ul>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div class="card" id="card-learn-5">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">🧮 SAFE Conversion Math - Step by Step</h2>
                                    <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    <h3 style="color: var(--primary);">Example: $500K SAFE Converting at Exit</h3>
                                    <div class="example-calc">
                                        <p><strong>Given:</strong></p>
                                        <ul style="list-style: none;">
                                            <li>• SAFE Investment: $500,000</li>
                                            <li>• Valuation Cap: $5,000,000</li>
                                            <li>• Discount: 20%</li>
                                            <li>• Exit Value: $50,000,000</li>
                                            <li>• Pre-SAFE Shares: 10,000,000</li>
                                        </ul>
                                    </div>
                                    <div style="margin-top: 1rem;">
                                        <div style="margin-bottom: 1.5rem;">
                                            <span class="step-number">1</span>
                                            <strong>Calculate Cap Price</strong>
                                            <div class="example-calc" style="margin-top: 0.5rem;">
                                                Cap Price = Valuation Cap ÷ Pre-Money Shares<br>
                                                Cap Price = $5,000,000 ÷ 10,000,000<br>
                                                <strong>Cap Price = $0.50 per share</strong>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1.5rem;">
                                            <span class="step-number">2</span>
                                            <strong>Calculate Discount Price</strong>
                                            <div class="example-calc" style="margin-top: 0.5rem;">
                                                Exit Price = Exit Value ÷ Pre-Money Shares<br>
                                                Exit Price = $50,000,000 ÷ 10,000,000 = $5.00<br>
                                                Discount Price = $5.00 × (1 - 0.20)<br>
                                                <strong>Discount Price = $4.00 per share</strong>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1.5rem;">
                                            <span class="step-number">3</span>
                                            <strong>Choose Lower Price (Better for SAFE Holder)</strong>
                                            <div class="example-calc" style="margin-top: 0.5rem;">
                                                Cap Price: $0.50 ✅ (Lower is better)<br>
                                                Discount Price: $4.00<br>
                                                <strong>Conversion Price = $0.50</strong>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1.5rem;">
                                            <span class="step-number">4</span>
                                            <strong>Calculate Shares Received</strong>
                                            <div class="example-calc" style="margin-top: 0.5rem;">
                                                Shares = Investment ÷ Conversion Price<br>
                                                Shares = $500,000 ÷ $0.50<br>
                                                <strong>SAFE receives 1,000,000 shares</strong>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1.5rem;">
                                            <span class="step-number">5</span>
                                            <strong>Calculate Ownership & Dilution</strong>
                                            <div class="example-calc" style="margin-top: 0.5rem;">
                                                Total Shares = 10,000,000 + 1,000,000 = 11,000,000<br>
                                                SAFE Ownership = 1,000,000 ÷ 11,000,000 = <strong>9.09%</strong><br>
                                                <br>
                                                <strong>Dilution Impact:</strong><br>
                                                • Founders: 60% → 54.5% (diluted 9.09%)<br>
                                                • Seed: 20% → 18.2% (diluted 9.09%)<br>
                                                • Series A: 20% → 18.2% (diluted 9.09%)
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--warning); color: var(--white); border-radius: var(--border-radius);">
                                        <strong>💡 Key Insight:</strong> SAFEs can significantly dilute existing shareholders at exit. 
                                        In this example, a $500K SAFE captured 9.09% of the company, diluting all existing shareholders 
                                        proportionally. The valuation cap is critical - a lower cap means more dilution.
                                    </div>
                                </div>
                            </div>
                            <div class="card" id="card-learn-6">
                                <div class="card-header" data-collapsible="true">
                                    <h2 class="card-title">⚡ Quick Reference Guide</h2>
                                    <span class="collapse-icon"></span>
                                </div>
                                <div class="card-content">
                                    <div class="grid grid-2">
                                        <div>
                                            <h4 style="color: var(--primary);">Distribution Order</h4>
                                            <ol style="margin-left: 1.5rem;">
                                                <li>Debt & Expenses</li>
                                                <li>Management Carve-out</li>
                                                <li>Liquidation Preferences (reverse order)</li>
                                                <li>Participation/Common (pro-rata)</li>
                                            </ol>
                                        </div>
                                        <div>
                                            <h4 style="color: var(--primary);">Typical Terms by Stage</h4>
                                            <ul style="margin-left: 1.5rem;">
                                                <li><strong>Seed:</strong> 1x non-participating</li>
                                                <li><strong>Series A:</strong> 1x non-participating</li>
                                                <li><strong>Series B:</strong> 1-1.5x participating</li>
                                                <li><strong>Series C+:</strong> 1.5-2x participating</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 style="color: var(--primary);">Red Flags for Founders</h4>
                                            <ul style="margin-left: 1.5rem;">
                                                <li>Multiple liquidation preference > 1x</li>
                                                <li>Participating preferred in early rounds</li>
                                                <li>Cumulative dividends > 8%</li>
                                                <li>Full-ratchet anti-dilution</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 style="color: var(--primary);">Exit Planning Tips</h4>
                                            <ul style="margin-left: 1.5rem;">
                                                <li>Model multiple exit scenarios</li>
                                                <li>Understand preference stack</li>
                                                <li>Consider management incentives</li>
                                                <li>Account for all expenses</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <a href="#/" class="btn btn-primary">Try the Calculator →</a>
                            </div>
                        </div>
                    `;
                },

                renderAbout() {
                    return `
                        <div class="header">
                            <h1>ℹ️ About VC Waterfall Calculator</h1>
                            <p>Understanding venture capital distributions made simple</p>
                        </div>

                        <div class="nav">
                            <a href="#/" class="nav-link" data-route="#/">📊 Calculator</a>
                            <a href="#/results" class="nav-link" data-route="#/results">📈 Results</a>
                            <a href="#/sensitivity" class="nav-link" data-route="#/sensitivity">🎯 Sensitivity</a>
                            <a href="#/learn" class="nav-link" data-route="#/learn">📚 Learn</a>
                            <a href="#/about" class="nav-link active" data-route="#/about">ℹ️ About</a>
                        </div>

                        <div class="main-content">
                            <!-- Application Info Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">📱 Application Information</h2>
                                </div>
                                <div class="card-content">
                                    <div style="text-align: center; padding: 2rem;">
                                        <h2 style="color: var(--primary); margin-bottom: 0.5rem;">
                                            VC Waterfall Calculator
                                        </h2>
                                        <p style="font-size: 1.5rem; color: var(--gray-dark); margin-bottom: 1rem;">
                                            Version v0.604
                                        </p>
                                        <p style="margin-bottom: 2rem; color: var(--gray);">
                                            A comprehensive tool for modeling venture capital exit distributions,
                                            liquidation preferences, and investor returns.
                                        </p>
                                        
                                        <div style="padding: 1.5rem; background: var(--light); border-radius: var(--border-radius);">
                                            <p style="margin-bottom: 0.5rem;">
                                                <strong>© 2025 Expound Consulting — Ken Cheney & Robert Gibson</strong>
                                            </p>
                                            <p style="color: var(--gray-dark); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                                Code: MIT License • Content: CC BY-SA 4.0
                                            </p>
                                            <p style="color: var(--gray-dark); font-size: 0.9rem;">
                                                This calculator is provided as an educational tool
                                                and should not be considered legal or financial advice.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Book Information Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">📚 Companion Book</h2>
                                </div>
                                <div class="card-content">
                                    <div style="padding: 1.5rem; background: var(--primary-light); border-radius: var(--border-radius);">
                                        <div style="text-align: center;">
                                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">
                                                The Fund Equation: How VCs Really Make Decisions
                                            </h3>
                                            <p style="color: var(--gray-dark); margin-bottom: 1rem; font-style: italic;">
                                                (And How to Use That Knowledge)
                                            </p>
                                            <p style="margin-bottom: 1.5rem;">
                                                This calculator is a companion learning tool to the book,
                                                providing hands-on experience with the concepts covered.
                                            </p>
                                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                                <a href="https://www.amazon.com/Fund-Equation-Really-Decisions-Knowledge-ebook/dp/B0FPMWGP64/"
                                                   target="_blank"
                                                   class="btn btn-primary">
                                                    📖 Get on Amazon
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <p style="margin-top: 1rem; text-align: center; color: var(--gray);">
                                        Available in Kindle and paperback formats
                                    </p>
                                </div>
                            </div>

                            <!-- Open Source Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">🔧 Open Source</h2>
                                </div>
                                <div class="card-content">
                                    <p style="margin-bottom: 1rem;">
                                        This calculator is open source and available on GitHub. 
                                        We welcome contributions, bug reports, and feature requests from the community.
                                    </p>
                                    <div style="text-align: center; padding: 1rem;">
                                        <a href="https://github.com/expound-consulting/Inside-the-VC-Mind"
                                           target="_blank"
                                           class="btn btn-secondary">
                                            <span style="margin-right: 0.5rem;">📂</span> View on GitHub
                                        </a>
                                    </div>
                                    <div style="margin-top: 1rem; padding: 1rem; background: var(--light); border-radius: var(--border-radius);">
                                        <h4 style="margin-bottom: 0.5rem;">Contributing</h4>
                                        <p style="font-size: 0.9rem; color: var(--gray-dark);">
                                            Found a bug? Have a feature idea? Please open an issue on GitHub
                                            or submit a pull request. All contributions are welcome!
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Release Notes Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">📝 Release Notes</h2>
                                </div>
                                <div class="card-content">
                                    <div class="term-box">
                                        <h4>Version v0.604 - September 2025 (Current)</h4>
                                        <p style="margin-bottom: 0.5rem; color: var(--gray);">
                                            Critical mobile responsiveness and calculation engine fixes.
                                        </p>
                                        <ul style="margin-left: 1.5rem;">
                                            <li>📱 **Fix**: Corrected sticky column overlap on horizontal table scrolls.</li>
                                            <li>📱 **Fix**: Prevented accidental tab switching during vertical scroll on Results page.</li>
                                            <li>📱 **Fix**: Ensured waterfall visualization does not overflow on small screens.</li>
                                        </ul>
                                    </div>
                                    <div class="term-box">
                                        <h4>Version v0.603 - September 2025</h4>
                                        <p style="margin-bottom: 0.5rem; color: var(--gray);">
                                            Calculation engine update with net-exercise and split handling improvements.
                                        </p>
                                        <ul style="margin-left: 1.5rem;">
                                            <li>⚙️ **Engine**: Implemented net-exercise for warrants and option pool.</li>
                                            <li>⚙️ **Engine**: Improved stock split handling for consistency.</li>
                                            <li>🐛 **Bugfix**: Corrected redemption rights calculation variable.</li>
                                        </ul>
                                    </div>
                                    <div class="term-box">
                                        <h4>Version 0.6 - September 2025</h4>
                                        <p style="margin-bottom: 0.5rem; color: var(--gray);">
                                            Major update with advanced features and improvements
                                        </p>
                                        <ul style="margin-left: 1.5rem;">
                                            <li>✨ Multiple payment schedules with NPV calculations</li>
                                            <li>💼 Management Incentive Plan (MIP) support</li>
                                            <li>📊 Warrant coverage calculations</li>
                                            <li>💰 Preference interest (PIK) feature</li>
                                            <li>🔄 Redemption rights functionality</li>
                                            <li>🎯 Drag-along rights modeling</li>
                                            <li>📈 Stock split ratio support</li>
                                            <li>🎓 Enhanced example scenarios with auto-calculation</li>
                                            <li>📱 Improved mobile responsiveness</li>
                                            <li>🐛 Fixed calculation edge cases</li>
                                            <li>♿ Accessibility improvements</li>
                                            <li>🚀 Core waterfall calculation engine</li>
                                            <li>📄 SAFE conversion support</li>
                                            <li>🛡️ Anti-dilution provisions</li>
                                            <li>📊 Sensitivity analysis</li>
                                            <li>📚 Educational content</li>
                                            <li>💹 Interactive charts</li>
                                            <li>🎨 Professional UI design</li>
                                            <li>📊 IRR/XIRR calculations per stakeholder</li>
                                            <li>📋 Validation ledger mode</li>
                                        </ul>
                                    </div>
                                    <div class="term-box" style="background: var(--primary-light); border-left-color: var(--primary);">
                                        <h4>Planned Features</h4>
                                        <p style="margin-bottom: 0.5rem; color: var(--gray);">
                                            Coming in future versions
                                        </p>
                                        <ul style="margin-left: 1.5rem;">
                                            <li>💾 Save/load scenarios</li>
                                            <li>📤 Advanced export options</li>
                                            <li>🔐 Authentication and sharing</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer Actions -->
                            <div class="text-center mt-3">
                                <a href="#/" class="btn btn-primary">← Back to Calculator</a>
                            </div>
                        </div>
                    `;
                }
            },

            // Rendering Helpers
            renderValidationSummary() {
                const errors = this.state.errors;
                const errorCount = Object.keys(errors).length;
                if (errorCount === 0) return '';

                return `
                    <div class="validation-summary">
                        <strong style="color: var(--danger);">Please fix ${errorCount} error${errorCount > 1 ? 's' : ''} to continue:</strong>
                        <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                            ${Object.values(errors).map(msg => `<li>${msg}</li>`).join('')}
                        </ul>
                    </div>
                `;
            },
            
            renderField(config) {
                const { 
                    label, 
                    fieldKey, 
                    value, 
                    type = 'text', 
                    placeholder = '', 
                    step = 'any', 
                    disabled = false, 
                    tooltip: providedTooltip = ''
                } = config;
                
                let tooltip = providedTooltip || this.fieldTooltips[fieldKey] || '';
                if (!tooltip) { // Handle dynamic field keys
                    if (fieldKey.endsWith('.splitRatio')) {
                        tooltip = 'Multiplier for share count. 2 = 2-for-1 split (doubles shares). 0.5 = reverse split (halves shares)';
                    } else if (fieldKey.endsWith('.poolDetails.vestedPercent')) {
                        tooltip = 'Vested: earned by employees. Typical: 70-90% vested';
                    } else if (fieldKey.endsWith('.poolDetails.exercisedPercent')) {
                        tooltip = 'Exercised: actually purchased. Typical: 50-80% of vested options exercised';
                    }
                }

                const inputConfig = this.getInputConfig(fieldKey, type);
                const error = this.state.errors[fieldKey];
                const warning = this.state.warnings[fieldKey];
                const isValid = !error && !warning && this.isFieldValid(fieldKey, value);
                
                let cssClass = 'input-field';
                if (error) cssClass += ' is-invalid';
                else if (isValid && value) cssClass += ' is-valid';
                
                const displayValue = this.formatFieldValue(value, fieldKey, inputConfig.type);
                
                return `
                    <div class="input-group">
                        <label class="input-label">
                            ${label}
                            ${tooltip ? `<span class="tooltip" data-tooltip="${tooltip}" style="cursor: help;">ⓘ</span>` : ''}
                        </label>
                        <div class="input-wrapper">
                            <input type="${inputConfig.type}" 
                                   class="${cssClass}" 
                                   data-field="${fieldKey}" 
                                   value="${displayValue}"
                                   placeholder="${placeholder}"
                                   ${inputConfig.min !== undefined ? `min="${inputConfig.min}"` : ''}
                                   ${inputConfig.max !== undefined ? `max="${inputConfig.max}"` : ''}
                                   ${inputConfig.step ? `step="${inputConfig.step}"` : ''}
                                   ${inputConfig.pattern ? `pattern="${inputConfig.pattern}"` : ''}
                                   ${inputConfig.inputmode ? `inputmode="${inputConfig.inputmode}"` : ''}
                                   ${disabled ? 'disabled' : ''}>
                            ${isValid && value ? `
                                <span class="input-valid-icon">✓</span>
                            ` : ''}
                        </div>
                        ${error ? `
                            <div class="error-message">${error}</div>
                        ` : warning ? `
                            <div class="warning-message">${warning}</div>
                        ` : ''}
                    </div>
                `;
            },
            
            getInputConfig(fieldKey, explicitType) {
                if (explicitType === 'date' || fieldKey.includes('date') || fieldKey.includes('Date') || fieldKey.includes('issuedOn') || fieldKey.includes('startISO')) {
                    return { type: 'date' };
                }
                
                if (fieldKey.includes('percent') || fieldKey.includes('Percent') ||
                    fieldKey.includes('rate') || fieldKey.includes('Rate') || 
                    fieldKey.includes('discount') || fieldKey.includes('Threshold')) {
                    return {
                        type: 'number',
                        min: 0,
                        max: 100,
                        step: 0.1,
                        inputmode: 'decimal'
                    };
                }
                
                if (fieldKey.includes('shares')) {
                    return {
                        type: 'number',
                        min: 0,
                        step: 1,
                        inputmode: 'numeric'
                    };
                }
                
                if (fieldKey.includes('value') || fieldKey.includes('Value') ||
                    fieldKey.includes('investment') || fieldKey.includes('amount') ||
                    fieldKey.includes('debt') || fieldKey.includes('fees') ||
                    fieldKey.includes('expenses') || fieldKey.includes('cap') || 
                    fieldKey.includes('Cap')) {
                    return {
                        type: 'text',
                        inputmode: 'decimal',
                        pattern: '[0-9,]*\\.?[0-9]*'
                    };
                }
                
                if (fieldKey.includes('multiple') || fieldKey.includes('Multiple') ||
                    fieldKey.includes('liquidationPref') || fieldKey.includes('splitRatio')) {
                    return {
                        type: 'number',
                        min: 0,
                        max: 10,
                        step: 0.1,
                        inputmode: 'decimal'
                    };
                }
                
                if (fieldKey.includes('strike')) {
                    return {
                        type: 'number',
                        min: 0,
                        step: 0.01,
                        inputmode: 'decimal'
                    };
                }
                
                if (fieldKey.includes('name') || fieldKey.includes('Name')) {
                    return { type: 'text' };
                }
                
                return { type: explicitType || 'text' };
            },

            formatFieldValue(value, fieldKey, inputType) {
                if (!value && value !== 0) return '';
                
                if (inputType === 'date' || fieldKey.includes('name')) {
                    return value;
                }
                
                if (inputType === 'text' && typeof value === 'number' && !fieldKey.includes('percent')) {
                    return new Intl.NumberFormat('en-US').format(value);
                }
                
                return value;
            },

            isFieldValid(fieldKey, value) {
                if (!value && value !== 0) return false;
                
                if (fieldKey.includes('percent') || fieldKey.includes('rate')) {
                    const num = parseFloat(value);
                    return !isNaN(num) && num >= 0 && num <= 100;
                }
                
                if (fieldKey.includes('shares')) {
                    const num = parseFloat(value);
                    return !isNaN(num) && num >= 0;
                }
                
                if (fieldKey.includes('date')) {
                    return !isNaN(new Date(value).getTime());
                }
                
                const num = this.formatValue(value, { mode: 'parse' });
                return !isNaN(num) && num >= 0;
            },
            
            renderFundingTimeline() {
                 const cardId = 'card-funding-timeline';
                const isCollapsed = this.state.collapsibleState[cardId];

                const sequence = this.fundingSequence.order;
                const activeRounds = this.state.rounds.map(r => r.type);
                
                return `
                    <div class="card ${isCollapsed ? 'collapsed' : ''}" id="${cardId}" style="background: linear-gradient(135deg, var(--primary-light), var(--white));">
                        <div class="card-header" data-collapsible="true">
                            <h2 class="card-title">🎯 Funding Timeline</h2>
                            <span class="collapse-icon"></span>
                        </div>
                        <div class="card-content">
                            <div class="timeline">
                                ${sequence.map((type, i) => {
                                    const isActive = activeRounds.includes(type);
                                    const canAdd = this.fundingSequence.canAdd(type);
                                    const roundInfo = this.fundingSequence.roundDefaults[type];
                                    
                                    return `
                                        ${i > 0 ? `
                                            <div class="timeline-connector" style="
                                                background: ${isActive || activeRounds.includes(sequence[i - 1]) ? 'var(--primary)' : 'var(--gray-light)'};
                                            "></div>
                                        ` : ''}
                                        <div class="timeline-node ${canAdd && !isActive ? 'available' : ''}" 
                                             style="
                                                background: ${isActive ? 'var(--primary)' : canAdd ? 'var(--white)' : 'var(--gray-light)'};
                                                color: ${isActive ? 'var(--white)' : 'var(--dark)'};
                                                border: 2px solid ${isActive ? 'var(--primary-dark)' : canAdd ? 'var(--primary)' : 'var(--gray-light)'};
                                             "
                                             ${canAdd && !isActive ? `data-action="addRound" data-round-type="${type}"` : ''}>
                                            <div style="font-size: 1.5rem;">${roundInfo.icon}</div>
                                            <div style="font-weight: 600; font-size: 0.75rem;">
                                                ${roundInfo.name}
                                            </div>
                                            ${isActive ? '<div style="font-size: 0.6rem;">✓ Active</div>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderExitDetails() {
                const { exitDetails } = this.state;
                if (!exitDetails.escrowDetails) {
                    exitDetails.escrowDetails = { allocationMethod: 'proRata' };
                }
                const cardId = 'card-exit-details';
                const isCollapsed = this.state.collapsibleState[cardId];
                
                return `
                    <div class="card ${isCollapsed ? 'collapsed' : ''}" id="${cardId}">
                        <div class="card-header" data-collapsible="true">
                            <h2 class="card-title">💰 Exit Details</h2>
                            <span class="collapse-icon"></span>
                        </div>
                        <div class="card-content">
                            <div class="grid grid-2">
                                ${this.renderField({ label: 'Gross Exit Value ($)', fieldKey: 'exitDetails.grossValue', value: exitDetails.grossValue, placeholder: 'e.g. 100M' })}
                                ${this.renderField({ label: 'Closing Date', fieldKey: 'exitDetails.exitDate', value: exitDetails.exitDate, type: 'date' })}
                            </div>

                            ${this.state.warnings.debtExceedsExit ? `
                                <div class="warning-box">
                                    <strong>Warning:</strong> The outstanding debt of $${this.formatValue(exitDetails.debt)} exceeds the gross exit value. 
                                    In this scenario, only debt holders would receive proceeds, and it might not cover the full debt amount.
                                </div>
                            `: ''}
                            
                            <h3 style="color: var(--danger); margin: 1rem 0;">📉 Expenses & Deductions</h3>
                            
                            <div class="grid grid-3">
                                ${this.renderField({ label: 'Outstanding Debt ($)', fieldKey: 'exitDetails.debt', value: exitDetails.debt, placeholder: 'e.g. 5,000,000' })}
                                ${this.renderField({ label: 'Legal & Closing Fees ($)', fieldKey: 'exitDetails.legalFees', value: exitDetails.legalFees, placeholder: 'e.g. 500k' })}
                                ${this.renderField({ label: 'M&A Advisor Fees (%)', fieldKey: 'exitDetails.advisorFeePercent', value: exitDetails.advisorFeePercent, placeholder: '2' })}
                                
                                ${this.renderField({ label: 'Other Expenses ($)', fieldKey: 'exitDetails.otherExpenses', value: exitDetails.otherExpenses, placeholder: '0' })}
                            </div>
                            
                            <h3 style="color: var(--primary); margin: 1rem 0;">🎯 Management Incentives</h3>
                            <div class="grid grid-2">
                                <div>
                                    <div class="input-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" 
                                                   data-field="exitDetails.managementCarveout.enabled" 
                                                   ${exitDetails.managementCarveout.enabled ? 'checked' : ''}>
                                            <span class="tooltip multiline" data-tooltip="Bonus pool for management team, paid before investors. Typical: 5-15% in distressed sales. Founder-friendly">Enable Management Carve-out</span>
                                        </label>
                                    </div>
                                    
                                    ${exitDetails.managementCarveout.enabled ? `
                                        ${this.renderField({ label: 'Carve-out Percentage (%)', fieldKey: 'exitDetails.managementCarveout.percent', value: exitDetails.managementCarveout.percent, placeholder: '10' })}
                                    ` : ''}
                                </div>
                                <div>
                                    <div class="input-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" 
                                                   data-field="exitDetails.mip.enabled" 
                                                   ${exitDetails.mip?.enabled ? 'checked' : ''}>
                                            <span class="tooltip multiline" data-tooltip="Additional incentive from remaining proceeds after preferences. Typical: 5-10%. Reduces investor returns">Enable MIP</span>
                                        </label>
                                    </div>
                                    
                                    ${exitDetails.mip?.enabled ? `
                                        ${this.renderField({ label: 'MIP Percentage (%)', fieldKey: 'exitDetails.mip.percent', value: exitDetails.mip.percent, placeholder: '10' })}
                                    ` : ''}
                                </div>
                            </div>

                            <h3 style="color: var(--primary); margin: 1.5rem 0 1rem 0;">⚖️ Consent & Drag-Along Rights</h3>
                            <div class="grid grid-2">
                                <div class="input-group">
                                    <label class="input-label">Consent Modeling <span class="tooltip" data-tooltip="Simulates whether shareholders would approve the sale. Model shows voting mechanics, Assume bypasses this check">ⓘ</span></label>
                                    <select class="input-field" data-field="exitDetails.dragAlong.consentModel">
                                        <option value="model" ${exitDetails.dragAlong.consentModel === 'model' ? 'selected' : ''}>Model Shareholder Consent</option>
                                        <option value="assume" ${exitDetails.dragAlong.consentModel === 'assume' ? 'selected' : ''}>Assume Consent is Met</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" 
                                               data-field="exitDetails.dragAlong.enabled" 
                                               ${exitDetails.dragAlong.enabled ? 'checked' : ''}>
                                        <span class="tooltip multiline" data-tooltip="Forces minority shareholders to sell if majority approves. Investor-friendly provision that ensures deals can close">Enable Drag-Along Rights</span>
                                    </label>
                                </div>
                                ${exitDetails.dragAlong.enabled ? `
                                    <div class="grid grid-2">
                                        ${this.renderField({ 
                                            label: 'Common Threshold (%)', 
                                            fieldKey: 'exitDetails.dragAlong.commonThreshold', 
                                            value: exitDetails.dragAlong.commonThreshold
                                        })}
                                        ${this.renderField({ 
                                            label: 'Preferred Threshold (%)', 
                                            fieldKey: 'exitDetails.dragAlong.preferredThreshold', 
                                            value: exitDetails.dragAlong.preferredThreshold
                                        })}
                                    </div>
                                ` : '<div></div>'}
                            </div>

                            <div style="background: var(--light); padding: 1rem; border-radius: var(--border-radius); margin-top: 1rem;">
                                <h4 style="color: var(--primary);">💵 Proceeds Summary</h4>
                                <div>Gross Exit: <strong>$${this.formatValue(exitDetails.grossValue)}</strong></div>
                                <div style="color: var(--danger);">Total Expenses: <strong>-$${this.formatValue(this.calculateTotalExpenses())}</strong></div>
                                ${exitDetails.managementCarveout.enabled ? `
                                    <div style="color: var(--warning);">Carve-out: <strong>-$${this.formatValue(this.calculateManagementCarveout())}</strong></div>
                                ` : ''}
                                <div style="font-size: 1.2rem; margin-top: 0.5rem; color: var(--success);">
                                    Net Distributable: <strong>$${this.formatValue(Math.max(0, this.calculateNetProceeds()))}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            // Payment Schedule
            renderPaymentSchedule() {
                const cardId = 'card-payment-schedule';
                const isCollapsed = this.state.collapsibleState[cardId];
                const { payments, npvSettings } = this.state.exitDetails;
                const totalPercent = this.safeSum(payments.map(p => p.percent));
                const totalError = Math.abs(totalPercent - 100) > 0.01;
                
                return `
                     <div class="card ${isCollapsed ? 'collapsed' : ''}" id="${cardId}">
                        <div class="card-header" data-collapsible="true">
                            <h2 class="card-title">🗓️ Payment Schedule & NPV</h2>
                            <span class="collapse-icon"></span>
                        </div>
                        <div class="card-content">
                            <div class="grid grid-payment" style="font-weight: bold; color: var(--gray-dark); margin-bottom: 0.5rem;">
                                <span>Payment Name</span>
                                <span>Date</span>
                                <span>Percent (%)</span>
                                <span></span>
                            </div>

                            ${payments.map((payment, index) => `
                                <div class="grid grid-payment">
                                    <input type="text" class="input-field" data-field="exitDetails.payments.${index}.name" value="${payment.name}">
                                    <input type="date" class="input-field" data-field="exitDetails.payments.${index}.date" value="${payment.date}">
                                    <input type="number" class="input-field" data-field="exitDetails.payments.${index}.percent" value="${payment.percent}" step="0.1">
                                    <button class="btn btn-danger btn-sm" data-action="removePayment" data-index="${index}" ${payments.length === 1 ? 'disabled' : ''}>-</button>
                                </div>
                            `).join('')}

                            <div class="text-right mt-2">
                                <button class="btn btn-secondary btn-sm" data-action="addPayment">+ Add Payment</button>
                            </div>
                            
                            <div class="mt-3 p-2" style="border-radius: var(--border-radius); background: ${totalError ? 'var(--danger)' : 'var(--success)'}; color: white; text-align: center; font-weight: 600;">
                                Total Allocated: ${totalPercent.toFixed(1)}%
                                ${this.state.errors.paymentTotal ? `<div style="font-size: 0.8em; font-weight: normal;">${this.state.errors.paymentTotal}</div>` : ''}
                            </div>
                            
                            <h3 style="color: var(--primary); margin: 1.5rem 0 1rem 0;">Net Present Value (NPV) Settings</h3>
                            <div class="grid grid-2">
                                <div class="input-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" data-field="exitDetails.npvSettings.enabled" ${npvSettings.enabled ? 'checked' : ''}>
                                        <span class="tooltip" data-tooltip="Adjusts future payments to today's value using discount rate. Shows true economic value of deferred payments">Enable NPV Calculation</span>
                                    </label>
                                </div>
                                ${npvSettings.enabled ? `
                                    ${this.renderField({ label: 'Annual Discount Rate (%)', fieldKey: 'exitDetails.npvSettings.discountRate', value: npvSettings.discountRate, placeholder: 'e.g., 10' })}
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderDilutionImpact() {
                if (!this.state.safes.length || !this.state.rounds.some(r => r.type !== 'safes' && r.shares > 0)) {
                    return '';
                }
                
                const convertedSafes = this.calculations.convertAllSafes(
                    this.state.safes,
                    this.state.exitDetails.grossValue,
                    this.calculations.applySplits(this.state.rounds)
                );
                
                const dilutionTable = this.calculations.calculateDilution(
                    this.state.rounds,
                    convertedSafes
                );
                
                const cardId = 'card-dilution-impact';
                const isCollapsed = this.state.collapsibleState[cardId];
                
                return `
                    <div class="card ${isCollapsed ? 'collapsed' : ''}" id="${cardId}">
                        <div class="card-header" data-collapsible="true">
                            <h2 class="card-title">📉 Dilution Impact from <span class="tooltip" data-tooltip="Converts to equity at exit or next funding round">SAFE</span> Conversion</h2>
                             <span class="collapse-icon"></span>
                        </div>
                        <div class="card-content">
                            <div class="table-scroll-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="padding: 0.5rem;">Stakeholder</th>
                                            <th style="padding: 0.5rem; text-align: center;">Pre-SAFE %</th>
                                            <th style="padding: 0.5rem; text-align: center;">Post-SAFE %</th>
                                            <th style="padding: 0.5rem; text-align: center;">Dilution</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dilutionTable.map((row, i) => `
                                            <tr style="background: ${i % 2 === 0 ? 'var(--white)' : 'var(--light)'};">
                                                <td style="padding: 0.5rem;">${row.name}</td>
                                                <td style="padding: 0.5rem; text-align: center;">${row.preOwnership.toFixed(1)}%</td>
                                                <td style="padding: 0.5rem; text-align: center;">${row.postOwnership.toFixed(1)}%</td>
                                                <td style="padding: 0.5rem; text-align: center; color: ${row.dilution > 0 ? 'var(--danger)' : 'var(--success)'};">
                                                    ${row.type === 'safes' ? 'NEW' : `-${row.dilutionPercent.toFixed(1)}%`}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderRoundCard(round, index, totalShares) {
                const ownership = this.safeCalculateOwnership(round.shares, totalShares).toFixed(2);
                const isFounders = round.type === 'founders';
                const isOptionPool = round.type === 'optionPool';
                const isSafes = round.type === 'safes';
                const warningKey = `rounds.${index}.liquidationPref`;
                const warning = this.state.warnings[warningKey];
                
                return `
                    <div class="card round-card">
                        <div class="card-header">
                            <div style="display: flex; align-items: center;">
                                <span class="card-title">${round.icon} ${round.name}</span>
                                ${!isSafes ? `
                                    <span class="ownership-badge">${ownership}% ownership</span>
                                ` : ''}
                            </div>
                            ${round.removable ? `
                                <button class="btn btn-danger btn-sm" 
                                        data-action="removeRound" 
                                        data-round-type="${round.type}">
                                    Remove
                                </button>
                            ` : ''}
                        </div>
                        <div class="card-content">
                            ${isSafes ? `
                                ${this.renderSafeSection()}
                            ` : `
                                <div class="grid grid-3">
                                    ${this.renderField({
                                        label: 'Investment ($)',
                                        fieldKey: `rounds.${index}.investment`,
                                        value: round.investment,
                                        placeholder: 'e.g. 2M',
                                        disabled: isFounders || isOptionPool
                                    })}
                                    ${this.renderField({
                                        label: 'Base Shares',
                                        fieldKey: `rounds.${index}.shares`,
                                        value: round.shares,
                                        placeholder: 'e.g. 1,000,000'
                                    })}
                                     ${this.renderField({
                                        label: 'Stock Split Ratio',
                                        fieldKey: `rounds.${index}.splitRatio`,
                                        value: round.splitRatio || 1,
                                        placeholder: 'e.g. 2 for 2:1'
                                    })}
                                </div>
                                
                                ${round.type === 'optionPool' ? `
                                    <div class="grid grid-3">
                                        ${this.renderField({
                                            label: 'Vested (%)',
                                            fieldKey: `rounds.${index}.poolDetails.vestedPercent`,
                                            value: round.poolDetails?.vestedPercent || 100
                                        })}
                                        ${this.renderField({
                                            label: 'Exercised (%)',
                                            fieldKey: `rounds.${index}.poolDetails.exercisedPercent`,
                                            value: round.poolDetails?.exercisedPercent || 100
                                        })}
                                        ${this.renderField({
                                            label: 'Strike Price ($)',
                                            fieldKey: `rounds.${index}.poolDetails.strikePrice`,
                                            value: round.poolDetails?.strikePrice || 0,
                                            tooltip: 'Exercise price per share'
                                        })}
                                    </div>
                                ` : ''}

                                ${!isFounders && !isOptionPool ? `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-light);">
                                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Preferred Stock Terms</h4>
                                    <div class="grid grid-5" style="align-items: start;">
                                        <div class="input-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" 
                                                        data-field="rounds.${index}.participating" 
                                                        ${round.participating ? 'checked' : ''}>
                                                <span class="tooltip multiline" data-tooltip="Receives preference AND shares in remaining proceeds">Participating</span>&nbsp;Preferred
                                            </label>
                                             ${round.participating ? `
                                                <div class="mt-2">
                                                    <label class="input-label" style="font-size: 0.9em;">
                                                        <span class="tooltip multiline" data-tooltip="Total return (preference + participation) is capped at this multiple of the investment. 0 or blank for no cap.">Part. Cap (x)</span>
                                                    </label>
                                                    <input type="number" class="input-field" data-field="rounds.${index}.participationCap" value="${round.participationCap || 0}" step="0.1" placeholder="e.g. 3">
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="input-group">
                                            <label class="input-label"><span class="tooltip multiline" data-tooltip="Priority return of invested capital before common shareholders">Liquidation Preference</span></label>
                                            <select class="input-field" 
                                                    data-field="rounds.${index}.liquidationPref">
                                                <option value="0" ${round.liquidationPref == 0 ? 'selected' : ''}>None</option>
                                                <option value="1" ${round.liquidationPref == 1 ? 'selected' : ''}>1x (Standard)</option>
                                                <option value="1.5" ${round.liquidationPref == 1.5 ? 'selected' : ''}>1.5x</option>
                                                <option value="2" ${round.liquidationPref == 2 ? 'selected' : ''}>2x</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label class="input-label"><span class="tooltip multiline" data-tooltip="Payment priority. Senior gets paid first, Pari Passu paid together proportionally, Junior paid last">Seniority</span></label>
                                            <select class="input-field" data-field="rounds.${index}.seniority">
                                                <option value="1" ${round.seniority == 1 ? 'selected' : ''}>Senior</option>
                                                <option value="2" ${round.seniority == 2 || !round.seniority ? 'selected' : ''}>Pari Passu</option>
                                                <option value="3" ${round.seniority == 3 ? 'selected' : ''}>Junior</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label class="input-label">
                                                <span class="tooltip multiline" data-tooltip="Protects against dilution from future 'down rounds'">Anti-Dilution</span>
                                            </label>
                                            <select class="input-field" data-field="rounds.${index}.antiDilution">
                                                <option value="none" ${round.antiDilution === 'none' ? 'selected' : ''}>None</option>
                                                <option value="weightedAverage" ${round.antiDilution === 'weightedAverage' ? 'selected' : ''}>Weighted Average</option>
                                                <option value="fullRatchet" ${round.antiDilution === 'fullRatchet' ? 'selected' : ''}>Full Ratchet</option>
                                            </select>
                                        </div>
                                        ${round.antiDilution === 'weightedAverage' ? `
                                        <div class="input-group">
                                            <label class="input-label">
                                                <span class="tooltip multiline" data-tooltip="Broad-base includes all common stock equivalents. Narrow-base only includes issued shares.">WA Base</span>
                                            </label>
                                            <select class="input-field" data-field="rounds.${index}.antiDilutionBase">
                                                <option value="broad" ${round.antiDilutionBase === 'broad' || !round.antiDilutionBase ? 'selected' : ''}>Broad-Based</option>
                                                <option value="narrow" ${round.antiDilutionBase === 'narrow' ? 'selected' : ''}>Narrow-Based</option>
                                            </select>
                                        </div>
                                        ` : '<div class="input-group"></div>'}
                                        <!-- Dividend Controls -->
                                        <div class="input-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox"
                                                        data-field="rounds.${index}.dividend.enabled"
                                                        ${round.dividend?.enabled ? 'checked' : ''}>
                                                <span class="tooltip multiline" data-tooltip="Simple, non-compounding dividends that accrue until exit.">Cumulative Dividends</span>
                                            </label>
                                            ${round.dividend?.enabled ? `
                                                <div class="mt-2">
                                                    ${this.renderField({ label: 'Rate (%)', fieldKey: `rounds.${index}.dividend.ratePct`, value: round.dividend.ratePct || 8 })}
                                                    ${this.renderField({ label: 'Dividend Issue Date', fieldKey: `rounds.${index}.dividend.issuedOn`, value: round.dividend.issuedOn || '', type: 'date' })}
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <!-- Preference Interest Controls -->
                                        <div class="input-group">
                                             <label class="checkbox-label">
                                                <input type="checkbox"
                                                        data-field="rounds.${index}.prefInterest.enabled"
                                                        ${round.prefInterest?.enabled ? 'checked' : ''}>
                                                <span class="tooltip multiline" data-tooltip="Simple interest on the investment, added to the liquidation preference.">Preference Interest (PIK)</span>
                                            </label>
                                            ${round.prefInterest?.enabled ? `
                                                <div class="mt-2">
                                                    ${this.renderField({ label: 'Rate (%)', fieldKey: `rounds.${index}.prefInterest.ratePct`, value: round.prefInterest.ratePct || 5 })}
                                                    ${this.renderField({ label: 'PIK Start Date', fieldKey: `rounds.${index}.prefInterest.startISO`, value: round.prefInterest.startISO || '', type: 'date' })}
                                                </div>
                                            ` : ''}
                                        </div>

                                        <!-- Pay-to-Play Controls -->
                                        <div class="input-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox"
                                                        data-field="rounds.${index}.payToPlay.enabled"
                                                        ${round.payToPlay?.enabled ? 'checked' : ''}>
                                                <span class="tooltip multiline" data-tooltip="A provision that penalizes investors who do not participate in a subsequent financing round.">Enable Pay-to-Play</span>
                                            </label>
                                             ${round.payToPlay?.enabled ? `
                                                <div class="mt-2">
                                                    <label class="checkbox-label">
                                                        <input type="checkbox"
                                                               data-field="rounds.${index}.payToPlay.participated"
                                                               ${round.payToPlay.participated ? 'checked' : ''}>
                                                        <span class="tooltip" data-tooltip="If unchecked, penalties (like conversion to common) will apply.">Participated Pro-Rata</span>
                                                    </label>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <!-- Warrant Controls -->
                                         <div class="input-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox"
                                                        data-field="rounds.${index}.warrant.enabled"
                                                        ${round.warrant?.enabled ? 'checked' : ''}>
                                                <span class="tooltip multiline" data-tooltip="Equity kickers that grant the right to buy additional stock at a fixed price.">Enable Warrants</span>
                                            </label>
                                            ${round.warrant?.enabled ? `
                                                <div class="mt-2">
                                                    ${this.renderField({ label: 'Coverage (%)', fieldKey: `rounds.${index}.warrant.coveragePct`, value: round.warrant.coveragePct || 10 })}
                                                    ${this.renderField({ label: 'Strike ($)', fieldKey: `rounds.${index}.warrant.strike`, value: round.warrant.strike || 0.01 })}
                                                </div>
                                            ` : ''}
                                        </div>
                                         <!-- Redemption Rights Controls -->
                                        <div class="input-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox"
                                                        data-field="rounds.${index}.redemption.enabled"
                                                        ${round.redemption?.enabled ? 'checked' : ''}>
                                                <span class="tooltip multiline" data-tooltip="Gives investors the right to have their shares bought back by the company after a certain date, creating a floor on their return.">Redemption Rights</span>
                                            </label>
                                             ${round.redemption?.enabled ? `
                                                <div class="mt-2">
                                                     ${this.renderField({ label: 'Start Date', fieldKey: `rounds.${index}.redemption.startISO`, value: round.redemption.startISO || '', type: 'date' })}
                                                     ${this.renderField({ label: 'Multiple (x)', fieldKey: `rounds.${index}.redemption.multiple`, value: round.redemption.multiple || 1 })}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${warning ? `<div class="warning-box mt-2"><strong>Term Warning:</strong> ${warning}</div>` : ''}
                                </div>
                                ` : ''}
                            `}
                        </div>
                    </div>
                `;
            },

            renderSafeSection() {
                return `
                    <div>
                        <button class="btn btn-secondary btn-sm" 
                                data-action="addSafe"
                                ${this.state.safes.length >= 5 ? 'disabled' : ''}>
                            + Add <span class="tooltip" data-tooltip="Converts to equity at exit or next funding round">SAFE</span> Note ${this.state.safes.length > 0 ? `(${this.state.safes.length}/5)` : ''}
                        </button>
                        
                        ${this.state.safes.map((safe, index) => 
                            this.renderSafeCard(safe, index)
                        ).join('')}
                        
                        ${this.state.safes.length > 0 ? `
                            <div style="background: var(--success); color: var(--white); padding: 1rem; border-radius: var(--border-radius); margin-top: 1rem;">
                                <h4>🚀 <span class="tooltip" data-tooltip="Converts to equity at exit or next funding round">SAFE</span> Conversion Summary</h4>
                                <div>Total Investment: $${this.formatValue(this.safeSum(this.state.safes.map(s => s.amount)))}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            renderSafeCard(safe, index) {
                const preMoneyShares = this.safeSum(this.state.rounds.map(r => r.shares));
                
                let conversionPreview = null;
                if (preMoneyShares > 0) {
                    const allConverted = this.calculations.convertAllSafes(
                        this.state.safes, 
                        this.state.exitDetails.grossValue, 
                        this.calculations.applySplits(this.state.rounds)
                    );
                    conversionPreview = allConverted[index];
                }
                
                return `
                    <div class="safe-card">
                        <div class="card-header">
                            <span>📄 <span class="tooltip" data-tooltip="Converts to equity at exit or next funding round">SAFE</span> Note #${index + 1}</span>
                            <button class="btn btn-danger btn-sm" 
                                    data-action="removeSafe" 
                                    data-safe-index="${index}">
                                Remove
                            </button>
                        </div>
                        <div class="card-content">
                            <div class="grid grid-2">
                                ${this.renderField({
                                    label: 'Investment ($)',
                                    fieldKey: `safes.${index}.amount`,
                                    value: safe.amount,
                                    placeholder: 'e.g. 500k'
                                })}
                                ${this.renderField({
                                    label: 'Discount (%)',
                                    fieldKey: `safes.${index}.discount`,
                                    value: safe.discount,
                                    placeholder: '20'
                                })}
                                ${this.renderField({
                                    label: 'Valuation Cap ($)',
                                    fieldKey: `safes.${index}.valuationCap`,
                                    value: safe.valuationCap,
                                    placeholder: 'e.g. 5M'
                                })}
                                <div class="input-group">
                                    <label class="input-label"><span class="tooltip" data-tooltip="Pre-money cap is applied to the company's valuation before the investment. Post-money includes the investment in the valuation.">Cap Type</span></label>
                                    <select class="input-field" data-field="safes.${index}.capType">
                                        <option value="pre-money" ${safe.capType === 'pre-money' || !safe.capType ? 'selected' : ''}>Pre-money</option>
                                        <option value="post-money" ${safe.capType === 'post-money' ? 'selected' : ''}>Post-money</option>
                                    </select>
                                </div>
                            </div>

                             <div class="input-group" style="margin-bottom: 0.5rem;">
                                <label class="checkbox-label">
                                    <input type="checkbox" 
                                           data-field="safes.${index}.mfnEnabled" 
                                           ${safe.mfnEnabled ? 'checked' : ''}>
                                    <span class="tooltip multiline" data-tooltip="Most Favored Nation: This SAFE converts at the best price offered to any other SAFE note.">Enable MFN</span>
                                </label>
                            </div>
                            
                            ${conversionPreview && conversionPreview.shares > 0 ? `
                                <div style="background: var(--primary-light); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                    <strong>Conversion Preview:</strong>
                                    Converts at $${conversionPreview.conversionPrice.toFixed(4)} via ${conversionPreview.mechanism}
                                    (${this.formatValue(Math.round(conversionPreview.shares))} shares)
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },
            
            renderCalculationDetails() {
                const { results } = this.state;
                if (!results) return '';

                const { rounds, safes, grossExit, netProceeds, exitDetails, mipAmount } = results;
                const expensesOnly = this.calculateTotalExpenses(grossExit);
                const carveout = this.calculateManagementCarveout(grossExit);

                const preMoneyShares = this.safeSum(results.originalRounds.filter(r => r.type !== 'safes').map(r => r.shares));
                const safeConversions = this.calculations.convertAllSafes(safes, grossExit, rounds);
                
                const preferenceDistributions = results.distributions.filter(d => d.liquidationPref > 0);
                const totalPreferencePaid = this.safeSum(preferenceDistributions.map(d => d.liquidationPref));

                const remainingForProRata = Math.max(0, netProceeds - totalPreferencePaid - (mipAmount || 0));
                const totalSharesWithSafes = this.getTotalSharesWithSafes();

                return `
                    <div class="breakdown-step">
                        <h3 class="breakdown-title">Step 1: Net Proceeds Calculation</h3>
                        <div class="breakdown-formula">
                           <span class="text-success">$${this.formatValue(grossExit)}</span> (Gross Exit)
                           - <span class="text-danger">$${this.formatValue(expensesOnly)}</span> (Expenses)
                           ${carveout > 0 ? `- <span class="text-warning">$${this.formatValue(carveout)}</span> (Carve-out)` : ''}
                           = <span class="text-success">$${this.formatValue(netProceeds)}</span> (Net Proceeds)
                        </div>
                    </div>
                    
                    ${safeConversions.length > 0 ? `
                        <div class="breakdown-step">
                            <h3 class="breakdown-title">Step 2: SAFE Conversion</h3>
                            <p class="text-muted mb-2">Each SAFE converts to equity based on the lowest of its valuation cap price, discount price, the liquidity price, or an MFN price.</p>
                            ${safeConversions.map((safe, index) => `
                                <div class="breakdown-item mb-2">
                                    <strong>SAFE Note #${index + 1} (Invested: $${this.formatValue(safe.amount)})</strong>
                                    <div class="text-muted" style="font-size: 0.85rem; font-family: monospace;">
                                        Liquidity Price: $${this.formatValue(grossExit)} / ${this.formatValue(preMoneyShares)} shares = <strong>$${safe.liquidityPrice.toFixed(4)}</strong>
                                        <br>
                                        Cap Price: $${this.formatValue(safe.valuationCap)} / ${this.formatValue(preMoneyShares)} shares = <strong>$${safe.capPrice.toFixed(4)}</strong>
                                        <br>
                                        Discount Price: $${safe.liquidityPrice.toFixed(4)} * (1 - ${safes[index].discount / 100}) = <strong>$${safe.discountPrice.toFixed(4)}</strong>
                                    </div>
                                    <div class="mt-1">
                                        <span class="highlight-mechanism">Mechanism Used: ${safe.mechanism}</span>
                                    </div>
                                    <div class="mt-1">
                                        <strong>Result:</strong> $${this.formatValue(safe.amount)} / $${safe.conversionPrice.toFixed(4)} = <strong>${this.formatValue(Math.round(safe.shares))} shares</strong>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${preferenceDistributions.length > 0 ? `
                        <div class="breakdown-step">
                            <h3 class="breakdown-title">Step 3: Liquidation Preferences</h3>
                            <p class="text-muted mb-2">Preferred shareholders get their investment back first (or multiple thereof and any accrued interest/dividends), paid in order of seniority.</p>
                            ${preferenceDistributions.map(dist => {
                                const round = rounds.find(r => r.type === dist.type);
                                const accruedDividend = this.calculations.accruedDiv(round, exitDetails.exitDate);
                                const accruedInterest = this.calculations.accruedPrefInterest(round, exitDetails.exitDate);
                                return `
                                    <div class="breakdown-item mb-2">
                                        <strong>${dist.name} ${dist.payoutReason === 'Redemption' ? '(Redeemed)' : ''}</strong>
                                        <div>
                                            ($${this.formatValue(round.investment)} (Inv) * ${round.liquidationPref}x)
                                            ${accruedDividend > 0 ? ` + <span class="text-primary">$${this.formatValue(Math.round(accruedDividend))} (Divs)</span>` : ''}
                                            ${accruedInterest > 0 ? ` + <span class="text-info">$${this.formatValue(Math.round(accruedInterest))} (Interest)</span>` : ''}
                                            = <span class="text-warning">$${this.formatValue(Math.round(dist.liquidationPref))}</span>
                                        </div>
                                    </div>
                                `
                            }).join('')}
                            <div class="breakdown-formula mt-2">
                                <span class="text-success">$${this.formatValue(netProceeds)}</span> (Net Proceeds)
                                 - <span class="text-warning">$${this.formatValue(Math.round(totalPreferencePaid))}</span> (Total Prefs)
                                 = <span class="text-success">$${this.formatValue(Math.round(netProceeds - totalPreferencePaid))}</span> (Remaining for Participation Pool)
                            </div>
                        </div>
                    `: ''}
                    
                    ${mipAmount > 0 ? `
                        <div class="breakdown-step">
                            <h3 class="breakdown-title">Step 4: Management Incentive Plan (MIP)</h3>
                             <div class="breakdown-formula">
                                <span class="text-success">$${this.formatValue(Math.round(netProceeds - totalPreferencePaid))}</span> (Participation Pool)
                                 * ${exitDetails.mip.percent}% (MIP Rate)
                                 = <span class="text-warning">$${this.formatValue(Math.round(mipAmount))}</span> (MIP Amount)
                            </div>
                        </div>
                    ` : ''}

                    ${remainingForProRata > 0 ? `
                        <div class="breakdown-step">
                            <h3 class="breakdown-title">Step 5: Remaining Pro-Rata Distribution</h3>
                            <p class="text-muted mb-2">The remaining <span class="text-success">$${this.formatValue(Math.round(remainingForProRata))}</span> is split among common and participating preferred shareholders based on ownership.</p>
                            ${results.distributions.filter(d => d.participation > 0).map(dist => {
                                const ownership = this.safeCalculateOwnership(dist.shares, totalSharesWithSafes);
                                return `
                                    <div class="breakdown-item mb-2">
                                        <strong>${dist.name} (${ownership.toFixed(2)}% ownership)</strong>
                                        <div>
                                            ${ownership.toFixed(2)}% * $${this.formatValue(Math.round(remainingForProRata))} = 
                                            <span class="text-success">$${this.formatValue(Math.round(dist.participation))}</span>
                                        </div>
                                    </div>
                                `
                            }).join('')}
                        </div>
                    ` : ''}
                `;
            },

            renderResultsSummary() {
                const cardId = 'card-results-summary';
                const isCollapsed = this.state.collapsibleState[cardId];
                const totalInvested = this.safeSum(this.state.results.distributions.map(d => d.invested));
                const grossMultiple = this.safeDivide(this.state.results.grossExit, totalInvested);
                const netMultiple = this.safeDivide(this.state.results.totalDistributed, totalInvested);
                const topRecipient = this.state.results.distributions[0] || null;
                
                const expensesOnly = this.calculateTotalExpenses(this.state.results.grossExit);
                const carveoutAmt = this.calculateManagementCarveout(this.state.results.grossExit);
                const mipAmt = this.state.results.mipAmount || 0;
                
                return `
                    <div class="card ${isCollapsed ? 'collapsed' : ''}" id="${cardId}">
                        <div class="card-header" data-collapsible="true">
                            <h2 class="card-title">💵 Distribution Summary</h2>
                            <span class="collapse-icon"></span>
                        </div>
                        <div class="card-content">
                            <div class="grid grid-3">
                                <div>
                                    <div class="text-muted">Gross Exit</div>
                                    <div class="text-primary" style="font-size: 1.5rem;">
                                        $${this.formatValue(this.state.results.grossExit)}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-muted">Deductions & Allocations</div>
                                    <div class="text-danger" style="font-size: 1.5rem;">
                                        -$${this.formatValue(expensesOnly + carveoutAmt + mipAmt)}
                                    </div>
                                    <div class="text-muted" style="font-size: .9rem; margin-top:.25rem;">
                                      <span>Expenses: $${this.formatValue(expensesOnly)}</span>
                                      ${carveoutAmt > 0 ? `· <span>Carve-out: $${this.formatValue(carveoutAmt)}</span>` : ''}
                                      ${mipAmt > 0 ? `· <span>MIP: $${this.formatValue(mipAmt)}</span>` : ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-muted">Net Distributable to Shareholders</div>
                                    <div class="text-success" style="font-size: 1.5rem;">
                                        $${this.formatValue(Math.max(0, this.state.results.netProceeds - mipAmt))}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-light);">
                                <h3 style="margin-bottom: 1rem;">📈 Key Metrics</h3>
                                <div class="grid grid-3">
                                    <div>
                                        <div class="text-muted">Total Capital Raised</div>
                                        <div style="font-size: 1.2rem; color: var(--dark);">
                                            $${this.formatValue(totalInvested)}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-muted">Gross Multiple</div>
                                        <div style="font-size: 1.2rem; color: ${grossMultiple >= 1 ? 'var(--success)' : 'var(--danger)'};">
                                            ${grossMultiple.toFixed(2)}x
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-muted">Net Multiple to Shareholders</div>
                                        <div style="font-size: 1.2rem; color: ${netMultiple >= 1 ? 'var(--success)' : 'var(--danger)'};">
                                            ${netMultiple.toFixed(2)}x
                                        </div>
                                    </div>
                                </div>
                                
                                ${topRecipient ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: var(--primary-light); border-radius: var(--border-radius);">
                                        <strong>🏆 Top Recipient:</strong> ${topRecipient.name} receives $${this.formatValue(Math.round(topRecipient.totalProceeds))} 
                                        (${this.safeCalculateOwnership(topRecipient.totalProceeds, this.state.results.netProceeds - mipAmt).toFixed(1)}% of net proceeds)
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderWaterfallFlow() {
                if (!this.state.results || this.state.results.netProceeds <= 0) {
                    return '';
                }
                
                const distributions = [...this.state.results.distributions].sort((a, b) => 
                    WaterfallCalculator.getCapitalStackOrder(b.type) - WaterfallCalculator.getCapitalStackOrder(a.type)
                );
                const maxProceeds = Math.max(...distributions.map(d => d.totalProceeds));
                
                return `
                    <div class="card" id="card-waterfall-flow">
                        <div class="card-header" data-collapsible="true">
                            <h2 class="card-title">💧 <span class="tooltip" data-tooltip="Sequential order of who gets paid at exit">Waterfall</span> Flow Visualization</h2>
                            <span class="collapse-icon"></span>
                        </div>
                        <div class="card-content">
                            <div style="padding: 0.5rem;">
                                <!-- Wrap in scrollable container for mobile -->
                                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                                    <div style="display: flex; align-items: center; margin-bottom: 1.5rem; min-width: 300px; gap: 0.5rem; flex-wrap: nowrap;">
                                        <div style="background: var(--primary); color: white; padding: 0.5rem 0.75rem; border-radius: var(--border-radius); font-weight: 600; white-space: nowrap; flex-shrink: 0;">
                                            Gross Exit: $${this.formatValue(this.state.results.grossExit)}
                                        </div>
                                        <div style="flex: 0 0 30px; height: 2px; background: var(--primary);"></div>
                                        <div style="background: var(--danger); color: white; padding: 0.5rem 0.75rem; border-radius: var(--border-radius); white-space: nowrap; flex-shrink: 0;">
                                            Expenses: -$${this.formatValue(this.state.results.grossExit - this.state.results.netProceeds)}
                                        </div>
                                        <div style="flex: 0 0 30px; height: 2px; background: var(--danger);"></div>
                                        <div style="background: var(--success); color: white; padding: 0.5rem 0.75rem; border-radius: var(--border-radius); font-weight: 600; white-space: nowrap; flex-shrink: 0;">
                                            Net: $${this.formatValue(this.state.results.netProceeds)}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 2rem;">
                                    <h4 style="margin-bottom: 1rem;">Distribution Breakdown:</h4>
                                    
                                    ${distributions.map(dist => {
                                        const barWidth = this.safeDivide(dist.totalProceeds * 100, maxProceeds);
                                        const prefWidth = dist.liquidationPref > 0 ? this.safeDivide(dist.liquidationPref * 100, dist.totalProceeds) : 0;
                                        
                                        return `
                                            <div style="margin-bottom: 1rem;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem; flex-wrap: wrap; gap: 0.5rem;">
                                                    <span style="font-weight: 500; word-break: break-word;">${dist.name}</span>
                                                    <span style="font-weight: 600; white-space: nowrap;">$${this.formatValue(Math.round(dist.totalProceeds))}</span>
                                                </div>
                                                <div style="height: 30px; background: var(--gray-light); border-radius: 4px; overflow: hidden; position: relative;">
                                                    <div style="height: 100%; width: ${barWidth}%; display: flex; min-width: 2px;">
                                                        ${dist.liquidationPref > 0 ? `
                                                            <div style="width: ${prefWidth}%; background: var(--warning); position: relative; min-width: 2px;" 
                                                                 title="Liquidation Preference: $${this.formatValue(Math.round(dist.liquidationPref))}">
                                                                <span style="position: absolute; left: 4px; top: 50%; transform: translateY(-50%); font-size: 0.65rem; font-weight: 600;">
                                                                    ${prefWidth > 20 ? 'Pref' : ''}
                                                                </span>
                                                            </div>
                                                        ` : ''}
                                                        ${dist.participation > 0 ? `
                                                            <div style="flex: 1; background: ${dist.type === 'founders' ? 'var(--primary)' : 'var(--success)'}; position: relative; min-width: 2px;"
                                                                 title="Participation: $${this.formatValue(Math.round(dist.participation))}">
                                                                <span style="position: absolute; left: 4px; top: 50%; transform: translateY(-50%); font-size: 0.65rem; font-weight: 600; color: white;">
                                                                    ${(100 - prefWidth) > 20 ? 'Part' : ''}
                                                                </span>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.25rem; font-size: 0.75rem; color: var(--gray);">
                                                    ${dist.invested > 0 ? `
                                                        <span style="white-space: nowrap;">Invested: $${this.formatValue(dist.invested)}</span>
                                                        <span style="white-space: nowrap;"><span class="tooltip multiline" data-tooltip="Multiple on Invested Capital - total return divided by investment">MOIC</span>: ${dist.moic.toFixed(2)}x</span>
                                                    ` : `
                                                        <span>No investment</span>
                                                    `}
                                                    ${dist.shares ? `
                                                        <span style="white-space: nowrap;">Ownership: ${this.safeCalculateOwnership(dist.shares, this.getTotalSharesWithSafes()).toFixed(1)}%</span>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    <div style="margin-top: 1rem; padding: 0.5rem; background: var(--light); border-radius: 4px; font-size: 0.8rem;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                            <span style="white-space: nowrap;"><span style="display: inline-block; width: 12px; height: 12px; background: var(--warning); border-radius: 2px; vertical-align: middle;"></span> <span class="tooltip multiline" data-tooltip="Priority return of invested capital before common shareholders">Liquidation Preference</span></span>
                                            <span style="white-space: nowrap;"><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 2px; vertical-align: middle;"></span> Participation</span>
                                            <span style="white-space: nowrap;"><span style="display: inline-block; width: 12px; height: 12px; background: var(--primary); border-radius: 2px; vertical-align: middle;"></span> Common (Founders)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            getTotalSharesWithSafes() {
                if (!this.state.results) return this.getTotalShares();

                const baseShares = this.safeSum(this.state.results.rounds.filter(r => r.type !== 'safes').map(r => r.shares));
                
                const safesDist = this.state.results.distributions.find(d => d.type === 'safes');
                const safeShares = safesDist ? safesDist.shares : 0;
                
                return baseShares + safeShares;
            },

            renderExpenseBreakdown() {
                const { exitDetails, grossExit, mipAmount } = this.state.results;
                const carveoutAmount = this.calculateManagementCarveout(grossExit);
                return `
                    <div class="card" id="card-expense-breakdown">
                        <div class="card-header" data-collapsible="true">
                            <h2 class="card-title">📊 Deductions & Allocations</h2>
                            <span class="collapse-icon"></span>
                        </div>
                        <div class="card-content">
                             <div class="table-scroll-wrapper">
                                <table>
                                    <tr>
                                        <td>Outstanding Debt</td>
                                        <td style="text-align: right;">$${this.formatValue(exitDetails.debt)}</td>
                                    </tr>
                                    <tr>
                                        <td>Legal & Closing Fees</td>
                                        <td style="text-align: right;">$${this.formatValue(exitDetails.legalFees)}</td>
                                    </tr>
                                    <tr>
                                        <td>Advisor Fees (${exitDetails.advisorFeePercent}%)</td>
                                        <td style="text-align: right;">$${this.formatValue(this.calculateAdvisorFees(grossExit))}</td>
                                    </tr>
                                    ${exitDetails.otherExpenses > 0 ? `
                                        <tr>
                                            <td>Other Expenses</td>
                                            <td style="text-align: right;">$${this.formatValue(exitDetails.otherExpenses)}</td>
                                        </tr>
                                    ` : ''}
                                    ${exitDetails.managementCarveout.enabled ? `
                                    <tr style="background: var(--light); border-left: 4px solid var(--warning);">
                                        <td><strong style="color: var(--warning);">Management Carve-out (${exitDetails.managementCarveout.percent}%)</strong></td>
                                        <td style="text-align: right;"><strong style="color: var(--warning);">$${this.formatValue(carveoutAmount)}</strong></td>
                                    </tr>
                                    ` : ''}
                                    ${exitDetails.mip.enabled ? `
                                    <tr style="background: var(--light); border-left: 4px solid var(--warning);">
                                        <td><strong style="color: var(--warning);">MIP (${exitDetails.mip.percent}%)</strong></td>
                                        <td style="text-align: right;"><strong style="color: var(--warning);">$${this.formatValue(mipAmount)}</strong></td>
                                    </tr>
                                    ` : ''}
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderCapTable() {
                if (!this.state.results || !this.state.results.distributions) {
                    return '';
                }
                
                const sortedDistributions = [...this.state.results.distributions].sort((a, b) => {
                    const orderA = this.getCapitalStackOrder(a.type);
                    const orderB = this.getCapitalStackOrder(b.type);
                    if (orderA !== orderB) {
                        return orderA - orderB;
                    }
                    return a.name.localeCompare(b.name);
                });
                
                return this.renderCapTableWithDistributions(sortedDistributions);
            },

            renderCapTableWithDistributions(distributions) {
                const { npvSettings } = this.state.results.exitDetails;
                let lastCategory = null;

                return `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">💰 <span class="tooltip" data-tooltip="Sequential order of who gets paid at exit">Waterfall</span> Distribution Breakdown</h2>
                        </div>
                        <div class="card-content">
                            ${this.state.results.netProceeds <= 0 ? `
                                <div class="text-danger p-2">
                                    ⚠️ Exit value does not cover expenses. No distributions to stakeholders.
                                </div>
                            ` : `
                                <div class="table-scroll-wrapper">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th style="padding: 0.75rem; text-align: left; color: var(--white);">Stakeholder</th>
                                                <th style="padding: 0.75rem; text-align: right; color: var(--white);">Invested</th>
                                                <th style="padding: 0.75rem; text-align: right; color: var(--white);">Liquidation Pref</th>
                                                <th style="padding: 0.75rem; text-align: right; color: var(--white);">Participation</th>
                                                <th style="padding: 0.75rem; text-align: right; color: var(--white);">
                                                    Total Proceeds ${npvSettings.enabled ? '(Nominal)' : ''}
                                                </th>
                                                <th style="padding: 0.75rem; text-align: right; color: var(--white);">Immediate Payout</th>
                                                <th style="padding: 0.75rem; text-align: right; color: var(--white);">Total Deferred</th>
                                                <th style="padding: 0.75rem; text-align: center; color: var(--white);"><span class="tooltip multiline" data-tooltip="Multiple on Invested Capital - total return divided by investment">MOIC</span></th>
                                                ${this.renderIRRColumn()}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${distributions.map((dist, i) => {
                                                const category = this.getCapitalCategory(dist.type);
                                                const showSeparator = lastCategory !== null && lastCategory !== category;
                                                lastCategory = category;
                                                const roundData = this.state.results.rounds.find(r => r.type === dist.type);
                                                const irrCalc = this.calculations.calculateIRR.calculateForStakeholder(
                                                    dist,
                                                    this.state
                                                );
                                                return `
                                                    ${showSeparator ? `
                                                        <tr class="category-separator">
                                                            <td colspan="9" style="height: 2px; padding: 0; background: var(--gray-light);"></td>
                                                        </tr>
                                                    ` : ''}
                                                    <tr style="background: ${i % 2 === 0 ? 'var(--white)' : 'var(--light)'};${dist.type === 'founders' ? ' font-weight: 600;' : ''}">
                                                        <td style="padding: 0.75rem;">
                                                            ${dist.name}
                                                            ${roundData && roundData.adjusted ? 
                                                                `<span class="tooltip" data-tooltip="${roundData.adjustmentReason}"> (Adjusted)</span>` : ''}
                                                            ${dist.participating !== undefined && dist.participating ? 
                                                                '<span style="color: var(--primary); font-size: 0.75rem;"> (<span class="tooltip multiline" data-tooltip="Receives preference AND shares in remaining proceeds">Participating</span>)</span>' : ''}
                                                            ${!dist.participating && dist.choiceReason ? 
                                                                `<span class="tooltip" data-tooltip="${dist.choiceReason}"> ⓘ</span>` : ''}
                                                            ${dist.cappedReason ? 
                                                                `<span class="tooltip" data-tooltip="${dist.cappedReason}"> 🧢</span>` : ''}
                                                            ${dist.penaltyReason ?
                                                                `<span class="tooltip text-danger" data-tooltip="${dist.penaltyReason}"> (penalized)</span>` : ''}
                                                             ${dist.warrantShares > 0 ?
                                                                `<span class="tooltip text-success" data-tooltip="Exercised ${this.formatValue(dist.warrantShares)} warrant shares (in the money)."> ✓ Warrants</span>` : ''}
                                                            ${dist.payoutReason === 'Redemption' ? `<span class="tooltip text-danger" data-tooltip="Return based on redemption rights floor of $${this.formatValue(dist.redemptionFloor)}"> (Redeemed)</span>` : ''}
                                                        </td>
                                                        <td style="padding: 0.75rem; text-align: right;">
                                                            ${dist.invested > 0 ? '$' + this.formatValue(dist.invested) : '-'}
                                                        </td>
                                                        <td style="padding: 0.75rem; text-align: right;">
                                                            ${dist.liquidationPref > 0 ? '$' + this.formatValue(Math.round(dist.liquidationPref)) : '-'}
                                                        </td>
                                                        <td style="padding: 0.75rem; text-align: right;">
                                                            ${dist.participation > 0 ? '$' + this.formatValue(Math.round(dist.participation)) : '-'}
                                                        </td>
                                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                                            $${this.formatValue(Math.round(dist.totalNominal))}
                                                            ${npvSettings.enabled ? `<br><span class="text-muted" style="font-size:0.8em;">(PV: $${this.formatValue(Math.round(dist.totalPV))})</span>` : ''}
                                                        </td>
                                                        <td style="padding: 0.75rem; text-align: right; color: var(--success);">
                                                            $${this.formatValue(Math.round(dist.immediateProceeds))}
                                                        </td>
                                                        <td style="padding: 0.75rem; text-align: right; color: var(--warning);">
                                                            $${this.formatValue(Math.round(dist.deferredProceeds))}
                                                        </td>
                                                        <td style="padding: 0.75rem; text-align: center;">
                                                             ${dist.invested > 0 ? `${dist.moic.toFixed(2)}x` : '-'}
                                                             ${npvSettings.enabled && dist.invested > 0 ? `<br><span class="text-muted" style="font-size:0.8em;">(PV: ${dist.moic_pv.toFixed(2)}x)</span>` : ''}
                                                        </td>
                                                        ${this.renderIRRCell(irrCalc)}
                                                    </tr>
                                                `
                                            }).join('')}
                                            
                                            <tr style="background: #003d7a; color: var(--white); font-weight: 600;">
                                                <td style="padding: 0.75rem; background: #003d7a; color: var(--white);">TOTAL</td>
                                                <td style="padding: 0.75rem; text-align: right; background: #003d7a; color: var(--white);">
                                                    $${this.formatValue(this.safeSum(this.state.results.distributions.map(d => d.invested)))}
                                                </td>
                                                <td style="padding: 0.75rem; text-align: right; background: #003d7a; color: var(--white);">
                                                    $${this.formatValue(Math.round(this.safeSum(this.state.results.distributions.map(d => d.liquidationPref))))}
                                                </td>
                                                <td style="padding: 0.75rem; text-align: right; background: #003d7a; color: var(--white);">
                                                    $${this.formatValue(Math.round(this.safeSum(this.state.results.distributions.map(d => d.participation))))}
                                                </td>
                                                <td style="padding: 0.75rem; text-align: right; background: #003d7a; color: var(--white);">
                                                    $${this.formatValue(Math.round(this.state.results.totalDistributed))}
                                                     ${npvSettings.enabled ? `<br><span style="font-size:0.8em;">(PV: $${this.formatValue(Math.round(this.safeSum(this.state.results.distributions.map(d => d.totalPV))))})</span>` : ''}
                                                </td>
                                                <td style="padding: 0.75rem; text-align: right; background: #003d7a; color: var(--white);">
                                                    $${this.formatValue(Math.round(this.safeSum(this.state.results.distributions.map(d => d.immediateProceeds))))}
                                                </td>
                                                <td style="padding: 0.75rem; text-align: right; background: #003d7a; color: var(--white);">
                                                    $${this.formatValue(Math.round(this.safeSum(this.state.results.distributions.map(d => d.deferredProceeds))))}
                                                </td>
                                                <td style="padding: 0.75rem; text-align: center; background: #003d7a; color: var(--white);">-</td>
                                                <td style="padding: 0.75rem; text-align: center; background: #003d7a; color: var(--white);">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div style="margin-top: 1rem; padding: 1rem; background: var(--light); border-radius: var(--border-radius);">
                                    <h4 style="margin-bottom: 0.5rem;">📊 Distribution Mechanics</h4>
                                    <p style="font-size: 0.9rem; color: var(--gray-dark); margin-bottom: 0.5rem;">
                                        <strong><span class="tooltip multiline" data-tooltip="Priority return of invested capital before common shareholders">Liquidation Preferences</span>:</strong> Series rounds receive their invested capital back first (or multiple thereof), processed in reverse order.
                                    </p>
                                    <p style="font-size: 0.9rem; color: var(--gray-dark); margin-bottom: 0.5rem;">
                                        <strong>Participation:</strong> After all preferences satisfied, remaining proceeds are distributed pro-rata based on ownership.
                                    </p>
                                    <p style="font-size: 0.9rem; color: var(--gray-dark);">
                                        <strong>Non-<span class="tooltip multiline" data-tooltip="Receives preference AND shares in remaining proceeds">Participating</span>:</strong> Must choose between liquidation preference OR participation (takes the higher amount).
                                    </p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },
            
            renderIRRColumn() {
                if (!this.state.results) return '';
                
                return `
                    <th style="padding: 0.75rem; text-align: center;">
                        <span class="tooltip" data-tooltip="Internal Rate of Return - annualized return on investment">IRR</span>
                    </th>
                `;
            },

            renderIRRCell(irrCalc) {
                return `
                    <td style="padding: 0.75rem; text-align: center;">
                        ${irrCalc.irrFormatted}
                        ${irrCalc.reason ? `
                            <span class="tooltip" data-tooltip="${irrCalc.reason}">ⓘ</span>
                        ` : ''}
                    </td>
                `;
            },

            renderValidationLedger() {
                if (!this.state.validationMode.enabled || !this.state.results) {
                    return `
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">📋 Validation Ledger</h2>
                                <button class="btn btn-secondary btn-sm" 
                                        data-action="toggleValidation">
                                    Enable Validation Mode
                                </button>
                            </div>
                            <div class="card-content">
                                <p class="text-muted text-center">
                                    Enable validation mode and run a calculation to see a step-by-step breakdown.
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                const ledger = this.state.validationMode.ledger;
                const reconciliation = this.state.validationMode.reconciliation;
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">📋 Validation Ledger</h2>
                            <div class="header-buttons">
                                <button class="btn btn-secondary btn-sm" 
                                        data-action="exportLedger">
                                    Export CSV
                                </button>
                                <button class="btn btn-secondary btn-sm" 
                                        data-action="toggleValidation">
                                    Disable
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <!-- Reconciliation Status -->
                            <div style="padding: 1rem; background: ${reconciliation.balanced ? 'var(--success)' : 'var(--danger)'}; 
                                        color: white; border-radius: var(--border-radius); margin-bottom: 1.5rem; text-align: center;">
                                <strong style="font-size: 1.1rem;">Reconciliation Status: ${reconciliation.balanced ? '✅ Balanced' : '⚠️ Imbalanced'}</strong>
                                <div style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.9;">
                                    Expected Net Proceeds: <strong>$${this.formatValue(reconciliation.expected)}</strong> | 
                                    Actual Distributed: <strong>$${this.formatValue(reconciliation.actual)}</strong> | 
                                    Delta: <strong>$${this.formatValue(reconciliation.delta)}</strong>
                                </div>
                            </div>
                            
                            <!-- Ledger Table -->
                            <div class="table-scroll-wrapper">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Step</th>
                                            <th>Operation</th>
                                            <th class="text-right">Amount</th>
                                            <th class="text-right">Running Balance</th>
                                            <th>Category</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${ledger.map(entry => `
                                            <tr>
                                                <td class="text-center">${entry.step}</td>
                                                <td>${entry.operation}</td>
                                                <td class="text-right ${entry.amount < 0 ? 'text-danger' : 'text-success'}">
                                                    $${this.formatValue(Math.abs(entry.amount))}
                                                </td>
                                                <td class="text-right">$${this.formatValue(entry.balance)}</td>
                                                <td class="text-center">
                                                    <span style="padding: 0.2rem 0.5rem; font-size: 0.75rem; border-radius: 4px; background: var(--gray-light); color: var(--dark);">
                                                        ${entry.category}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Execution Stats -->
                            <div style="margin-top: 1.5rem; padding: 0.75rem; background: var(--light); 
                                        border-radius: var(--border-radius); font-size: 0.85rem; text-align: center; color: var(--gray-dark);">
                                <strong>Execution Time:</strong> ${reconciliation.executionTime}ms | 
                                <strong>Total Steps:</strong> ${ledger.length}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderScenarioBadge() {
                if (!this.exampleScenarios.currentScenario) return '';
                
                const scenario = this.exampleScenarios[this.exampleScenarios.currentScenario];
                const modified = this.exampleScenarios.currentScenarioModified;
                
                return `
                    <div class="scenario-badge mb-2" style="
                        background: ${modified ? '#fffbe6' : 'var(--primary-light)'};
                        border: 1px solid ${modified ? 'var(--warning)' : 'var(--primary)'};
                        padding: 0.5rem 1rem;
                        border-radius: var(--border-radius);
                        display: inline-block;
                        font-size: 0.9rem;
                    ">
                        <strong>Scenario:</strong> ${scenario.name}
                        ${modified ? `<em style="color: var(--warning); font-weight: bold;"> (Modified)</em>` : ''}
                        ${modified ? `
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="WaterfallCalculator.resetToOriginalScenario()"
                                    style="margin-left: 1rem; padding: 0.25rem 0.75rem;">
                                Reset
                            </button>
                        ` : ''}
                    </div>
                `;
            },
            
            renderScenarioBadgeForCalculator() {
                if (!this.exampleScenarios.currentScenario) return '';
                const scenario = this.exampleScenarios[this.exampleScenarios.currentScenario];
                const modified = this.exampleScenarios.currentScenarioModified;
                return `
                    <div class="scenario-badge text-center mb-3" style="background: ${modified ? '#fffbe6' : 'var(--primary-light)'}; border: 1px solid ${modified ? 'var(--warning)' : 'var(--primary)'}; padding: 0.75rem; border-radius: var(--border-radius); font-size: 0.95rem;">
                        <strong>Scenario Loaded:</strong> ${scenario.name}
                        ${modified ? `<em style="color: var(--warning); font-weight: bold;"> (Modified)</em>` : ''}
                        ${modified ? `<button class="btn btn-sm btn-secondary" onclick="WaterfallCalculator.resetToOriginalScenario()" style="margin-left: 1rem; padding: 0.25rem 0.75rem;">Reset</button>` : ''}
                    </div>
                `;
            },

            resetToOriginalScenario() {
                if (!this.exampleScenarios.currentScenario) return;
                
                const scenarioKey = this.exampleScenarios.currentScenario;
                if (confirm('Are you sure you want to reset to the original scenario values? Your changes will be lost.')) {
                    this.actions.loadExample.call(this, event);
                }
            },

            // Actions
            actions: {
                addRound(e) {
                    const type = e.target.dataset.roundType;
                    if (!type || !WaterfallCalculator.fundingSequence.canAdd(type)) return;
                    
                    const roundDefault = WaterfallCalculator.fundingSequence.roundDefaults[type];
                    const targetOwnership = WaterfallCalculator.getTargetOwnershipForRound(type, WaterfallCalculator.state.rounds);
                    const calculatedShares = WaterfallCalculator.calculateDilutedShares(WaterfallCalculator.state.rounds, type, targetOwnership);
                    
                    const newRound = {
                        ...roundDefault,
                        shares: calculatedShares,
                        id: Date.now()
                    };
                    
                    if (type !== 'founders' && type !== 'optionPool') {
                        const totalSharesAfter = WaterfallCalculator.getTotalShares() + calculatedShares;
                        const impliedValuation = Math.round((totalSharesAfter / calculatedShares) * roundDefault.investment);
                        newRound.valuation = impliedValuation;
                    }
                    
                    WaterfallCalculator.state.rounds.push(newRound);
                    WaterfallCalculator.render();
                    
                    WaterfallCalculator.showNotification(`${roundDefault.name} added with ${targetOwnership}% ownership (${WaterfallCalculator.formatValue(calculatedShares)} shares)`);
                },

                removeRound(e) {
                    const type = e.target.dataset.roundType;
                    if (!type) return;
                    
                    const dependents = WaterfallCalculator.fundingSequence.getDependents(type);
                    
                    if (dependents.length > 0) {
                        const confirmRemove = confirm(
                            `Removing ${WaterfallCalculator.fundingSequence.roundDefaults[type].name} will also remove dependent rounds (${dependents.map(d => WaterfallCalculator.fundingSequence.roundDefaults[d].name).join(', ')}). Continue?`
                        );
                        if (!confirmRemove) return;
                    }
                    
                    WaterfallCalculator.fundingSequence.cascadeRemove(type);
                    WaterfallCalculator.render();
                },
                
                addPayment() {
                    this.state.exitDetails.payments.push({
                        name: 'New Payment',
                        date: this.state.exitDetails.exitDate,
                        percent: 0,
                        isImmediate: true
                    });
                    this.render();
                },

                removePayment(e) {
                    const index = parseInt(e.target.dataset.index, 10);
                    if (this.state.exitDetails.payments.length > 1) {
                        this.state.exitDetails.payments.splice(index, 1);
                        this.render();
                    }
                },

                addSafe(e) {
                    if (WaterfallCalculator.state.safes.length >= 5) {
                        alert('Maximum of 5 SAFE notes allowed');
                        return;
                    }
                    
                    const newSafe = {
                        id: Date.now(),
                        amount: 500000,
                        valuationCap: 5000000,
                        discount: 20,
                        capType: 'pre-money',
                        mfnEnabled: false
                    };
                    WaterfallCalculator.state.safes.push(newSafe);
                    WaterfallCalculator.render();
                },

                removeSafe(e) {
                    const index = parseInt(e.target.dataset.safeIndex);
                    WaterfallCalculator.state.safes.splice(index, 1);
                    WaterfallCalculator.render();
                },

                calculate(e) {
                    this.state.exitDetails.dragAlong.overrideUsed = false;
                    
                    const validationErrors = [];
                    const warnings = [];

                    const hasEquity = this.state.rounds.some(r => r.shares > 0);
                    if (!hasEquity) {
                        validationErrors.push('No equity holders defined. Add at least one round with shares.');
                    }

                    const hasFounders = this.state.rounds.some(r => r.type === 'founders');
                    if (!hasFounders) {
                        warnings.push('No founders equity defined. This is unusual for a startup.');
                    }

                    const totalExpenses = this.calculateTotalExpenses();
                    const { grossValue } = this.state.exitDetails;
                    if (grossValue <= totalExpenses) {
                        warnings.push(`Exit value ($${this.formatValue(grossValue)}) barely covers expenses ($${this.formatValue(totalExpenses)}). Shareholders may receive nothing.`);
                    }

                    const totalRaised = this.safeSum(this.state.rounds.map(r => r.investment || 0)) +
                                       this.safeSum(this.state.safes.map(s => s.amount || 0));
                    if (grossValue < totalRaised * 0.5 && totalRaised > 0) {
                        warnings.push(`Exit value is less than 50% of capital raised. Most investors will lose money.`);
                    }

                    if (validationErrors.length > 0) {
                        alert('Cannot calculate:\n\n' + validationErrors.join('\n'));
                        return;
                    }

                    if (warnings.length > 0) {
                        const proceed = confirm('Warning:\n\n' + warnings.join('\n\n') + '\n\nContinue anyway?');
                        if (!proceed) return;
                    }
                    
                    try {
                        const netProceeds = this.calculateNetProceeds();
                        const grossExit = this.state.exitDetails.grossValue;
                        const escrowInfo = null;
                        
                        const adjustedRounds = this.calculations.calculateAntiDilutionAdjustments(this.calculations.applySplits(this.state.rounds));
                        
                        const waterfallResults = this.calculations.calculateWaterfall(
                            netProceeds, 
                            adjustedRounds, 
                            this.state.safes, 
                            grossExit, 
                            escrowInfo,
                            this.state.exitDetails
                        );
                        
                        let consent = { ok: true, reason: 'User assumed consent.' };
                        if (this.state.exitDetails.dragAlong.consentModel === 'model') {
                            consent = this.checkConsent(this.state, waterfallResults.distributions);
                        }


                        if (!consent.ok) {
                            if (this.state.exitDetails.dragAlong.enabled) {
                                this.state.exitDetails.dragAlong.overrideUsed = true;
                            } else {
                                alert(`Sale Blocked by Shareholders: ${consent.reason}\n\nTo model this scenario, you can enable Drag-Along Rights in the Exit Details section.`);
                                return;
                            }
                        }
                        
                        this.state.results = {
                            grossExit: grossExit,
                            netProceeds: netProceeds,
                            distributions: waterfallResults.distributions,
                            totalDistributed: waterfallResults.totalDistributed,
                            mipAmount: waterfallResults.mipAmount,
                            redemptionNotice: waterfallResults.redemptionNotice,
                            rounds: adjustedRounds,
                            originalRounds: JSON.parse(JSON.stringify(this.state.rounds)),
                            safes: JSON.parse(JSON.stringify(this.state.safes)),
                            exitDetails: JSON.parse(JSON.stringify(this.state.exitDetails)),
                            dragAlongOverride: this.state.exitDetails.dragAlong.overrideUsed,
                            consentDetails: consent
                        };
                        
                        window.location.hash = '#/results';
                    } catch (error) {
                        console.error('Calculation failed:', error);
                        if (!this._loadingExample) {
                            alert('An error occurred during calculation. Please check your inputs.');
                        }
                    }
                },
                
                loadExample(scenarioKey) {
                    const invalidKeys = [null, undefined, '', 'null', 'undefined', false];
                    if (invalidKeys.includes(scenarioKey)) {
                        this.clearScenarioSelection();
                        return;
                    }
                    
                    const scenario = this.exampleScenarios[scenarioKey];
                    if (!scenario || typeof scenario !== 'object') {
                        console.warn(`Invalid scenario key: ${scenarioKey}`);
                        this.clearScenarioSelection();
                        return;
                    }
                    
                    const hasExistingData = this.state.rounds.length > 1 || 
                                            this.state.safes.length > 0;
                    
                    if (hasExistingData && this.exampleScenarios.currentScenario !== scenarioKey) {
                        const userConfirmed = confirm(
                            `Loading "${scenario.name}" will replace your current data.\n\n` +
                            `Current data:\n` +
                            `- ${this.state.rounds.length} funding rounds\n` +
                            `- ${this.state.safes.length} SAFE notes\n\n` +
                            `Continue?`
                        );
                        
                        if (!userConfirmed) {
                            const dropdown = document.getElementById('exampleScenarioSelect');
                            if (dropdown) {
                                dropdown.value = this.exampleScenarios.currentScenario || '';
                            }
                            return;
                        }
                    }
                    
                    this.exampleScenarios.currentScenario = scenarioKey;
                    this.exampleScenarios.currentScenarioModified = false;
                    
                    this.state.rounds = JSON.parse(JSON.stringify(scenario.rounds));
                    this.state.safes = JSON.parse(JSON.stringify(scenario.safes));
                    this.state.exitDetails = JSON.parse(JSON.stringify(scenario.exitDetails));
                    
                    this.state.rounds.forEach(round => {
                        if (!round.id) round.id = Date.now() + Math.random();
                    });
                    this.state.safes.forEach(safe => {
                        if (!safe.id) safe.id = Date.now() + Math.random();
                    });
                    
                    this.state.results = null;
                    this.state.errors = {};
                    this.state.warnings = {};
                    
                    this.render();
                    
                    setTimeout(() => {
                        const descEl = document.getElementById('scenarioDescription');
                        if (descEl) {
                            const descText = descEl.querySelector('p');
                            if (descText) {
                                descText.textContent = scenario.description;
                            }
                            descEl.style.display = 'block';
                            if (this.descriptionTimer) {
                                clearTimeout(this.descriptionTimer);
                                this.descriptionTimer = null;
                            }
                        }
                        
                        const dropdown = document.getElementById('exampleScenarioSelect');
                        if (dropdown) {
                            dropdown.value = scenarioKey;
                        }
                    }, 50);
                    
                    setTimeout(() => {
                        this.validation.validate();
                        
                        if (Object.keys(this.state.errors).length === 0) {
                            try {
                                const event = { preventDefault: () => {} };
                                this._loadingExample = true;
                                this.actions.calculate.call(this, event);
                            } catch (error) {
                                console.warn(`Example scenario "${scenario.name}" loaded but calculation skipped:`, error.message);
                            } finally {
                                this._loadingExample = false;
                            }
                        }
                    }, 150);
                },

                loadScenario(e) {
                    const targetRow = e.target.closest('tr[data-action="loadScenario"]');
                    if (!targetRow) return;

                    const exitValue = parseFloat(targetRow.dataset.exitValue);
                    if (isNaN(exitValue) || exitValue < 0) return;
                    
                    const sourceRounds = WaterfallCalculator.state.results ? WaterfallCalculator.state.results.originalRounds : WaterfallCalculator.state.rounds;
                    const sourceSafes = WaterfallCalculator.state.results ? WaterfallCalculator.state.results.safes : WaterfallCalculator.state.safes;
                    
                    const tempState = {
                        rounds: [...sourceRounds],
                        safes: [...sourceSafes],
                        exitDetails: JSON.parse(JSON.stringify(WaterfallCalculator.state.exitDetails))
                    };
                    tempState.exitDetails.grossValue = exitValue;

                    const calculateTempNetProceeds = () => {
                        const advisorFees = this.safeDivide(tempState.exitDetails.grossValue * tempState.exitDetails.advisorFeePercent, 100);
                        
                        const totalExpenses = tempState.exitDetails.debt + tempState.exitDetails.legalFees + advisorFees + (tempState.exitDetails.otherExpenses || 0);
                        
                        let net = tempState.exitDetails.grossValue - totalExpenses;
                        if (tempState.exitDetails.managementCarveout.enabled && net > 0) {
                            net -= this.safeDivide(net * tempState.exitDetails.managementCarveout.percent, 100);
                        }
                        return Math.max(0, net);
                    };
                    
                    const netProceeds = calculateTempNetProceeds();
                    
                    const adjustedRounds = this.calculations.calculateAntiDilutionAdjustments(tempState.rounds);

                    const waterfallResults = this.calculations.calculateWaterfall(
                        netProceeds,
                        adjustedRounds,
                        tempState.safes,
                        exitValue,
                        null,
                        tempState.exitDetails
                    );
                    
                    WaterfallCalculator.state.exitDetails.grossValue = exitValue;
                    WaterfallCalculator.state.results = {
                        grossExit: exitValue,
                        netProceeds: netProceeds,
                        distributions: waterfallResults.distributions,
                        totalDistributed: waterfallResults.totalDistributed,
                        mipAmount: waterfallResults.mipAmount, 
                        redemptionNotice: waterfallResults.redemptionNotice, 
                        rounds: adjustedRounds,
                        originalRounds: JSON.parse(JSON.stringify(sourceRounds)),
                        safes: [...sourceSafes],
                        exitDetails: JSON.parse(JSON.stringify(tempState.exitDetails)),
                        dragAlongOverride: false,
                        consentDetails: { ok: true }
                    };
                    
                    window.location.hash = '#/results';
                },
                
                runSensitivity() {
                    const minExit = this.formatValue(document.querySelector('[data-field="sensitivity.minExit"]').value, { mode: 'parse' });
                    const maxExit = this.formatValue(document.querySelector('[data-field="sensitivity.maxExit"]').value, { mode: 'parse' });
                    const stepCount = parseInt(document.querySelector('[data-field="sensitivity.stepCount"]').value, 10);

                    delete this.state.errors['sensitivity.minExit'];
                    delete this.state.errors['sensitivity.maxExit'];

                    let hasError = false;
                    if (minExit <= 0) {
                        this.state.errors['sensitivity.minExit'] = "Min exit must be positive.";
                        hasError = true;
                    }
                    if (maxExit <= minExit) {
                        this.state.errors['sensitivity.maxExit'] = "Max exit must be greater than min exit.";
                        hasError = true;
                    }
                    if (stepCount < 2 || stepCount > 50) {
                        this.state.errors['sensitivity.stepCount'] = "Steps must be between 2 and 50.";
                        hasError = true;
                    }
                    
                    if (hasError) {
                        this.render();
                        return;
                    }

                    this.state.sensitivity.minExit = minExit;
                    this.state.sensitivity.maxExit = maxExit;
                    this.state.sensitivity.stepCount = stepCount;
                    
                    this.render();
                },

                downloadSensitivityChart() {
                    const chartInstance = this.charts.instances.sensitivity;
                    if (!chartInstance) {
                        alert("Chart not available for download.");
                        return;
                    }
                    const a = document.createElement('a');
                    a.href = chartInstance.toBase64Image();
                    a.download = 'sensitivity-chart.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },

                exportSensitivityCSV() {
                    const { minExit, maxExit, stepCount } = this.state.sensitivity;
                    const stepSize = stepCount > 1 ? (maxExit - minExit) / (stepCount - 1) : 0;
                    const scenarios = this.sensitivity.calculateScenarios(minExit, maxExit, stepSize);
                    
                    const csvContent = this.sensitivity.generateCSV(scenarios);
                    if (!csvContent) {
                        alert("No data available to export.");
                        return;
                    }

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'sensitivity-analysis.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },

                toggleValidation(e) {
                    e.preventDefault();
                    this.state.validationMode.enabled = !this.state.validationMode.enabled;
                    
                    if (this.state.validationMode.enabled) {
                        if (this.state.results) {
                            const event = { preventDefault: () => {} };
                            this.actions.calculate.call(this, event);
                            if (this.state.validationMode.ledger && this.state.validationMode.ledger.length > 0) {
                                this.switchTab('ledger');
                            }
                        } else {
                            alert('Validation mode enabled. Run a calculation to see the ledger.');
                        }
                    } else {
                        this.state.validationMode.ledger = [];
                        this.state.validationMode.reconciliation = {
                            expected: 0, actual: 0, delta: 0, balanced: false, executionTime: 0
                        };
                    }
                    this.render();
                },
                
                exportLedger(e) {
                    e.preventDefault();
                    
                    const ledger = this.state.validationMode.ledger;
                    if (!ledger || ledger.length === 0) {
                        alert('No ledger data to export. Run a calculation with validation mode enabled.');
                        return;
                    }
                    
                    const headers = ['Step', 'Operation', 'Amount', 'Balance', 'Category', 'Details'];
                    const rows = ledger.map(entry => {
                        const operation = entry.operation.replace(/"/g, '""');
                        const details = JSON.stringify(entry.details || {}).replace(/"/g, '""');
                        
                        return [
                            entry.step,
                            `"${operation}"`,
                            entry.amount.toFixed(2),
                            entry.balance.toFixed(2),
                            entry.category,
                            `"${details}"`
                        ];
                    });
                    
                    const reconciliation = this.state.validationMode.reconciliation;
                    rows.push([]);
                    rows.push(['RECONCILIATION SUMMARY']);
                    rows.push(['Expected Net Proceeds', '', reconciliation.expected.toFixed(2)]);
                    rows.push(['Actual Distributed', '', reconciliation.actual.toFixed(2)]);
                    rows.push(['Delta', '', reconciliation.delta.toFixed(2)]);
                    rows.push(['Status', '', reconciliation.balanced ? 'BALANCED' : 'IMBALANCED']);
                    rows.push(['Execution Time (ms)', '', reconciliation.executionTime]);
                    
                    const csv = [
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n');
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `waterfall-validation-ledger-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showNotification('Ledger exported successfully');
                }
            },

            clearScenarioSelection() {
                this.exampleScenarios.currentScenario = null;
                this.exampleScenarios.currentScenarioModified = false;
                
                const descEl = document.getElementById('scenarioDescription');
                if (descEl) {
                    descEl.style.display = 'none';
                }
                
                const dropdown = document.getElementById('exampleScenarioSelect');
                if (dropdown) {
                    dropdown.value = '';
                }
            },

            showScenarioDescription(description) {
                const descriptionEl = document.getElementById('scenarioDescription');
                if (descriptionEl) {
                    const p = descriptionEl.querySelector('p');
                    if (p) {
                        p.textContent = description;
                        descriptionEl.style.display = 'block';
                    }
                }
            },

            checkConsent(state, distributions) {
                const commonHolders = distributions.filter(d => d.isCommon);
                const preferredHolders = distributions.filter(d => !d.isCommon && d.invested > 0);
                
                const commonVotes = this.calculateClassVotes(
                    commonHolders.filter(d => d.totalProceeds > 0),
                    commonHolders
                );
                const preferredVotes = this.calculateClassVotes(
                    preferredHolders.filter(d => d.totalProceeds > 0),
                    preferredHolders
                );
                
                const commonMet = commonVotes >= state.exitDetails.dragAlong.commonThreshold;
                const preferredMet = preferredVotes >= state.exitDetails.dragAlong.preferredThreshold;
                
                const result = {
                    commonVotes: commonVotes.toFixed(1),
                    preferredVotes: preferredVotes.toFixed(1)
                };

                if (commonMet && preferredMet) {
                    result.ok = true;
                    return result;
                }
                
                result.ok = false;
                result.reason = `Consent thresholds not met: Common ${result.commonVotes}% of ${state.exitDetails.dragAlong.commonThreshold}% required, Preferred ${result.preferredVotes}% of ${state.exitDetails.dragAlong.preferredThreshold}% required.`;
                return result;
            },

            calculateClassVotes(consentingHolders, allHoldersInClass) {
                if (!allHoldersInClass || allHoldersInClass.length === 0) return 100;
                
                const totalClassShares = this.safeSum(allHoldersInClass.map(h => h.shares));
                if (totalClassShares <= 0) return 100;

                const consentingShares = this.safeSum(consentingHolders.map(h => h.shares));
                
                return this.safeDivide(consentingShares * 100, totalClassShares);
            },

            // Calculations
            calculations: {
                // Date and PV helpers
                addMonths(dateStr, months) {
                    try {
                        const date = new Date(dateStr);
                        date.setUTCMonth(date.getUTCMonth() + months);
                        return date.toISOString().split('T')[0];
                    } catch (e) {
                        return '';
                    }
                },
                yearFraction(startDate, endDate) {
                    if (!startDate || !endDate) return 0;
                    try {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;
                        const diff = end.getTime() - start.getTime();
                        if (diff < 0) return 0;
                        return diff / (1000 * 60 * 60 * 24 * 365.25);
                    } catch (e) {
                        return 0;
                    }
                },
                accruedDiv(r, exitDate) {
                  if (!r.dividend?.enabled || !r.dividend.ratePct || !r.dividend.issuedOn) return 0;
                  const years = this.yearFraction(r.dividend.issuedOn, exitDate);
                  return (r.investment || 0) * (r.dividend.ratePct / 100) * years;
                },
                accruedPrefInterest(r, exitDate) {
                  if (!r.prefInterest?.enabled || !r.prefInterest.ratePct || !r.prefInterest?.startISO) return 0;
                  const years = this.yearFraction(r.prefInterest.startISO, exitDate);
                  return (r.investment || 0) * (r.prefInterest.ratePct / 100) * years;
                },
                calculatePV(futureValue, yearsFromNow, discountRate) {
                    if (!discountRate || discountRate <= 0 || yearsFromNow <= 0) return futureValue;
                    return futureValue / Math.pow(1 + (discountRate / 100), yearsFromNow);
                },
                
                // Share and equity calculations
                applySplits(rounds) {
                    return rounds.map(r => {
                        const ratio = r.splitRatio || 1;
                        const base = (typeof r.baseShares === 'number') ? r.baseShares : (r.shares || 0);
                        const splitShares = base * ratio;
                        return {
                            ...r,
                            baseShares: base,
                            shares: splitShares,
                            wasSplit: ratio !== 1,
                            _splitFactor: ratio
                        };
                    });
                },

                calculateAntiDilutionAdjustments(rounds) {
                    let adjustedRounds = JSON.parse(JSON.stringify(rounds));
                    const roundOrder = ['seed', 'seriesA', 'seriesB', 'seriesC'];

                    adjustedRounds = adjustedRounds.map(r => {
                        if (r.payToPlay?.enabled && !r.payToPlay?.participated) {
                            const penalizedRound = { ...r, antiDilution: 'none' };
                            penalizedRound.adjustmentReason = (penalizedRound.adjustmentReason || '') + ' Pay-to-play triggered; anti-dilution rights removed.';
                            return penalizedRound;
                        }
                        return r;
                    });
                    
                    const roundsMap = {};
                    adjustedRounds.forEach(r => { roundsMap[r.type] = r; });
                    
                    if (!roundsMap.founders) return adjustedRounds;
                    
                    let cumulativeShares = roundsMap.founders.shares || 0;
                    const prices = {};
                    
                    for (const type of roundOrder) {
                        const round = roundsMap[type];
                        if (round && round.investment > 0) {
                            const preMoney = round.valuation - round.investment;
                            prices[type] = cumulativeShares > 0 ? WaterfallCalculator.safeDivide(preMoney, cumulativeShares) : 0;
                            cumulativeShares += round.shares;
                        }
                    }
                    
                    for (let i = 0; i < roundOrder.length - 1; i++) {
                        const protectedType = roundOrder[i];
                        const protectedRound = roundsMap[protectedType];
                        
                        if (!protectedRound || protectedRound.antiDilution === 'none' || !isFinite(prices[protectedType])) {
                            continue;
                        }
                        
                        const OCP = prices[protectedType];
                        
                        for (let j = i + 1; j < roundOrder.length; j++) {
                            const downRoundType = roundOrder[j];
                            const downRound = roundsMap[downRoundType];
                            
                            if (!downRound || !isFinite(prices[downRoundType])) continue;
                            
                            const NIP = prices[downRoundType];
                            
                            if (NIP < OCP) {
                                let NCP = OCP;
                                let adjustmentReason = '';

                                if (protectedRound.antiDilution === 'fullRatchet') {
                                    NCP = NIP;
                                    adjustmentReason = `Full-ratchet anti-dilution triggered by ${downRound.name}: Conversion price adjusted to $${NIP.toFixed(2)}.`;
                                } 
                                else if (protectedRound.antiDilution === 'weightedAverage') {
                                    let A = 0;
                                    const baseRounds = ['founders'];
                                    for (let k = 0; k < j; k++) { baseRounds.push(roundOrder[k]); }

                                    A = WaterfallCalculator.safeSum(
                                        Array.from(new Set(baseRounds))
                                            .map(type => roundsMap[type]?.shares || 0)
                                    );
                                    
                                    const waBase = protectedRound.antiDilutionBase || 'broad';
                                    if (waBase === 'broad' && roundsMap.optionPool) {
                                        A += roundsMap.optionPool.shares || 0;
                                    }

                                    const B = WaterfallCalculator.safeDivide(downRound.investment, OCP); 
                                    const C = downRound.shares; 
                                    
                                    NCP = OCP * (WaterfallCalculator.safeDivide((A + B), (A + C)));
                                    adjustmentReason = `${waBase.charAt(0).toUpperCase() + waBase.slice(1)}-based WA anti-dilution triggered by ${downRound.name}: Price from $${OCP.toFixed(2)} to $${NCP.toFixed(2)}.`;
                                }

                                if (isFinite(NCP) && NCP > 0 && NCP < OCP) {
                                    const originalShares = protectedRound.shares;
                                    const newShares = WaterfallCalculator.roundToWholeShares(WaterfallCalculator.safeDivide(protectedRound.investment, NCP));
                                    
                                    protectedRound.originalShares = originalShares;
                                    protectedRound.shares = newShares;
                                    protectedRound.adjusted = true;
                                    protectedRound.adjustmentReason = (protectedRound.adjustmentReason || '') + ' ' + adjustmentReason + ` Adjusted shares from ${WaterfallCalculator.formatValue(originalShares)} to ${WaterfallCalculator.formatValue(newShares)}`;
                                    
                                    break;
                                }
                            }
                        }
                    }
                    
                    return adjustedRounds;
                },

                convertAllSafes(safes, exitValue, rounds) {
				  if (!safes || safes.length === 0) return [];
				
				  const preMoneyShares = WaterfallCalculator.safeSum(
				    rounds.filter(r => r.type !== 'safes').map(r => r.shares)
				  );
				  if (preMoneyShares <= 0) {
				    return safes.map(s => ({ ...s, shares: 0, error: 'No existing equity' }));
				  }
				
				  const liquidityPrice = WaterfallCalculator.safeDivide(exitValue, preMoneyShares);
				
				  const prepared = safes.map((s, idx) => ({
				    ...s,
				    idx,
				    capType: s.capType || 'pre-money',
				    amount: Number(s.amount) || 0,
				    valuationCap: Number(s.valuationCap) || 0,
				    discount: Number(s.discount) || 0,
				  }));
				
				  const discountPriceOf = (s) =>
				    s.discount > 0 ? liquidityPrice * (1 - s.discount / 100) : Infinity;
				
				  const preCapPriceOf = (s) =>
				    s.valuationCap > 0
				      ? WaterfallCalculator.safeDivide(s.valuationCap, preMoneyShares)
				      : Infinity;
				
				  const denomForPMSet = (pmSet) => {
				    const S = pmSet.reduce(
				      (sum, s) => sum + WaterfallCalculator.safeDivide(s.amount, s.valuationCap || Infinity),
				      0
				    );
				    if (!isFinite(S) || S >= 0.999999) return Infinity;
				    return preMoneyShares / (1 - S);
				  };
				
				  let pmSet = prepared.filter(s => s.capType === 'post-money' && s.valuationCap > 0);
				
				  let changed = true;
				  while (changed && pmSet.length > 0) {
				    changed = false;
				    const D = denomForPMSet(pmSet);
				
				    const toDrop = [];
				    for (const s of pmSet) {
				      const pmCapPrice = isFinite(D) ? WaterfallCalculator.safeDivide(s.valuationCap, D) : Infinity;
				      const bestNonPM = Math.min(discountPriceOf(s), liquidityPrice, preCapPriceOf(s));
				      if (bestNonPM < pmCapPrice) {
				        toDrop.push(s.idx);
				      }
				    }
				    if (toDrop.length) {
				      pmSet = pmSet.filter(s => !toDrop.includes(s.idx));
				      changed = true;
				    }
				  }
				
				  const finalD = denomForPMSet(pmSet);
				
				  const preliminary = prepared.map(s => {
				    const options = [];
				
				    options.push({ price: liquidityPrice, mechanism: 'liquidity price' });
				
				    const disc = discountPriceOf(s);
				    if (isFinite(disc) && disc > 0) {
				      options.push({ price: disc, mechanism: 'discount' });
				    }
				
				    if (s.valuationCap > 0) {
				      if (s.capType === 'pre-money') {
				        const preCap = preCapPriceOf(s);
				        if (isFinite(preCap) && preCap > 0) {
				          options.push({ price: preCap, mechanism: 'cap (pre-money)' });
				        }
				      } else {
				        const pmCap = isFinite(finalD)
				          ? WaterfallCalculator.safeDivide(s.valuationCap, finalD)
				          : Infinity;
				        if (isFinite(pmCap) && pmCap > 0) {
				          options.push({ price: pmCap, mechanism: 'cap (post-money)' });
				        }
				      }
				    }
				
				    const valid = options.filter(o => isFinite(o.price) && o.price > 0);
				    const best = valid.length
				      ? valid.reduce((a, b) => (a.price <= b.price ? a : b))
				      : { price: Infinity, mechanism: 'none' };
				
				    const capPrice =
				      s.capType === 'post-money'
				        ? (isFinite(finalD) ? WaterfallCalculator.safeDivide(s.valuationCap, finalD) : Infinity)
				        : preCapPriceOf(s);
				
				    return {
				      ...s,
				      capPrice,
				      discountPrice: disc,
				      liquidityPrice,
				      initialPrice: best.price,
				      initialMechanism: best.mechanism
				    };
				  });
				
				  const globalBestPrice = Math.min(
				    ...preliminary.map(p => p.initialPrice).filter(p => isFinite(p) && p > 0)
				  );
				
				  return preliminary.map(p => {
				    let finalPrice = p.initialPrice;
				    let finalMechanism = p.initialMechanism;
				
				    if (p.mfnEnabled && isFinite(globalBestPrice) && globalBestPrice < finalPrice) {
				      finalPrice = globalBestPrice;
				      finalMechanism = 'MFN';
				    }
				
				    if (!isFinite(finalPrice) || finalPrice <= 0) {
				      return { ...p, shares: 0, conversionPrice: 0, mechanism: 'none', error: 'Invalid conversion price' };
				    }
				
				    const shares = WaterfallCalculator.roundToWholeShares(
				      WaterfallCalculator.safeDivide(p.amount, finalPrice)
				    );
				
				    return {
				      ...p,
				      shares,
				      conversionPrice: finalPrice,
				      mechanism: finalMechanism,
				      error: null
				    };
				  });
				},
                
                calculateDilution(rounds, convertedSafes) {
                    const results = [];
                    
                    const preConversionShares = WaterfallCalculator.safeSum(rounds.filter(r => r.type !== 'safes').map(r => r.shares));
                    
                    const safeShares = WaterfallCalculator.safeSum(convertedSafes.map(s => s.shares));
                    const postConversionShares = preConversionShares + safeShares;
                    
                    if (preConversionShares <= 0) {
                        rounds.filter(r => r.type !== 'safes').forEach(round => {
                             results.push({ name: round.name, type: round.type, preOwnership: 0, postOwnership: 0, dilution: 0, dilutionPercent: 0 });
                        });
                        if (safeShares > 0) {
                            results.push({ name: 'Converted SAFEs', type: 'safes', preOwnership: 0, postOwnership: 100, dilution: 0, dilutionPercent: 0 });
                        }
                        return results;
                    }
                    
                    rounds.forEach(round => {
                        if (round.type !== 'safes' && round.shares > 0) {
                            const preOwnership = WaterfallCalculator.safeCalculateOwnership(round.shares, preConversionShares);
                            const postOwnership = WaterfallCalculator.safeCalculateOwnership(round.shares, postConversionShares);
                            const dilution = preOwnership - postOwnership;
                            
                            results.push({
                                name: round.name,
                                type: round.type,
                                shares: round.shares,
                                preOwnership: preOwnership,
                                postOwnership: postOwnership,
                                dilution: dilution,
                                dilutionPercent: preOwnership > 0 ? WaterfallCalculator.safeDivide(dilution * 100, preOwnership) : 0
                            });
                        }
                    });
                    
                    if (safeShares > 0) {
                        results.push({
                            name: 'Converted SAFEs',
                            type: 'safes',
                            shares: safeShares,
                            preOwnership: 0,
                            postOwnership: WaterfallCalculator.safeCalculateOwnership(safeShares, postConversionShares),
                            dilution: 0,
                            dilutionPercent: 0
                        });
                    }
                    
                    return results;
                },
                
                calculateWaterfall(netProceeds, rounds, safes, grossExit, escrowInfo, exitDetails) {
                    WaterfallCalculator.ledgerSystem.initLedger();
                    let balance = grossExit;
                    WaterfallCalculator.ledgerSystem.record('Gross Exit Value', grossExit, balance);

                    const debt = exitDetails.debt || 0;
                    if (debt > 0) {
                        balance -= debt;
                        WaterfallCalculator.ledgerSystem.record('Expense: Outstanding Debt', -debt, balance);
                    }
                    const legalFees = exitDetails.legalFees || 0;
                    if (legalFees > 0) {
                        balance -= legalFees;
                        WaterfallCalculator.ledgerSystem.record('Expense: Legal & Closing Fees', -legalFees, balance);
                    }
                    const otherExpenses = exitDetails.otherExpenses || 0;
                     if (otherExpenses > 0) {
                        balance -= otherExpenses;
                        WaterfallCalculator.ledgerSystem.record('Expense: Other', -otherExpenses, balance);
                    }
                    const advisorFees = WaterfallCalculator.calculateAdvisorFees(grossExit);
                    if (advisorFees > 0) {
                        balance -= advisorFees;
                        WaterfallCalculator.ledgerSystem.record(`Expense: Advisor Fees (${exitDetails.advisorFeePercent}%)`, -advisorFees, balance);
                    }
                    const carveout = WaterfallCalculator.calculateManagementCarveout(grossExit);
                    if (carveout > 0) {
                        balance -= carveout;
                        WaterfallCalculator.ledgerSystem.record(`Allocation: Management Carve-out (${exitDetails.managementCarveout.percent}%)`, -carveout, balance);
                    }

                    let redemptionNotice = false; 

                    // Always work from split-applied rounds so downstream math is consistent
                    const roundsWithSplits = WaterfallCalculator.calculations.applySplits(rounds);
                    if (netProceeds <= 0) {
                        const allStakeholders = rounds.filter(r => r.type !== 'safes');
                        if (safes.length > 0) {
                            allStakeholders.push({ name: 'Converted SAFEs', type: 'safes', investment: WaterfallCalculator.safeSum(safes.map(s => s.amount)) });
                        }
                        
                        const result = {
                            distributions: allStakeholders.map(r => ({
                                name: r.name, type: r.type, invested: r.investment || 0,
                                liquidationPref: 0, participation: 0, totalProceeds: 0,
                                shares: r.shares || 0, moic: 0,
                                returnPercent: (r.investment || 0) > 0 ? -100 : 0,
                                isCommon: r.isCommon
                            })),
                            totalDistributed: 0, remaining: 0, mipAmount: 0, redemptionNotice: false
                        };
                        WaterfallCalculator.ledgerSystem.finalizeLedger(result.totalDistributed, netProceeds);
                        return result;
                    }
                    
                    const convertedSafes = this.convertAllSafes(safes, grossExit, roundsWithSplits);
                    
                    const allStakeholders = JSON.parse(JSON.stringify(roundsWithSplits.filter(r => r.type !== 'safes')));
                    if (safes.length > 0) {
                        const totalSafeInvestment = WaterfallCalculator.safeSum(safes.map(s => s.amount));
                        const totalSafeShares = WaterfallCalculator.safeSum(convertedSafes.map(s => s.shares));
                        allStakeholders.push({
                            name: 'Converted SAFEs', type: 'safes', investment: totalSafeInvestment,
                            shares: totalSafeShares, liquidationPref: 0, participating: true, isCommon: true
                        });
                    }

                    const optionPoolOriginalShares = roundsWithSplits.find(r => r.type === 'optionPool')?.shares || 0;
                    const optionPool = allStakeholders.find(stakeholder => stakeholder.type === 'optionPool');
                    if (optionPool) {
                        optionPool.shares = 0;
                    }
                    
                    let distributions = {};
                    allStakeholders.forEach(s => {
                         distributions[s.type] = {
                            name: s.name, type: s.type, invested: s.investment || 0,
                            shares: s.shares || 0,
                            liquidationPref: 0, participation: 0,
                            totalProceeds: 0, participating: s.participating, isCommon: s.isCommon,
                            warrantShares: 0
                        };
                    });

                    allStakeholders.forEach(stakeholder => {
                        if (stakeholder.payToPlay?.enabled && !stakeholder.payToPlay?.participated) {
                            stakeholder.liquidationPref = 0;
                            if (stakeholder.dividend) stakeholder.dividend.enabled = false;
                            if (stakeholder.prefInterest) stakeholder.prefInterest.enabled = false;
                            stakeholder.isCommon = true;
                            stakeholder.participating = true;
                            const dist = distributions[stakeholder.type];
                            if (dist) {
                                dist.penaltyReason = 'Pay-to-play triggered: Converted to common stock, losing liquidation preference and dividend rights.';
                            }
                        }
                    });

                    let remainingProceeds = netProceeds;
                    
                    const prefRounds = allStakeholders.filter(r => (r.liquidationPref > 0 && r.investment > 0) || r.dividend?.enabled || r.prefInterest?.enabled || r.redemption?.enabled);
                    const seniorityGroups = prefRounds.reduce((groups, round) => {
                        const level = round.seniority || 2;
                        if (!groups[level]) groups[level] = [];
                        groups[level].push(round);
                        return groups;
                    }, {});

                    const sortedLevels = Object.keys(seniorityGroups).map(Number).sort((a,b) => a - b);

                    for(const level of sortedLevels) {
                        if (remainingProceeds <= 0) break;
                        
                        const group = seniorityGroups[level];

                        const totalClaimInGroup = WaterfallCalculator.safeSum(group.map(r => {
                            const preferenceClaim = (r.investment * r.liquidationPref) + this.accruedDiv(r, exitDetails.exitDate) + this.accruedPrefInterest(r, exitDetails.exitDate);
                            const isEligible = r.redemption?.enabled && r.redemption.startISO && new Date(exitDetails.exitDate) >= new Date(r.redemption.startISO);
                            const redemptionFloor = isEligible ? (r.investment || 0) * (r.redemption.multiple || 1) : 0;
                            return Math.max(preferenceClaim, redemptionFloor);
                        }));

                        if (remainingProceeds >= totalClaimInGroup) {
                            group.forEach(round => {
                                const preferenceClaim = (round.investment * round.liquidationPref) + this.accruedDiv(round, exitDetails.exitDate) + this.accruedPrefInterest(round, exitDetails.exitDate);
                                const isEligible = round.redemption?.enabled && round.redemption.startISO && new Date(exitDetails.exitDate) >= new Date(round.redemption.startISO);
                                const redemptionFloor = (round.redemption?.enabled ? (round.redemption.multiple || 1) * (round.investment || 0) : 0);
                                const finalClaim = Math.max(preferenceClaim, redemptionFloor);
                                
                                if (isEligible && redemptionFloor > preferenceClaim) {
                                    distributions[round.type].payoutReason = 'Redemption';
                                    distributions[round.type].redemptionFloor = redemptionFloor;
                                    redemptionNotice = true;
                                }

                                distributions[round.type].liquidationPref += finalClaim;
                                remainingProceeds -= finalClaim;
                                WaterfallCalculator.ledgerSystem.record(`${round.name} - Liquidation Preference`, -finalClaim, remainingProceeds, { seniority: level });
                            });
                        } else {
                             group.forEach(round => {
                                const preferenceClaim = (round.investment * round.liquidationPref) + this.accruedDiv(round, exitDetails.exitDate) + this.accruedPrefInterest(round, exitDetails.exitDate);
                                const isEligible = round.redemption?.enabled && round.redemption.startISO && new Date(exitDetails.exitDate) >= new Date(round.redemption.startISO);
                                const redemptionFloor = (round.redemption?.enabled ? (round.redemption.multiple || 1) * (round.investment || 0) : 0);
                                const roundClaim = Math.max(preferenceClaim, redemptionFloor);
                                
                                const proRataShare = WaterfallCalculator.safeDivide(roundClaim, totalClaimInGroup) * remainingProceeds;
                                distributions[round.type].liquidationPref += proRataShare;
                                WaterfallCalculator.ledgerSystem.record(`${round.name} - Liquidation Preference (Pro-Rata)`, -proRataShare, remainingProceeds - proRataShare, { seniority: level });
                            });
                            remainingProceeds = 0;
                        }
                    }

                    let mipAmount = 0;
                    if (exitDetails.mip?.enabled && exitDetails.mip.percent > 0 && remainingProceeds > 0) {
                        mipAmount = remainingProceeds * (exitDetails.mip.percent / 100);
                        remainingProceeds -= mipAmount;
                        WaterfallCalculator.ledgerSystem.record(`Allocation: MIP (${exitDetails.mip.percent}%)`, -mipAmount, remainingProceeds);
                    }

                    if (remainingProceeds > 0) {
                        let participatingShares = 0;
                        const undecidedNPs = [];
                        
                        allStakeholders.forEach(stakeholder => {
                             const dist = distributions[stakeholder.type];
                            if (!dist || stakeholder.type === 'optionPool') return;
                            
                             if (dist.payoutReason === 'Redemption') {
                                dist.isParticipating = false;
                                return;
                            }

                            if (stakeholder.isCommon === true || stakeholder.participating === true) {
                                participatingShares += stakeholder.shares || 0;
                                dist.isParticipating = true;
                            } 
                            else if (dist.liquidationPref > 0 && !stakeholder.participating) {
                                undecidedNPs.push(stakeholder);
                                dist.isParticipating = false;
                            }
                        });

                        const perShareValueAfterPrefs = participatingShares > 0 ? WaterfallCalculator.safeDivide(remainingProceeds, participatingShares) : 0;

                        allStakeholders.forEach(r => {
                            const dist = distributions[r.type];
                            if (!dist || !r.warrant?.enabled || r.investment <= 0) return;
                            const splitFactor = r._splitFactor || 1;
                            const effStrike = (r.warrant.strike || 0) / splitFactor;
                            if (effStrike >= perShareValueAfterPrefs) return; // underwater
                            const covered = r.investment * (r.warrant.coveragePct / 100);
                            const cashShares = this.safeDivide(covered, effStrike); // baseline if cash exercise
                            if (cashShares <= 0) return;
                            // Net exercise delivered shares = N * (P - K) / P
                            const netFactor = Math.max(0, (perShareValueAfterPrefs - effStrike) / perShareValueAfterPrefs);
                            const grantShares = Math.floor(cashShares * netFactor);
                            if (grantShares > 0) {
                                dist.warrantShares = (dist.warrantShares || 0) + grantShares;
                                dist.shares += grantShares;
                                participatingShares += grantShares;
                                dist.warrantExercise = 'net';
                            }
                        });

                        let changedInLastPass = true;
                        while (changedInLastPass) {
                            changedInLastPass = false;

                            for (let i = undecidedNPs.length - 1; i >= 0; i--) {
                                const stakeholder = undecidedNPs[i];
                                const dist = distributions[stakeholder.type];
                                const prefDue = dist.liquidationPref;
                                const poolIfConvert = remainingProceeds + prefDue;
                                const sharesIfConvert = participatingShares + stakeholder.shares;
                                const valueIfConvert = sharesIfConvert > 0 ? WaterfallCalculator.safeDivide(poolIfConvert * stakeholder.shares, sharesIfConvert) : 0;

                                if (valueIfConvert > prefDue) {
                                    dist.choiceReason = `Converted to common: $${WaterfallCalculator.formatValue(Math.round(valueIfConvert))} > $${WaterfallCalculator.formatValue(Math.round(prefDue))} preference`;
                                    dist.isParticipating = true;
                                    remainingProceeds += prefDue;
                                    WaterfallCalculator.ledgerSystem.record(`${stakeholder.name} - Preference Forfeited`, prefDue, remainingProceeds, { reason: 'Conversion to Common' });
                                    dist.liquidationPref = 0;
                                    participatingShares += stakeholder.shares;
                                    undecidedNPs.splice(i, 1);
                                    changedInLastPass = true;
                                }
                            }
                        }

                        undecidedNPs.forEach(stakeholder => {
                            const dist = distributions[stakeholder.type];
                            const prefDue = dist.liquidationPref;
                            const poolIfConvert = remainingProceeds + prefDue;
                            const sharesIfConvert = participatingShares + stakeholder.shares;
                            const valueIfConvert = sharesIfConvert > 0 ? WaterfallCalculator.safeDivide(poolIfConvert * stakeholder.shares, sharesIfConvert) : 0;
                            dist.choiceReason = `Kept preference: $${WaterfallCalculator.formatValue(Math.round(prefDue))} >= $${WaterfallCalculator.formatValue(Math.round(valueIfConvert))} common`;
                        });

                        if (optionPool && optionPool.poolDetails) {
                            const currentPerShareValue = participatingShares > 0 ? WaterfallCalculator.safeDivide(remainingProceeds, participatingShares) : 0;
                            const opSplit = optionPool._splitFactor || 1;
                            const strikeRaw = optionPool.poolDetails.strikePrice || 0;
                            const strike = strikeRaw / opSplit;
                            if (strike >= currentPerShareValue) {
                                optionPool.shares = 0;
                                distributions['optionPool'].shares = 0;
                                optionPool.underwater = true;
                                distributions['optionPool'].choiceReason = `Options underwater: strike ($${strike.toFixed(2)}) >= common value ($${currentPerShareValue.toFixed(2)})`;
                            } else {
                                const { vestedPercent = 100, exercisedPercent = 100 } = optionPool.poolDetails;
                                const gross = optionPoolOriginalShares * (vestedPercent / 100) * (exercisedPercent / 100);
                                // Net exercise delivered shares = N * (P - K) / P
                                const netFactor = Math.max(0, (currentPerShareValue - strike) / currentPerShareValue);
                                const deliver = Math.floor(gross * netFactor);
                                optionPool.shares = deliver;
                                distributions['optionPool'].shares = deliver;
                                optionPool.underwater = false;
                                distributions['optionPool'].isParticipating = deliver > 0;
                                distributions['optionPool'].optionExercise = 'net';
                                if (deliver > 0) participatingShares += deliver;
                            }
                        }

                        if (participatingShares > 0 && remainingProceeds > 0) {
                            let currentParticipants = allStakeholders.filter(s => distributions[s.type]?.isParticipating);
                            let currentTotalShares = participatingShares;

                            while(remainingProceeds > 0.01 && currentTotalShares > 0) {
                                const perShareValue = WaterfallCalculator.safeDivide(remainingProceeds, currentTotalShares);
                                let limitedAllocation = Infinity;
                                let cappedThisRound = false;

                                currentParticipants.forEach(p => {
                                    const cap = p.participationCap;
                                    if (cap > 0 && p.investment > 0) {
                                        const dist = distributions[p.type];
                                        const capTotal = p.investment * cap;
                                        const receivedSoFar = dist.liquidationPref + dist.participation;
                                        const capRoom = Math.max(0, capTotal - receivedSoFar);
                                        
                                        if (dist.shares > 0) {
                                            const perShareCapRoom = WaterfallCalculator.safeDivide(capRoom, dist.shares);
                                            limitedAllocation = Math.min(limitedAllocation, perShareCapRoom);
                                        }
                                    }
                                });

                                const allocationPerShare = Math.min(perShareValue, limitedAllocation);
                                const nextRoundParticipants = [];
                                
                                currentParticipants.forEach(p => {
                                    const dist = distributions[p.type];
                                    const allocation = dist.shares * allocationPerShare;
                                    
                                    dist.participation += allocation;
                                    remainingProceeds -= allocation;
                                    WaterfallCalculator.ledgerSystem.record(`${dist.name} - Participation`, -allocation, remainingProceeds, { shares: dist.shares, pps: allocationPerShare });
                                    
                                    const cap = p.participationCap;
                                    if (cap > 0 && p.investment > 0) {
                                        const capTotal = p.investment * cap;
                                        if (dist.liquidationPref + dist.participation >= capTotal - 0.01) {
                                            dist.cappedReason = `Participation capped at ${cap}x multiple.`;
                                            cappedThisRound = true;
                                        } else {
                                            nextRoundParticipants.push(p);
                                        }
                                    } else {
                                        nextRoundParticipants.push(p);
                                    }
                                });
                                
                                if (!cappedThisRound) {
                                    if(remainingProceeds > 0 && currentTotalShares > 0) {
                                         const finalPerShare = WaterfallCalculator.safeDivide(remainingProceeds, currentTotalShares);
                                         currentParticipants.forEach(p => {
                                            const finalAllocation = distributions[p.type].shares * finalPerShare;
                                            distributions[p.type].participation += finalAllocation;
                                            remainingProceeds -= finalAllocation;
                                            WaterfallCalculator.ledgerSystem.record(`${p.name} - Participation (Final)`, -finalAllocation, remainingProceeds, { shares: distributions[p.type].shares, pps: finalPerShare });
                                         });
                                    }
                                    break;
                                }

                                currentParticipants = nextRoundParticipants;
                                currentTotalShares = WaterfallCalculator.safeSum(currentParticipants.map(p => distributions[p.type].shares));
                            }
                        }
                    }
                    
                    let finalDistributions = Object.values(distributions);

                    const { payments, npvSettings } = exitDetails;
                    
                    finalDistributions.forEach(dist => {
                        dist.totalProceeds = (dist.liquidationPref || 0) + (dist.participation || 0);
                        dist.totalNominal = dist.totalProceeds;

                        dist.paymentSchedule = payments.map(payment => {
                            const amount = dist.totalNominal * (payment.percent / 100);
                            const yearsFromNow = this.yearFraction(exitDetails.exitDate, payment.date);
                            const isImmediate = this.yearFraction(exitDetails.exitDate, payment.date) < (1/365);

                            return {
                                ...payment,
                                isImmediate,
                                nominalAmount: amount,
                                presentValue: npvSettings.enabled ? this.calculatePV(amount, yearsFromNow, npvSettings.discountRate) : amount
                            };
                        });
                        
                        dist.totalPV = dist.paymentSchedule.reduce((sum, p) => sum + p.presentValue, 0);
                        dist.immediateProceeds = dist.paymentSchedule.filter(p => p.isImmediate).reduce((sum, p) => sum + p.nominalAmount, 0);
                        dist.deferredProceeds = dist.paymentSchedule.filter(p => !p.isImmediate).reduce((sum, p) => sum + p.nominalAmount, 0);

                        if (dist.invested > 0) {
                            dist.moic = WaterfallCalculator.safeDivide(dist.totalNominal, dist.invested);
                            dist.moic_pv = WaterfallCalculator.safeDivide(dist.totalPV, dist.invested);
                            dist.returnPercent = WaterfallCalculator.safeDivide((dist.totalNominal - dist.invested) * 100, dist.invested);
                        } else {
                            dist.moic = dist.totalNominal > 0 ? Infinity : 0;
                            dist.moic_pv = dist.totalPV > 0 ? Infinity : 0;
                            dist.returnPercent = dist.totalNominal > 0 ? Infinity : 0;
                        }
                    });
                    
                    finalDistributions.sort((a, b) => b.totalNominal - a.totalNominal);
                    
                    const totalDistributed = WaterfallCalculator.safeSum(finalDistributions.map(d => d.totalNominal)) + mipAmount;
                    WaterfallCalculator.ledgerSystem.finalizeLedger(totalDistributed, netProceeds);

                    return {
                        distributions: finalDistributions,
                        totalDistributed: totalDistributed,
                        remaining: remainingProceeds,
                        mipAmount: mipAmount,
                        redemptionNotice: redemptionNotice
                    };
                },

                // IRR Calculation Methods
                calculateIRR: {
                    calculateForStakeholder(stakeholder, state) {
                        const originalRound = state.results.originalRounds.find(r => r.type === stakeholder.type) || {};
                        const cashFlows = this.buildCashFlows(stakeholder, originalRound, state.results.exitDetails);
                        
                        if (!cashFlows.some(cf => cf.amount < 0)) {
                            return { irr: null, irrFormatted: 'N/A', reason: 'No investment' };
                        }
                        
                        if (cashFlows.length < 2) {
                            return { irr: null, irrFormatted: 'N/A', reason: 'Insufficient cash flows' };
                        }
                        
                        const xirrResult = this.xirr(cashFlows);
                        
                        return {
                            irr: xirrResult,
                            irrFormatted: xirrResult !== null ? `${xirrResult.toFixed(2)}%` : 'N/A',
                            reason: xirrResult === null ? 'Could not converge' : (originalRound.dividend?.issuedOn ? null : 'Assumes investment was made 3 years prior to exit')
                        };
                    },
                    
                    buildCashFlows(stakeholder, originalRound, exitDetails) {
                        const flows = [];
                        
                        if (stakeholder.invested > 0) {
                            let investmentDate = exitDetails.exitDate;
                            if (originalRound.dividend?.issuedOn) {
                                investmentDate = originalRound.dividend.issuedOn;
                            } else {
                                const exitDateObj = new Date(exitDetails.exitDate);
                                exitDateObj.setFullYear(exitDateObj.getFullYear() - 3);
                                investmentDate = exitDateObj.toISOString().split('T')[0];
                            }
                            flows.push({ date: investmentDate, amount: -stakeholder.invested });
                        }
                        
                        if (stakeholder.totalProceeds > 0 && exitDetails.payments) {
                            exitDetails.payments.forEach(payment => {
                                const amount = stakeholder.totalProceeds * (payment.percent / 100);
                                if (amount > 0 && payment.date) {
                                    flows.push({ date: payment.date, amount: amount });
                                }
                            });
                        }
                        
                        return flows.sort((a, b) => new Date(a.date) - new Date(b.date));
                    },
                    
                    xirr(cashFlows, guess = 0.1) {
                        if (!cashFlows || cashFlows.length < 2) return null;

                        const maxIterations = 100;
                        const tolerance = 1e-7;
                        let rate = guess;

                        const hasInflow = cashFlows.some(cf => cf.amount > 0);
                        const hasOutflow = cashFlows.some(cf => cf.amount < 0);
                        if (!hasInflow || !hasOutflow) return null;

                        for (let i = 0; i < maxIterations; i++) {
                            const [npv, dnpv] = this.xirrDerivatives(cashFlows, rate);
                            if (Math.abs(npv) < tolerance) return rate * 100;
                            if (Math.abs(dnpv) < 1e-10) break; // Avoid division by zero
                            
                            const newRate = rate - npv / dnpv;
                            rate = newRate;
                        }
                        
                        // Check final result
                        const [finalNpv] = this.xirrDerivatives(cashFlows, rate);
                        return Math.abs(finalNpv) < tolerance ? rate * 100 : null;
                    },

                    xirrDerivatives(cashFlows, rate) {
                        let npv = 0;
                        let dnpv = 0;
                        const firstDate = new Date(cashFlows[0].date).getTime();

                        cashFlows.forEach(cf => {
                            const currentDate = new Date(cf.date).getTime();
                            const years = (currentDate - firstDate) / (1000 * 60 * 60 * 24 * 365.25);
                            
                            npv += cf.amount / Math.pow(1 + rate, years);
                            if (years > 0) {
                                dnpv -= years * cf.amount / Math.pow(1 + rate, years + 1);
                            }
                        });
                        
                        return [npv, dnpv];
                    }
                },


                allocateEscrow(distributions, escrowInfo) {
                    // This function is now deprecated in favor of the multi-payment system,
                    // but kept for potential future use or if the old logic is re-enabled.
                    if (!escrowInfo || !escrowInfo.amount || escrowInfo.amount <= 0) {
                        distributions.forEach(dist => {
                            dist.escrowHeld = 0;
                            dist.immediateProceeds = dist.totalProceeds;
                        });
                        return distributions;
                    }
                    
                    const totalDistributed = WaterfallCalculator.safeSum(distributions.map(d => d.totalProceeds));
                    
                    if (totalDistributed <= 0) {
                        return distributions;
                    }
                    
                    if (escrowInfo.method === 'proRata') {
                        // Pro-rata: Everyone bears escrow proportionally
                        distributions.forEach(dist => {
                            if (dist.totalProceeds > 0) {
                                const escrowShare = (WaterfallCalculator.safeDivide(dist.totalProceeds, totalDistributed)) * escrowInfo.amount;
                                dist.escrowHeld = escrowShare;
                                dist.immediateProceeds = dist.totalProceeds - dist.escrowHeld;
                            } else {
                                dist.escrowHeld = 0;
                                dist.immediateProceeds = 0;
                            }
                        });
                    } else if (escrowInfo.method === 'preferenceFirst') {
                        // Investor-friendly: Preferred get full preference from immediate cash
                        let availableImmediate = totalDistributed - escrowInfo.amount;
                        if (availableImmediate < 0) availableImmediate = 0;
                        
                        let remainingEscrow = escrowInfo.amount;
                        
                        distributions.forEach(dist => {
                            dist.immediateProceeds = 0;
                            dist.escrowHeld = 0;
                        });

                        // First, satisfy preferences from immediate cash
                        const preferredOrder = ['seriesC', 'seriesB', 'seriesA', 'seed'];
                        
                        preferredOrder.forEach(type => {
                            const dist = distributions.find(d => d.type === type);
                            if (dist && dist.liquidationPref > 0) {
                                const immediateAllocation = Math.min(dist.liquidationPref, availableImmediate);
                                const escrowAllocation = Math.min(dist.liquidationPref - immediateAllocation, remainingEscrow);
                                
                                dist.immediateProceeds = immediateAllocation;
                                dist.escrowHeld = escrowAllocation;
                                
                                availableImmediate -= immediateAllocation;
                                remainingEscrow -= escrowAllocation;
                            }
                        });
                        
                        // Allocate remaining to common/participating
                        const participatingDists = distributions.filter(d => (d.participation || 0) > 0);
                        const totalParticipating = WaterfallCalculator.safeSum(participatingDists.map(d => d.participation));
                        
                        participatingDists.forEach(dist => {
                            if (totalParticipating > 0 && dist.participation > 0) {
                                const share = WaterfallCalculator.safeDivide(dist.participation, totalParticipating);
                                const addImmediate = availableImmediate * share;
                                const addEscrow = remainingEscrow * share;

                                // ADD to existing values (from preference allocation)
                                dist.immediateProceeds = (dist.immediateProceeds || 0) + addImmediate;
                                dist.escrowHeld = (dist.escrowHeld || 0) + addEscrow;
                            }
                        });
                    }
                    
                    return distributions;
                }
            },

            // Helper Functions
            getCapitalStackOrder(type) {
                const ORDER_MAP = {
                    'founders': 1,
                    'optionPool': 2,
                    'safes': 3,
                    'seed': 10,
                    'seriesA': 20,
                    'seriesB': 30,
                    'seriesC': 40,
                    'seriesD': 50,
                    'seriesE': 60,
                    'seriesF': 70
                };
                return ORDER_MAP[type] || 999;
            },

            getCapitalCategory(type) {
                if (type === 'founders' || type === 'optionPool') return 'common';
                if (type === 'safes') return 'convertible';
                if (type.includes('series') || type === 'seed') return 'preferred';
                return 'other';
            },

            formatValue(value, options = {}) {
                const { mode = 'display', type = 'currency' } = options;

                if (mode === 'parse') {
                    if (typeof value !== 'string') value = String(value);
                    const cleaned = value.toLowerCase().replace(/[^0-9.kmb-]/g, '');
                    const suffixes = { k: 1e3, m: 1e6, b: 1e9 };
                    const suffix = cleaned.charAt(cleaned.length - 1);
                    if (suffixes[suffix]) {
                        const num = parseFloat(cleaned.slice(0, -1));
                        return isNaN(num) ? 0 : num * suffixes[suffix];
                    }
                    const num = parseFloat(cleaned);
                    return isNaN(num) ? 0 : num;
                }

                if (mode === 'round') {
                    const num = parseFloat(value);
                    if (isNaN(num)) return 0;
                    if (type === 'shares') {
                        return Math.round(num);
                    }
                    return Math.round(num * 100) / 100;
                }
                
                if (mode === 'input') {
                    if (value === null || value === undefined) return '';
                    const num = Number(value);
                    if (isNaN(num)) return '';
                    return new Intl.NumberFormat('en-US').format(num);
                }

                const num = parseFloat(value);
                if (typeof num !== 'number' || isNaN(num)) return 0;
                
                const roundedValue = Math.round(num * 100) / 100;
                return new Intl.NumberFormat('en-US').format(roundedValue);
            },

            roundToWholeShares(shares) {
                if (typeof shares !== 'number' || !isFinite(shares)) return 0;
                return Math.round(shares + Number.EPSILON);
            },

            safeDivide(numerator, denominator) {
                if (!denominator || denominator === 0 || !isFinite(denominator)) return 0;
                if (!numerator || !isFinite(numerator)) return 0;
                const result = numerator / denominator;
                return isFinite(result) ? result : 0;
            },

            safeCalculateOwnership(shares, totalShares) {
                if (!totalShares || totalShares <= 0) return 0;
                const ownership = this.safeDivide(shares * 100, totalShares);
                return Math.min(100, Math.max(0, ownership));
            },

            safeSum(values) {
                return values.reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
            },

            calculateAdvisorFees(grossValue = this.state.exitDetails.grossValue) {
                const { advisorFeePercent } = this.state.exitDetails;
                return this.safeDivide(grossValue * advisorFeePercent, 100);
            },

            calculateDilutedShares(existingRounds, newRoundType, targetOwnershipPercent) {
                const totalExistingShares = this.safeSum(
                    existingRounds.filter(r => r.type !== 'safes').map(r => r.shares || 0)
                );
                
                if (totalExistingShares === 0) {
                    return 10000000;
                }
                
                const targetDecimal = targetOwnershipPercent / 100;
                if (targetDecimal >= 1) return totalExistingShares; 
                
                const newShares = Math.round((targetDecimal * totalExistingShares) / (1 - targetDecimal));
                
                return Math.max(1, newShares);
            },

            getTargetOwnershipForRound(roundType, existingRounds) {
                const targets = {
                    'founders': 100,
                    'optionPool': 10,
                    'seed': 20,
                    'seriesA': 25,
                    'seriesB': 20,
                    'seriesC': 15
                };
                
                const hasSeed = existingRounds.some(r => r.type === 'seed');
                const hasSeriesA = existingRounds.some(r => r.type === 'seriesA');
                
                if (roundType === 'seriesA' && !hasSeed) return 30;
                if (roundType === 'seriesB' && !hasSeriesA) return 25;
                
                return targets[roundType] || 15;
            },

            showNotification(message) {
                const existing = document.getElementById('temp-notification');
                if (existing) existing.remove();
                
                const notification = document.createElement('div');
                notification.id = 'temp-notification';
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px;
                    background: var(--success); color: white;
                    padding: 12px 20px; border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000; animation: slideIn 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 3000);
            },
            
            calculateEscrowAmount() {
                if (!this.state.results) return 0;
                return this.safeSum(this.state.results.distributions.map(d => d.deferredProceeds));
            },

            getStakeholderColor(type) {
			    const colors = {
			        'founders': 'rgba(0, 102, 204, 0.8)',      // Blue
			        'optionPool': 'rgba(128, 128, 128, 0.8)',  // Gray
			        'safes': 'rgba(155, 89, 182, 0.8)',        // Purple
			        'seed': 'rgba(46, 204, 113, 0.8)',         // Green
			        'seriesA': 'rgba(52, 152, 219, 0.8)',      // Light Blue
			        'seriesB': 'rgba(41, 128, 185, 0.8)',      // Medium Blue
			        'seriesC': 'rgba(31, 97, 141, 0.8)',       // Dark Blue
			        'seriesD': 'rgba(22, 73, 106, 0.8)',       // Darker Blue
			        'seriesE': 'rgba(13, 49, 71, 0.8)',        // Very Dark Blue
			        'seriesF': 'rgba(4, 25, 36, 0.8)'          // Almost Black
			    };
			    return colors[type] || 'rgba(100, 100, 100, 0.8)';
			},

            calculateTotalExpenses(grossValue = this.state.exitDetails.grossValue) {
                const { debt, legalFees, otherExpenses, advisorFeePercent } = this.state.exitDetails;
                const advisorFees = this.safeDivide(grossValue * advisorFeePercent, 100);
                return debt + legalFees + advisorFees + (otherExpenses || 0);
            },

            calculateNetProceeds(grossValue = this.state.exitDetails.grossValue) {
                const { exitDetails } = this.state;
                
                const totalExpenses = this.calculateTotalExpenses(grossValue);
                
                const netBeforeCarveout = grossValue - totalExpenses;
                
                if (exitDetails.managementCarveout.enabled && netBeforeCarveout > 0) {
                    const carveoutAmount = this.safeDivide(netBeforeCarveout * exitDetails.managementCarveout.percent, 100);
                    return Math.max(0, netBeforeCarveout - carveoutAmount);
                }
                
                return Math.max(0, netBeforeCarveout);
            },
            
            calculateManagementCarveout(grossValue = this.state.exitDetails.grossValue) {
                if (!this.state.exitDetails.managementCarveout.enabled) return 0;
                
                const netBeforeCarveout = grossValue - this.calculateTotalExpenses(grossValue);
                if (netBeforeCarveout <= 0) return 0;
                return this.safeDivide(netBeforeCarveout * this.state.exitDetails.managementCarveout.percent, 100);
            },

            getTotalShares() {
                const roundsWithSplits = this.calculations.applySplits(this.state.rounds);
                const rounds = this.calculations.calculateAntiDilutionAdjustments(roundsWithSplits);
                return this.safeSum(rounds.filter(r => r.type !== 'safes').map(r => r.shares));
            },

            updateField(fieldKey, rawValue) {
                if (this.exampleScenarios.currentScenario && 
                    !this.exampleScenarios.currentScenarioModified) {
                    this.exampleScenarios.currentScenarioModified = true;
                    const dropdown = document.getElementById('exampleScenarioSelect');
                    if (dropdown) dropdown.value = '';
                    this.updateScenarioBadges();
                }
                
                let parsedValue = rawValue;
                
                if (fieldKey.endsWith('name')) {
                    parsedValue = rawValue;
                }
                else if (fieldKey.endsWith('.issuedOn') || fieldKey.endsWith('.exitDate') || fieldKey.includes('.date') || fieldKey.endsWith('startISO')) {
                    parsedValue = rawValue;
                } else if (fieldKey.endsWith('.antiDilution') || fieldKey.endsWith('.capType') || fieldKey.endsWith('.allocationMethod') || fieldKey.endsWith('.antiDilutionBase') || fieldKey.endsWith('.seniority') || fieldKey.endsWith('.consentModel')) {
                    parsedValue = rawValue;
                } else if (typeof rawValue === 'string' && !fieldKey.includes('percent') && !fieldKey.includes('discount')) {
                    parsedValue = this.formatValue(rawValue, { mode: 'parse' });
                } else if (typeof rawValue !== 'boolean') {
                    parsedValue = parseFloat(rawValue) || 0;
                }
                
                let obj = this.state;
                const parts = fieldKey.split('.');
                const last = parts.pop();
                
                for(const part of parts) {
                    if (!obj[part]) {
                        const nextPart = parts[parts.indexOf(part) + 1];
                        if (!isNaN(parseInt(nextPart, 10))) {
                             obj[part] = [];
                        } else {
                             obj[part] = {};
                        }
                    }
                    obj = obj[part];
                }

                if (typeof obj[last] === 'boolean' || fieldKey.includes('enabled') || fieldKey.includes('participated')) {
                    obj[last] = rawValue === true || rawValue === 'true';
                } else {
                    obj[last] = parsedValue;
                }

                if (fieldKey === 'exitDetails.exitDate' && this.state.exitDetails.payments[0]) {
                    this.state.exitDetails.payments[0].date = parsedValue;
                }
            },

            // Validation Engine
            validation: {
                rules: {
                    isPositive: value => parseFloat(value) > 0,
                    isNotNegative: value => parseFloat(value) >= 0,
                    isInteger: value => Number.isInteger(parseFloat(value)),
                    isPercentage: value => {
                        const num = parseFloat(value);
                        return num >= 0 && num <= 100;
                    },
                    maxCurrency: value => parseFloat(value) <= 100000000000, // 100 Billion
                    isValidDate: value => !/^\d{4}-\d{2}-\d{2}$/.test(value) || !isNaN(new Date(value).getTime()),
                    isReasonableInvestment: value => {
                        const num = parseFloat(value);
                        return num > 0 && num <= 50000000000; // $50B max
                    },
                    isReasonableValuation: value => {
                        const num = parseFloat(value);
                        return num > 0 && num <= 5000000000000; // $5T max
                    },
                    isValidSafeParameters: (amount, cap) => {
                        return parseFloat(cap) > parseFloat(amount);
                    },
                    isReasonableDiscount: value => {
                        const num = parseFloat(value);
                        return num >= 0 && num <= 50;
                    },
                    isReasonableLiqPref: value => {
                        const num = parseFloat(value);
                        return num >= 0 && num <= 5;
                    },
                    detectDownRound: (currentValuation, previousValuation) => {
                        if (!previousValuation || previousValuation <= 0) return true;
                        return currentValuation >= previousValuation * 0.8;
                    }
                },
                
                messages: {
                    safeCapBelowInvestment: 'Valuation cap must exceed investment amount. Otherwise, the investor would immediately own more than 100% of the company.',
                    highLiquidationPreference: 'A liquidation preference above 2x is aggressive and may significantly reduce founder returns.',
                    participatingPreferredEarly: 'Participating preferred in early rounds is unusual and founder-unfriendly.',
                    downRoundDetected: 'This appears to be a down round (>20% valuation decrease), which may trigger anti-dilution provisions.',
                    unreasonableDiscount: 'SAFE discounts above 30% are unusual in the market.',
                },
                
                validateField(field, value, mode = 'blur') {
                    delete WaterfallCalculator.state.errors[field];
                    delete WaterfallCalculator.state.warnings[field];

                    const check = (rules) => {
                        for (const rule of rules) {
                            if (!this.rules[rule.type](value)) {
                                WaterfallCalculator.state.errors[field] = rule.message;
                                return;
                            }
                        }
                    };

                    if (field.includes('percent') || field.includes('discount') || field.includes('rate') || field.includes('coveragePct') || field.includes('Threshold')) {
                        check([{ type: 'isPercentage', message: 'Percentage must be between 0 and 100.' }]);
                    } else if (field.includes('shares')) {
                        check([{ type: 'isNotNegative', message: 'Value cannot be negative.' }]);
                        if (mode === 'blur') check([
                            { type: 'isPositive', message: 'Shares must be a positive number, as a round must issue at least one share.' }, 
                            { type: 'isInteger', message: 'Share counts must be whole numbers, as fractional shares are not typically issued.' }
                        ]);
                    } else if (field.endsWith('Date') || field.endsWith('issuedOn') || field.includes('.date') || field.endsWith('startISO')) {
                        if (!value) {
                             WaterfallCalculator.state.errors[field] = 'Date is required for this calculation.';
                        } else {
                            check([{ type: 'isValidDate', message: 'Please enter a valid date (YYYY-MM-DD).' }]);
                        }
                    } else {
                        check([{ type: 'isNotNegative', message: 'Value cannot be negative.' }]);
                    }

                    if (mode === 'blur') {
                        if (!field.includes('percent') && !field.includes('discount') && field !== 'exitDetails.npvSettings.discountRate' && !field.includes('strike') && !field.includes('multiple')) {
                            check([{ type: 'maxCurrency', message: 'Value cannot exceed $100B. This is a practical limit to prevent data entry errors.' }]);
                            if (value > Number.MAX_SAFE_INTEGER) {
                                WaterfallCalculator.state.warnings[field] = 'Value is very large and may lose precision.';
                            }
                        }

                        if (field.includes('investment') || field.includes('warrant.strike')) {
                             check([{ type: 'isPositive', message: 'Value must be positive.' }]);
                        }

                        if (field.includes('liquidationPref') || field.includes('redemption.multiple')) {
                            const numValue = parseFloat(value);
                            if (numValue > 2 && field.includes('liquidationPref')) {
                                WaterfallCalculator.state.warnings[field] = this.messages.highLiquidationPreference;
                            }
                             if (numValue < 1 || numValue > 5) {
                                if (field.includes('liquidationPref') && numValue === 0) {
                                    // Allow 0x liq pref
                                } else {
                                    WaterfallCalculator.state.errors[field] = 'Multiple must be between 1 and 5.';
                                }
                            }
                        }

                        if (field.startsWith('safes') && field.includes('discount')) {
                            const numValue = parseFloat(value);
                            if (numValue > 30) {
                                WaterfallCalculator.state.warnings[field] = this.messages.unreasonableDiscount;
                            }
                        }
                        
                         if (field.includes('dividend.ratePct') || field.includes('prefInterest.ratePct')) {
                            const num = parseFloat(value);
                            if (num > 15) {
                                WaterfallCalculator.state.warnings[field] = 'Rates above 15% are highly unusual for VC deals.';
                            }
                        }
                        
                        if (field === 'exitDetails.npvSettings.discountRate') {
                            const num = parseFloat(value);
                            if (num < 0 || num > 50) {
                                WaterfallCalculator.state.errors[field] = 'Discount rate must be between 0% and 50%.';
                            }
                        }

                        // Cross-field validations
                        if (field.startsWith('safes')) {
                            const index = field.split('.')[1];
                            const safe = WaterfallCalculator.state.safes[index];
                            if (safe.valuationCap <= safe.amount) {
                                WaterfallCalculator.state.errors[`safes.${index}.valuationCap`] = 'Valuation cap must exceed investment. A cap below investment is economically irrational for the investor.';
                            }
                        }
                        
                         if (field === 'exitDetails.grossValue' && value <= 0) {
                            WaterfallCalculator.state.errors[field] = 'Gross exit value must be positive to calculate a meaningful distribution.';
                        }
                    }
                    
                    this.validate();
                },
                
                validate() {
                    delete WaterfallCalculator.state.errors.paymentTotal;
                    delete WaterfallCalculator.state.errors.paymentDate;
                    delete WaterfallCalculator.state.errors.paymentImmediate;

                    const { exitDetails } = WaterfallCalculator.state;
                    
                    if (exitDetails.debt > exitDetails.grossValue && exitDetails.grossValue > 0) {
                        WaterfallCalculator.state.warnings.debtExceedsExit = true;
                    } else {
                        delete WaterfallCalculator.state.warnings.debtExceedsExit;
                    }

                    const exitDate = new Date(WaterfallCalculator.state.exitDetails.exitDate);

                    WaterfallCalculator.state.rounds.forEach((round, index) => {
                         const warningKey = `rounds.${index}.liquidationPref`;
                        if (round.liquidationPref > 1.5) {
                            WaterfallCalculator.state.warnings[warningKey] = `A ${round.liquidationPref}x preference is high and may be considered aggressive.`;
                        } else {
                             delete WaterfallCalculator.state.warnings[warningKey];
                        }

                        if (round.dividend?.enabled && round.dividend.issuedOn) {
                            const issueDate = new Date(round.dividend.issuedOn);
                            const key = `rounds.${index}.dividend.issuedOn`;
                            if (issueDate > exitDate) {
                                WaterfallCalculator.state.errors[key] = 'Issue date cannot be after the exit date.';
                            } else {
                                if (WaterfallCalculator.state.errors[key] === 'Issue date cannot be after the exit date.') {
                                     delete WaterfallCalculator.state.errors[key];
                                }
                            }
                        }
                        
                        if (round.prefInterest?.enabled && round.prefInterest.startISO) {
                            const startDate = new Date(round.prefInterest.startISO);
                            const key = `rounds.${index}.prefInterest.startISO`;
                            if (startDate > exitDate) {
                                WaterfallCalculator.state.errors[key] = 'Start date cannot be after the exit date.';
                            } else {
                                 if (WaterfallCalculator.state.errors[key] === 'Start date cannot be after the exit date.') {
                                     delete WaterfallCalculator.state.errors[key];
                                 }
                            }
                        }
                        
                        if (round.redemption?.enabled && round.redemption.startISO) {
                             const redeemDate = new Date(round.redemption.startISO);
                             const issueDate = new Date(round.dividend.issuedOn);
                             const key = `rounds.${index}.redemption.startISO`;
                             if (redeemDate < issueDate) {
                                 WaterfallCalculator.state.errors[key] = 'Redemption date cannot be before the issue date.';
                             } else {
                                 if (WaterfallCalculator.state.errors[key] === 'Redemption date cannot be before the issue date.') {
                                      delete WaterfallCalculator.state.errors[key];
                                 }
                             }
                        }


                        if (round.warrant?.enabled) {
                            const strikeKey = `rounds.${index}.warrant.strike`;
                            if (!this.rules.isPositive(round.warrant.strike)) {
                                WaterfallCalculator.state.errors[strikeKey] = 'Strike price must be positive.';
                            } else {
                                delete WaterfallCalculator.state.errors[strikeKey];
                            }

                            const coverageKey = `rounds.${index}.warrant.coveragePct`;
                            const coverageNum = parseFloat(round.warrant.coveragePct);
                            if (coverageNum < 0 || coverageNum > 50) {
                                WaterfallCalculator.state.errors[coverageKey] = 'Coverage must be between 0% and 50%.';
                            } else {
                                delete WaterfallCalculator.state.errors[coverageKey];
                            }
                        }
                    });

                    const totalPercent = WaterfallCalculator.safeSum(exitDetails.payments.map(p => p.percent));
                    if (Math.abs(totalPercent - 100) > 0.01) {
                        WaterfallCalculator.state.errors.paymentTotal = 'Payment percentages must sum to 100%.';
                    }

                    let hasImmediate = false;
                    exitDetails.payments.forEach((payment, index) => {
                        const paymentDate = new Date(payment.date);
                        if (paymentDate < exitDate) {
                            WaterfallCalculator.state.errors[`exitDetails.payments.${index}.date`] = 'Payment date cannot be before the exit date.';
                        }
                        if (payment.date === exitDetails.exitDate) {
                            hasImmediate = true;
                        }
                    });
                    
                    if (!hasImmediate) {
                        WaterfallCalculator.state.errors.paymentImmediate = 'At least one payment must be immediate (on the closing date).';
                    }
                }
            },
            
            educationalMessages: {
                safeCapBelowInvestment: {
                    title: 'Invalid SAFE Terms',
                    message: 'The valuation cap must be higher than the investment amount.',
                    explanation: 'If an investor puts in $500K with a $400K cap, they would own 125% of the company at conversion, which is impossible.',
                    suggestion: 'Set the valuation cap at least 2-3x higher than the investment amount.',
                    example: 'For a $500K investment, consider a cap of $2M-$5M.'
                },
                
                highLiquidationPreference: {
                    title: 'Aggressive Liquidation Preference',
                    message: 'This liquidation preference multiple is higher than market standard.',
                    explanation: 'With a 3x preference on $10M, investors get $30M before founders see anything.',
                    suggestion: '1x is standard, 1.5x is aggressive, 2x+ is rare.',
                    impact: 'At a $50M exit with 3x preference, investors get $30M first, leaving only $20M for everyone else.'
                },
                
                participatingPreferredEarly: {
                    title: 'Unusual Terms for Early Stage',
                    message: 'Participating preferred is uncommon in seed/Series A rounds.',
                    explanation: 'Participating preferred allows investors to "double-dip" - getting their preference AND participating in remaining proceeds.',
                    marketNorm: 'Seed and Series A are typically 1x non-participating.',
                    impact: 'This significantly reduces founder returns at all exit values.'
                },
                
                downRoundDetected: {
                    title: 'Down Round Detected',
                    message: 'This round\'s valuation is significantly lower than the previous round.',
                    explanation: 'A down round occurs when a company raises money at a lower valuation than before.',
                    trigger: 'This may trigger anti-dilution provisions for previous investors.',
                    impact: 'Previous investors may receive additional shares to compensate for the lower valuation.'
                }
            },

            showEducationalMessage(key) {
                const msg = this.educationalMessages[key];
                if (!msg) return;
                
                // Create educational popup
                const popup = document.createElement('div');
                popup.className = 'educational-popup';
                popup.innerHTML = `
                    <div class="educational-content">
                        <h3>${msg.title}</h3>
                        <p><strong>${msg.message}</strong></p>
                        ${msg.explanation ? `<p>${msg.explanation}</p>` : ''}
                        ${msg.suggestion ? `<p><em>Suggestion: ${msg.suggestion}</em></p>` : ''}
                        ${msg.example ? `<p>Example: ${msg.example}</p>` : ''}
                        ${msg.impact ? `<p>Impact: ${msg.impact}</p>` : ''}
                        ${msg.marketNorm ? `<p>Market norm: ${msg.marketNorm}</p>` : ''}
                        <button onclick="this.parentElement.parentElement.remove()">Got it</button>
                    </div>
                `;
                document.body.appendChild(popup);
            },

            // Sensitivity Analysis
            sensitivity: {
                calculateScenarios(minExit, maxExit, stepSize) {
                    const sourceRounds = WaterfallCalculator.state.results ? WaterfallCalculator.state.results.originalRounds : WaterfallCalculator.state.rounds;
                    const sourceSafes = WaterfallCalculator.state.results ? WaterfallCalculator.state.results.safes : WaterfallCalculator.state.safes;

                    const totalRaised = WaterfallCalculator.safeSum(sourceRounds.map(r => r.investment)) + WaterfallCalculator.safeSum(sourceSafes.map(s => s.amount));
                    
                    if (totalRaised <= 0 && minExit <=0) return { scenarios: [], stakeholders: [] };

                    const results = { scenarios: [], stakeholders: new Set() };
                    
                    if (maxExit <= minExit || stepSize <= 0) {
                        const scenarioResult = this.calculateSingleScenario(maxExit);
                        const multiple = WaterfallCalculator.safeDivide(maxExit, totalRaised);
                        results.scenarios.push({
                            name: `${multiple.toFixed(1)}x Raised`,
                            multiple,
                            exitValue: maxExit,
                            distributions: scenarioResult.distributions,
                            netProceeds: scenarioResult.netProceeds
                        });
                        scenarioResult.distributions.forEach(dist => results.stakeholders.add(dist.name));
                    } else {
                        for (let currentExit = minExit; currentExit <= maxExit; currentExit += stepSize) {
                            const scenarioResult = this.calculateSingleScenario(currentExit);
                            const multiple = WaterfallCalculator.safeDivide(currentExit, totalRaised);
                            
                            results.scenarios.push({
                                name: `${multiple.toFixed(1)}x Raised`,
                                multiple: multiple,
                                exitValue: currentExit,
                                distributions: scenarioResult.distributions,
                                netProceeds: scenarioResult.netProceeds
                            });
                            
                            scenarioResult.distributions.forEach(dist => results.stakeholders.add(dist.name));
                        }
                    }
                    
                    results.stakeholders = Array.from(results.stakeholders);
                    return results;
                },
                
                calculateSingleScenario(exitValue) {
                    const sourceRounds = WaterfallCalculator.state.results ? WaterfallCalculator.state.results.originalRounds : WaterfallCalculator.state.rounds;
                    const sourceSafes = WaterfallCalculator.state.results ? WaterfallCalculator.state.results.safes : WaterfallCalculator.state.safes;
                    
                    const tempExitDetails = JSON.parse(JSON.stringify(WaterfallCalculator.state.exitDetails));
                    tempExitDetails.grossValue = exitValue;

                    const calculateTempExpenses = () => {
                        const advisorFees = WaterfallCalculator.safeDivide(tempExitDetails.grossValue * tempExitDetails.advisorFeePercent, 100);
                        return tempExitDetails.debt + tempExitDetails.legalFees + advisorFees + (tempExitDetails.otherExpenses || 0);
                    };
                    
                    const calculateTempNetProceeds = () => {
                        const totalExpenses = calculateTempExpenses();
                        let net = tempExitDetails.grossValue - totalExpenses;
                        if (tempExitDetails.managementCarveout.enabled && net > 0) {
                            net -= WaterfallCalculator.safeDivide(net * tempExitDetails.managementCarveout.percent, 100);
                        }
                        return Math.max(0, net);
                    };

                    const netProceeds = calculateTempNetProceeds();
                    
                    const adjustedRounds = WaterfallCalculator.calculations.calculateAntiDilutionAdjustments(sourceRounds);

                    const waterfallResult = WaterfallCalculator.calculations.calculateWaterfall(
                        netProceeds,
                        adjustedRounds,
                        sourceSafes,
                        exitValue,
                        null,
                        tempExitDetails
                    );
                    
                    return {
                        exitValue: exitValue,
                        netProceeds: netProceeds,
                        distributions: waterfallResult.distributions
                    };
                },
                
                generateInsights(scenarioData) {
                    const insights = [];
                    if (!scenarioData || scenarioData.scenarios.length === 0) return insights;
                    
                    const sourceRounds = WaterfallCalculator.state.results ? WaterfallCalculator.state.results.originalRounds : WaterfallCalculator.state.rounds;
                    
                    const expenses = WaterfallCalculator.calculateTotalExpenses();
                    insights.push({
                        label: 'Debt & Expenses Covered At',
                        value: expenses
                    });
                    
                    for (const scenario of scenarioData.scenarios) {
                        const foundersDist = scenario.distributions.find(d => d.type === 'founders');
                        if (foundersDist && foundersDist.totalProceeds > 0) {
                            insights.push({
                                label: 'Founders Distribute At',
                                value: scenario.exitValue
                            });
                            break;
                        }
                    }
                    
                    const hasSeriesA = sourceRounds.some(r => r.type === 'seriesA');
                    if (hasSeriesA) {
                        for (const scenario of scenarioData.scenarios) {
                            const seriesADist = scenario.distributions.find(d => d.type === 'seriesA');
                            if (seriesADist && seriesADist.moic > 1) {
                                insights.push({
                                    label: 'Series A Profits At',
                                    value: scenario.exitValue
                                });
                                break;
                            }
                        }
                    }
                    
                    return insights.slice(0, 4);
                },

                generateCSV(scenarioData) {
                  if (!scenarioData || !scenarioData.scenarios?.length) return '';
                  const headers = ['Exit Value','Net Proceeds', ...scenarioData.stakeholders];
                  const rows = scenarioData.scenarios.map(s => {
                    const cols = [
                      Math.round(s.exitValue),
                      Math.round(Math.max(0, s.netProceeds)),
                      ...scenarioData.stakeholders.map(name => {
                        const d = s.distributions.find(x => x.name === name);
                        return d ? Math.round(d.totalProceeds) : 0;
                      })
                    ];
                    return cols.join(',');
                  });
                  return [headers.join(','), ...rows].join('\n');
                },

                renderControls() {
                    const { sensitivity } = WaterfallCalculator.state;
                    return `
                        <div class="card" id="card-sensitivity-controls">
                            <div class="card-header">
                                <h2 class="card-title">🔬 Analysis Range</h2>
                            </div>
                            <div class="card-content">
                                <div class="grid grid-3">
                                    ${WaterfallCalculator.renderField({ label: 'Min Exit ($)', fieldKey: 'sensitivity.minExit', value: sensitivity.minExit })}
                                    ${WaterfallCalculator.renderField({ label: 'Max Exit ($)', fieldKey: 'sensitivity.maxExit', value: sensitivity.maxExit })}
                                    ${WaterfallCalculator.renderField({ label: 'Number of Steps', fieldKey: 'sensitivity.stepCount', value: sensitivity.stepCount, type: 'number', step: '1' })}
                                </div>
                                <div class="text-right">
                                    <button class="btn btn-primary" data-action="runSensitivity">Run Analysis</button>
                                </div>
                            </div>
                        </div>
                    `;
                },
                
                renderTable(scenarioData) {
                    const currentExitValue = WaterfallCalculator.state.exitDetails.grossValue;
                    
                    return `
                        <div class="table-scroll-wrapper">
                            <table class="sensitivity-table">
                                <thead>
                                    <tr>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--white);">
                                            Scenario
                                        </th>
                                        <th style="padding: 0.75rem; text-align: right; color: var(--white);">Exit Value</th>
                                        <th style="padding: 0.75rem; text-align: right; color: var(--white);">Net Proceeds</th>
                                        ${scenarioData.stakeholders.map(name => `
                                            <th style="padding: 0.75rem; text-align: right; color: var(--white);">${name}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${scenarioData.scenarios.map((scenario, i) => {
                                        const isCurrentScenario = Math.abs(scenario.exitValue - currentExitValue) < 1;
                                        
                                        return `
                                            <tr class="${isCurrentScenario ? 'current-scenario' : ''}"
                                                data-action="loadScenario"
                                                data-exit-value="${scenario.exitValue}">
                                                <td style="padding: 0.75rem; font-weight: 600;">
                                                    ${scenario.name}
                                                    ${isCurrentScenario ? '<span style="color: var(--primary); font-size: 0.75rem;"> (current)</span>' : ''}
                                                </td>
                                                <td style="padding: 0.75rem; text-align: right;">
                                                    $${WaterfallCalculator.formatValue(Math.round(scenario.exitValue))}
                                                </td>
                                                <td style="padding: 0.75rem; text-align: right; ${scenario.netProceeds <= 0 ? 'color: var(--danger);' : ''}">
                                                    $${WaterfallCalculator.formatValue(Math.round(Math.max(0, scenario.netProceeds)))}
                                                </td>
                                                ${scenarioData.stakeholders.map(stakeholder => {
                                                    const dist = scenario.distributions.find(d => d.name === stakeholder);
                                                    const proceeds = dist ? dist.totalNominal : 0;
                                                    
                                                    return `
                                                        <td style="padding: 0.75rem; text-align: right;">
                                                            ${proceeds > 0 ? '$' + WaterfallCalculator.formatValue(Math.round(proceeds)) : '-'}
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--gray-dark); background: var(--primary-light); padding: 0.75rem; border-radius: 6px; text-align: center; border: 1px solid var(--primary-dark);">
                            💡 Click any scenario row to load it and see the full <span class="tooltip" data-tooltip="Sequential order of who gets paid at exit">waterfall</span> distribution.
                        </div>
                    `;
                }
            },

            // Chart Management
            charts: {
                instances: {
                    waterfall: null,
                    pie: null,
                    dilution: null,
                    sensitivity: null
                },
                
                visibilityObserver: null,
                sensitivityObserver: null,
                resizeObservers: [],

                totalDeferredPercent(exitDetails) {
				  if (!exitDetails?.payments?.length) return 0;
				  return exitDetails.payments
				    .filter(p => !p.isImmediate)
				    .reduce((sum, p) => sum + (Number(p.percent) || 0), 0);
				},

                destroy() {
                    if (this.visibilityObserver) this.visibilityObserver.disconnect();
                    if (this.sensitivityObserver) this.sensitivityObserver.disconnect();
                    this.visibilityObserver = null;
                    this.sensitivityObserver = null;
                    
                    this.resizeObservers.forEach(observer => observer.disconnect());
                    this.resizeObservers = [];

                    Object.keys(this.instances).forEach(key => {
                        if (this.instances[key]) {
                            this.instances[key].destroy();
                            this.instances[key] = null;
                        }
                    });
                },

                initChartWithObserver(chartKey, creationFunc, data) {
                    const canvas = document.getElementById(`${chartKey}Chart`);
                    if (!canvas) return;
                    
                    const container = canvas.closest('.chart-container');
                    if (!container) return;

                    if (this.instances[chartKey]) return;

                    creationFunc.call(this, data);
                    
                    const resizeObserver = new ResizeObserver(() => {
                        if (this.instances[chartKey]) {
                            this.instances[chartKey].resize();
                        }
                    });

                    resizeObserver.observe(container);
                    this.resizeObservers.push(resizeObserver);
                },
                
                prepareChartData() {
                    if (!WaterfallCalculator.state.results) return [];
                    const distributions = [...WaterfallCalculator.state.results.distributions].sort((a, b) => 
                        WaterfallCalculator.getCapitalStackOrder(a.type) - WaterfallCalculator.getCapitalStackOrder(b.type)
                    );
                    return distributions;
                },

                createWaterfallChart() {
                    if (this.instances.waterfall) return;
					const ctx = document.getElementById('waterfallChart');
					if (!ctx || !WaterfallCalculator.state.results) return;
					
					const results = WaterfallCalculator.state.results;
					const waterfallData = [];
					let runningTotal = results.grossExit;
					
					waterfallData.push({
					    label: 'Gross Exit',
					    start: 0,
					    end: runningTotal,
					    type: 'positive',
					    color: 'rgba(0, 168, 84, 0.8)'
					});
					
					const expenses = results.grossExit - results.netProceeds;
					if (expenses > 0) {
					    waterfallData.push({
					        label: 'Expenses & Fees',
					        start: runningTotal - expenses,
					        end: runningTotal,
					        type: 'negative',
					        color: 'rgba(230, 57, 70, 0.8)'
					    });
					    runningTotal -= expenses;
					}
					
					const immediateDistributed = results.distributions.reduce(
					  (sum, d) => sum + (d.immediateProceeds || 0),
					  0
					);
					results.distributions.forEach(dist => {
					  const amt = dist.immediateProceeds || 0;
					  if (amt > 0) {
					    waterfallData.push({
					      label: `${dist.name} (immediate)`,
					      start: runningTotal - amt,
					      end: runningTotal,
					      type: 'distribution',
					      color: WaterfallCalculator.getStakeholderColor(dist.type)
					    });
					    runningTotal -= amt;
					  }
					});
					
					const deferredPct = this.totalDeferredPercent(results.exitDetails);
					const deferredTotal = Math.max(0, results.netProceeds - immediateDistributed);
					if (deferredTotal > 0) {
					  waterfallData.push({
					    label: `Deferred Payments (${deferredPct.toFixed(1)}%)`,
					    start: runningTotal - deferredTotal,
					    end: runningTotal,
					    type: 'escrow',
					    color: 'rgba(155, 89, 182, 0.8)',
					    pattern: true
					  });
					  runningTotal -= deferredTotal;
					}

                    this.instances.waterfall = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: waterfallData.map(d => d.label),
                            datasets: [{
                                data: waterfallData.map(d => [d.start, d.end]),
                                backgroundColor: waterfallData.map(d => d.color),
                                borderColor: waterfallData.map(d => d.color.replace('0.8', '1')),
                                borderWidth: 1,
                                barPercentage: 0.8,
                                categoryPercentage: 0.9
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: false,
                                    labels: { 
                                        color: '#333333',
                                        font: { size: 12, weight: '500' }
                                    } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    callbacks: {
                                        label: (context) => {
                                            const data = waterfallData[context.dataIndex];
                                            const value = data.end - data.start;
                                            return `${data.label}: $${WaterfallCalculator.formatValue(value)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        autoSkip: false,
                                        maxRotation: 45,
                                        minRotation: 45,
                                        font: { size: 10 },
                                        padding: 5
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                    ticks: {
                                        callback: (value) => {
                                            if (value === 0) return '$0';
                                            const absValue = Math.abs(value);
                                            if (absValue >= 1e9) return `$${(absValue / 1e9).toFixed(1)}B`;
                                            if (absValue >= 1e6) return `$${(absValue / 1e6).toFixed(1)}M`;
                                            if (absValue >= 1e3) return `$${(absValue / 1e3).toFixed(0)}K`;
                                            return `$${absValue.toFixed(0)}`;
                                        },
                                        padding: 15,
                                        font: { size: 11 }
                                    },
                                    min: 0
                                }
                            },
                            layout: {
                                padding: { left: 20, right: 20, top: 0, bottom: 20 }
                            }
                        }
                    });
                },

                createPieChart() {
                    if (this.instances.pie) return;
                    const ctx = document.getElementById('pieChart');
                    if (!ctx || !WaterfallCalculator.state.results) return;
                    
                    const results = WaterfallCalculator.state.results;
                    const distributions = this.prepareChartData();
                    const totalExpenses = WaterfallCalculator.calculateTotalExpenses(results.grossExit);
                    const carveout = WaterfallCalculator.calculateManagementCarveout(results.grossExit);
                    const labels = [], data = [], colors = [];
                    
                    if (totalExpenses > 0) { labels.push('Expenses'); data.push(totalExpenses); colors.push('#e63946'); }
                    if (carveout > 0) { labels.push('Mgmt Carve-out'); data.push(carveout); colors.push('#ffb700'); }
                    distributions.forEach(dist => {
                        if (dist.totalProceeds > 0) {
                            labels.push(dist.name);
                            data.push(dist.totalProceeds);
                            colors.push(dist.type === 'founders' ? '#0066cc' : dist.type === 'safes' ? '#9b59b6' : dist.type.startsWith('series') ? '#3498db' : '#2ecc71');
                        }
                    });
                    
                    this.instances.pie = new Chart(ctx, {
                        type: 'pie',
                        data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Exit Distribution Breakdown', font: { size: 14 } },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    callbacks: {
                                        label: (context) => {
                                            const total = WaterfallCalculator.safeSum(context.dataset.data);
                                            const percentage = WaterfallCalculator.safeCalculateOwnership(context.raw, total).toFixed(1);
                                            return `${context.label}: $${WaterfallCalculator.formatValue(context.raw)} (${percentage}%)`;
                                        }
                                    }
                                },
                                legend: { 
                                    position: 'bottom', 
                                    labels: { 
                                        padding: 10, 
                                        font: { size: 11 },
                                        color: '#333333'
                                    } 
                                }
                            },
                            animation: { animateRotate: true, animateScale: true, duration: 1000 }
                        }
                    });
                },

                createDilutionChart() {
                    if (this.instances.dilution) return;
                    const ctx = document.getElementById('dilutionChart');
                    if (!ctx || !WaterfallCalculator.state.results || !WaterfallCalculator.state.results.safes.length) return;

                    const { safes, rounds, grossExit } = WaterfallCalculator.state.results;
                    const convertedSafes = WaterfallCalculator.calculations.convertAllSafes(safes, grossExit, rounds);
                    const dilutionTable = WaterfallCalculator.calculations.calculateDilution(rounds, convertedSafes);
                    
                    this.instances.dilution = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: dilutionTable.map(row => row.name),
                            datasets: [
                                { label: 'Pre-SAFE', data: dilutionTable.map(row => row.preOwnership), backgroundColor: '#0066cc' },
                                { label: 'Post-SAFE', data: dilutionTable.map(row => row.postOwnership), backgroundColor: '#00a854' }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Ownership Before/After SAFE Conversion', font: { size: 14 } },
                                tooltip: { 
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    callbacks: { label: (c) => `${c.dataset.label}: ${c.raw.toFixed(2)}%` } 
                                },
                                legend: { 
                                    position: 'top',
                                    labels: {
                                        color: '#333333'
                                    }
                                }
                            },
                            scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (v) => `${v}%` } } },
                            animation: { duration: 1000, easing: 'easeInOutQuart' }
                        }
                    });
                },

                createSensitivityChart(scenarioData) {
                    if (this.instances.sensitivity || !scenarioData) return;
                    const ctx = document.getElementById('sensitivityChart');
                    if (!ctx) return;
                    
                    const { stakeholders, scenarios } = scenarioData;
                    
                    const hasScenarios = Array.isArray(scenarios) && scenarios.length > 0;
                    const hasStakeholders = Array.isArray(stakeholders) && stakeholders.length > 0;
                    if (!hasScenarios || !hasStakeholders) return;
                    
                    const labels = scenarios.map(s => Number(s.exitValue) || 0);
                    
                    const colorMap = {
                        'Founders': '#0066cc', 'Option Pool': '#cccccc', 'Converted SAFEs': '#9b59b6',
                        'Seed Round': '#2ecc71', 'Series A': '#3498db', 'Series B': '#2980b9', 'Series C': '#1f618d'
                    };
                    let colorIndex = 0;
                    const dynamicColors = ['#e74c3c', '#f1c40f', '#8e44ad', '#16a085', '#d35400'];

                    const datasets = stakeholders.map(stakeholderName => {
                        const data = scenarios.map(scenario => {
                            const dist = scenario.distributions.find(d => d.name === stakeholderName);
                            return dist ? dist.totalNominal : 0;
                        });
                        
                        let color = colorMap[stakeholderName];
                        if (!color) {
                            color = dynamicColors[colorIndex % dynamicColors.length];
                            colorIndex++;
                        }

                        return {
                            label: stakeholderName,
                            data: data,
                            borderColor: color,
                            fill: false,
                            tension: 0.1
                        };
                    });

                    this.instances.sensitivity = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: 'Stakeholder Proceeds vs. Exit Value', font: { size: 16 } },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    callbacks: {
                                        title: (items) => `Exit: $${WaterfallCalculator.formatValue(Number(items[0].label))}`,
                                        label: (ctx) => `${ctx.dataset.label}: $${WaterfallCalculator.formatValue(Number(ctx.raw))}`
                                    }
                                },
                                legend: { 
                                    position: 'bottom',
                                    labels: {
                                        color: '#333333'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Gross Exit Value' },
                                    ticks: { callback: (value) => `$${WaterfallCalculator.formatValue(Number(labels[value]))}` }
                                },
                                y: {
                                    title: { display: true, text: 'Total Proceeds' },
                                    ticks: { callback: (value) => value >= 1e6 ? `$${value / 1e6}M` : value >= 1e3 ? `$${value / 1e3}K` : `$${value}` }
                                }
                            }
                        }
                    });
                },

                renderAllResultsCharts() {
                    this.initChartWithObserver('waterfall', this.createWaterfallChart);
                    this.initChartWithObserver('pie', this.createPieChart);
                    if (WaterfallCalculator.state.results.safes.length > 0) {
                        this.initChartWithObserver('dilution', this.createDilutionChart);
                    }
                },
                
                initResultsObserver() {
                    const chartTab = document.getElementById('charts-tab');
                    if (!chartTab || this.visibilityObserver) return;

                    this.visibilityObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                this.renderAllResultsCharts();
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.1 });

                    this.visibilityObserver.observe(chartTab);
                },

                initSensitivityObserver(scenarios) {
                    const chartCard = document.getElementById('card-sensitivity-chart');
                    if (!chartCard || this.sensitivityObserver) return;

                    this.sensitivityObserver = new IntersectionObserver((entries, observer) => {
                         if (entries[0].isIntersecting) {
                            this.initChartWithObserver('sensitivity', this.createSensitivityChart, scenarios);
                            observer.unobserve(entries[0].target);
                         }
                    }, { threshold: 0.1 });
                    this.sensitivityObserver.observe(chartCard);
                }
            },

            // Lifecycle
            init() {
                if (this.state.rounds.length === 0) {
                    const founderRound = {
                        ...this.fundingSequence.roundDefaults.founders,
                        id: Date.now()
                    };
                    this.state.rounds.push(founderRound);
                }
                
                if (this.state.exitDetails.payments[1] && !this.state.exitDetails.payments[1].date) {
                    this.state.exitDetails.payments[1].date = this.calculations.addMonths(this.state.exitDetails.exitDate, 12);
                }

                this.tooltipSystem.init();
                this.bindEvents();
                this.applyPerformanceOptimizations();
                this.render();
            },
            
            applyPerformanceOptimizations() {
			    const originalRender = this.render.bind(this);
			    this.render = this.performanceSystem.createThrottle(originalRender, 100);
			    
			    const originalValidateField = this.validation.validateField.bind(this.validation);
			    this.validation.validateField = this.performanceSystem.createDebounce(originalValidateField, 300);
			    
			    const originalGetTotalShares = this.getTotalShares.bind(this);
			    this.getTotalShares = () => {
			        return this.performanceSystem.getCached('totalShares', originalGetTotalShares);
			    };
			    
			    const originalUpdateField = this.updateField.bind(this);
			    this.updateField = (fieldKey, value) => {
			        this.performanceSystem.invalidateCache();
			        originalUpdateField(fieldKey, value);
			    };
			},

            bindEvents() {
                const appEl = document.getElementById('app');

                // Add scroll detection
                let scrollTimer = null;
                this._isScrolling = false;
                
                window.addEventListener('scroll', () => {
                    this._isScrolling = true;
                    clearTimeout(scrollTimer);
                    scrollTimer = setTimeout(() => {
                        this._isScrolling = false;
                    }, 150);
                }, true);
                
                // Touch event handling for mobile
                let touchStartY = 0;
                let touchStartTime = 0;
                
                appEl.addEventListener('touchstart', (e) => {
                    touchStartY = e.touches[0].clientY;
                    touchStartTime = Date.now();
                }, { passive: true });
                
                appEl.addEventListener('touchend', (e) => {
                    const touchEndY = e.changedTouches[0].clientY;
                    const touchEndTime = Date.now();
                    const deltaY = Math.abs(touchEndY - touchStartY);
                    const deltaTime = touchEndTime - touchStartTime;
                    
                    // If it was a scroll gesture (moved more than 10px or took longer than 300ms), ignore clicks
                    if (deltaY > 10 || deltaTime > 300) {
                        this._isScrolling = true;
                        setTimeout(() => { this._isScrolling = false; }, 100);
                    }
                }, { passive: true });

                appEl.addEventListener('click', (e) => {
                    const collapsibleHeader = e.target.closest('.card-header[data-collapsible]');
                    if (collapsibleHeader) {
                        const card = collapsibleHeader.parentElement;
                        const cardId = card.id;
                        if (cardId) {
                            this.state.collapsibleState[cardId] = !this.state.collapsibleState[cardId];
                            card.classList.toggle('collapsed');
                        }
                        return;
                    }

                    const target = e.target.closest('[data-action], [data-route], [data-tab]');
                    if (!target) return;

                    const action = target.dataset.action;
                    if (action && this.actions[action]) {
                        e.preventDefault();
                        this.actions[action].call(this, e);
                        return;
                    }

                    const route = target.dataset.route;
                    if (route) {
                        e.preventDefault();
                        window.location.hash = route;
                        return;
                    }
                    
                    const tab = target.dataset.tab;
                    if (tab) {
                        e.preventDefault();
                        // Add delay and check for scrolling
                        if (!this._isScrolling) {
                            this.switchTab(tab);
                        }
                        return;
                    }
                });

                appEl.addEventListener('input', (e) => {
                    const target = e.target;
                    if (target.dataset.field && target.type !== 'checkbox' && target.tagName.toLowerCase() !== 'select') {
                        const fieldKey = target.dataset.field;
                        const originalValue = target.value;
                        const selectionStart = target.selectionStart;
                        
                        this.updateField(fieldKey, originalValue);
                        
                        const isNumeric = !fieldKey.includes('percent') && !fieldKey.includes('discount') && target.type !== 'date' && !fieldKey.includes('rate') && !fieldKey.includes('strike');
                        if (isNumeric) {
                           const numericValue = this.formatValue(originalValue, { mode: 'parse' });
                           const formattedValue = this.formatValue(numericValue, { mode: 'input' });
                           
                           if (originalValue !== formattedValue) {
                               const diff = formattedValue.length - originalValue.length;
                               target.value = formattedValue;
                               target.setSelectionRange(selectionStart + diff, selectionStart + diff);
                           }
                        }

                        const currentValue = target.type === 'date' ? target.value : this.formatValue(target.value, { mode: 'parse' });
                        this.validation.validateField(fieldKey, currentValue, 'input');
                        this.render();
                    }
                });

                appEl.addEventListener('blur', (e) => {
                    const target = e.target;
                    if (target.dataset.field && target.type !== 'checkbox' && target.tagName.toLowerCase() !== 'select') {
                        const fieldKey = target.dataset.field;
                        const value = target.type === 'date' ? target.value : this.formatValue(target.value, { mode: 'parse' });
                        this.validation.validateField(fieldKey, value, 'blur');
                        this.render();
                    }
                }, true);
                
                appEl.addEventListener('change', (e) => {
                    const target = e.target;
                    const fieldKey = target.dataset.field;

                    if (target.id === 'exampleScenarioSelect') {
                        const value = target.value;
                        if (value && value !== '' && value !== 'undefined' && value !== 'null') {
                            WaterfallCalculator.actions.loadExample.call(this, value);
                        } else {
                           this.clearScenarioSelection();
                        }
                        return;
                    }
                    
                    if (!fieldKey) return;

                    if (target.type === 'checkbox') {
                        this.updateField(fieldKey, target.checked);
                    } else { // Handles select and other future input types
                        this.updateField(fieldKey, target.value);
                    }

                    this.validation.validate(); // Re-run full validation on any change
                    this.render();
                });

                window.addEventListener('hashchange', () => this.render());

                if (!this._resizeListenerAttached) {
                  this._resizeListenerAttached = true;
                  let _resizeTimer = null;
                  window.addEventListener('resize', () => {
                    clearTimeout(_resizeTimer);
                    _resizeTimer = setTimeout(() => this.render(), 100);
                  });
                  window.addEventListener('orientationchange', () => this.render());
                }
            },
            
            switchTab(tabName) {
                // Prevent tab switching if user is scrolling
                if (this._isScrolling) return;
                
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const activeTab = document.getElementById(`${tabName}-tab`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            },

            updateScenarioBadges() {
                const badges = document.querySelectorAll('.scenario-badge');
                badges.forEach(badge => {
                    if (!this.exampleScenarios.currentScenario) {
                        badge.style.display = 'none';
                        return;
                    }
                    
                    const scenario = this.exampleScenarios[this.exampleScenarios.currentScenario];
                    const modified = this.exampleScenarios.currentScenarioModified;
                    
                    badge.innerHTML = `
                        <strong>Scenario:</strong> ${scenario.name}
                        ${modified ? `<em style="color: var(--warning); font-weight: bold;"> (Modified)</em>` : ''}
                        ${modified ? `
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="WaterfallCalculator.resetToOriginalScenario()"
                                    style="margin-left: 1rem; padding: 0.25rem 0.75rem;">
                                Reset
                            </button>
                        ` : ''}
                    `;
                    badge.style.background = modified ? '#fffbe6' : 'var(--primary-light)';
                    badge.style.border = `1px solid ${modified ? 'var(--warning)' : 'var(--primary)'}`;
                    badge.style.display = 'inline-block';
                });
            },

            render() {
                const isMobile = window.innerWidth < 768;
                
                if (this.state.collapsibleState['card-exit-details'] === undefined) {
                    this.state.collapsibleState['card-exit-details'] = isMobile;
                }
                if (this.state.collapsibleState['card-dilution-impact'] === undefined) {
                    this.state.collapsibleState['card-dilution-impact'] = isMobile;
                }

                this.validation.validate();
                
                const route = window.location.hash || '#/';
                const templateName = this.routes[route];
                
                if (templateName && this.templates[templateName]) {
                    const app = document.getElementById('app');
                    
                    const activeElement = document.activeElement;
                    const activeField = activeElement ? activeElement.dataset.field : null;
                    const selectionStart = activeElement ? activeElement.selectionStart : null;

                    this.charts.destroy();

                    app.innerHTML = `
                        <div class="container">
                            ${this.templates[templateName].call(this)}
                        </div>
                        ${this.renderMobileNav()}
                    `;
                    
                    if (activeField) {
                        const newActiveElement = app.querySelector(`[data-field="${activeField}"]`);
                        if (newActiveElement) {
                            newActiveElement.focus();
                             if(newActiveElement.setSelectionRange && 
                               newActiveElement.type !== 'number' && 
                               newActiveElement.type !== 'checkbox' && 
                               newActiveElement.tagName !== 'SELECT') {
                                newActiveElement.setSelectionRange(selectionStart, selectionStart);
                            }
                        }
                    }

                    if (route === '#/results' && this.state.results) {
                        this.charts.initResultsObserver();
                    } else if (route === '#/sensitivity') {
                        const { minExit, maxExit, stepCount } = this.state.sensitivity;
                        if (maxExit > 0) { // Ensure defaults are set before initializing
                            const stepSize = stepCount > 1 ? (maxExit - minExit) / (stepCount - 1) : 0;
                            const scenarios = this.sensitivity.calculateScenarios(minExit, maxExit, stepSize);
                            this.charts.initSensitivityObserver(scenarios);
                        }
                    }
                }
            },
            
            toggleValidationMode() {
                this.state.validationMode.enabled = !this.state.validationMode.enabled;
                if (this.state.validationMode.enabled && this.state.results) {
                    const event = { preventDefault: () => {} };
                    this.actions.calculate.call(this, event);
                } else {
                    this.render();
                }
            },

            exportLedger() {
                const ledger = this.state.validationMode.ledger;
                if (!ledger || ledger.length === 0) return;
                
                const headers = ['Step', 'Operation', 'Amount', 'Balance', 'Category', 'Details'];
                const rows = ledger.map(entry => [
                    entry.step,
                    `"${entry.operation.replace(/"/g, '""')}"`,
                    entry.amount,
                    entry.balance,
                    entry.category,
                    `"${JSON.stringify(entry.details).replace(/"/g, '""')}"`
                ]);
                
                const csv = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `validation-ledger-${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
            },

            ledgerSystem: {
                initLedger() {
                    if (!WaterfallCalculator.state.validationMode.enabled) return;
                    WaterfallCalculator.state.validationMode.ledger = [];
                    WaterfallCalculator.state.validationMode.startTime = Date.now();
                },
                
                record(operation, amount, balance, details = {}) {
                    if (!WaterfallCalculator.state.validationMode.enabled) return;
                    const entry = {
                        step: WaterfallCalculator.state.validationMode.ledger.length + 1,
                        timestamp: Date.now(),
                        operation,
                        amount: Math.round(amount * 100) / 100,
                        balance: Math.round(balance * 100) / 100,
                        details,
                        category: this.categorizeOperation(operation)
                    };
                    WaterfallCalculator.state.validationMode.ledger.push(entry);
                },
                
                categorizeOperation(operation) {
                    if (operation.includes('Gross')) return 'gross';
                    if (operation.includes('Expense') || operation.includes('Debt') || operation.includes('Fee')) return 'expenses';
                    if (operation.includes('Carve-out') || operation.includes('MIP')) return 'allocations';
                    if (operation.includes('Preference')) return 'preferences';
                    if (operation.includes('Participation')) return 'participation';
                    if (operation.includes('SAFE')) return 'conversion';
                    return 'other';
                },
                
                finalizeLedger(totalDistributed, netProceeds) {
                    if (!WaterfallCalculator.state.validationMode.enabled) return;
                    WaterfallCalculator.state.validationMode.endTime = Date.now();
                    
                    const reconciliation = {
                        expected: netProceeds,
                        actual: totalDistributed,
                        delta: Math.abs(netProceeds - totalDistributed),
                        balanced: Math.abs(netProceeds - totalDistributed) < 0.01,
                        executionTime: WaterfallCalculator.state.validationMode.endTime - WaterfallCalculator.state.validationMode.startTime
                    };
                    WaterfallCalculator.state.validationMode.reconciliation = reconciliation;
                    
                    this.record('Final Reconciliation Check', reconciliation.delta, totalDistributed, { expected: reconciliation.expected, actual: reconciliation.actual, balanced: reconciliation.balanced });
                }
            },
            
            tooltipSystem: {
                portal: null,
                currentTrigger: null,
                hideTimeout: null,
                
                init() {
                    if (!document.getElementById('tooltip-portal')) {
                        const portal = document.createElement('div');
                        portal.id = 'tooltip-portal';
                        portal.className = 'tooltip-portal';
                        document.body.appendChild(portal);
                        this.portal = portal;
                    } else {
                        this.portal = document.getElementById('tooltip-portal');
                    }
                    this.bindEvents();
                },
                
                bindEvents() {
                    document.addEventListener('mouseenter', this.handleMouseEnter.bind(this), true);
                    document.addEventListener('mouseleave', this.handleMouseLeave.bind(this), true);
                    document.addEventListener('scroll', this.handleScroll.bind(this), true);
                    window.addEventListener('resize', this.handleResize.bind(this));
                    document.addEventListener('touchstart', this.handleTouch.bind(this), true);
                },
                
                handleMouseEnter(e) {
                    if (!e.target || typeof e.target.closest !== 'function') return;
                    const trigger = e.target.closest('[data-tooltip]');
                    if (!trigger) return;
                    if (this.hideTimeout) {
                        clearTimeout(this.hideTimeout);
                        this.hideTimeout = null;
                    }
                    this.show(trigger);
                },
                
                handleMouseLeave(e) {
                    if (!e.target || typeof e.target.closest !== 'function') return;
                    const trigger = e.target.closest('[data-tooltip]');
                    if (!trigger) return;
                    this.hideTimeout = setTimeout(() => this.hide(), 100);
                },
                
                handleTouch(e) {
                    if (!e.target || typeof e.target.closest !== 'function') return;
                    const trigger = e.target.closest('[data-tooltip]');
                    if (!trigger) return;
                    e.preventDefault();
                    if (this.currentTrigger === trigger) {
                        this.hide();
                    } else {
                        this.show(trigger);
                        setTimeout(() => this.hide(), 3000);
                    }
                },
                
                handleScroll() {
                    if (this.currentTrigger && this.portal.style.display === 'block') {
                        this.position(this.currentTrigger);
                    }
                },
                
                handleResize() {
                    if (this.currentTrigger) {
                        this.position(this.currentTrigger);
                    }
                },
                
                show(trigger) {
                    this.currentTrigger = trigger;
                    const content = trigger.dataset.tooltip;
                    this.portal.innerHTML = `
                        <div class="tooltip-portal-content">
                            ${content}
                            <div class="tooltip-portal-arrow"></div>
                        </div>
                    `;
                    this.portal.style.display = 'block';
                    requestAnimationFrame(() => this.position(trigger));
                },
                
                hide() {
                    this.portal.style.display = 'none';
                    this.currentTrigger = null;
                },
                
                position(trigger) {
                    const rect = trigger.getBoundingClientRect();
                    const portalContent = this.portal.querySelector('.tooltip-portal-content');
                    const arrow = this.portal.querySelector('.tooltip-portal-arrow');
                    if (!portalContent) return;
                    
                    const portalRect = portalContent.getBoundingClientRect();
                    let top = rect.top - portalRect.height - 12;
                    let left = rect.left + (rect.width / 2) - (portalRect.width / 2);
                    let placement = 'top';
                    
                    if (top < 10) {
                        top = rect.bottom + 12;
                        placement = 'bottom';
                    }
                    
                    const rightEdge = left + portalRect.width;
                    const viewportWidth = window.innerWidth;
                    if (rightEdge > viewportWidth - 10) {
                        left = viewportWidth - portalRect.width - 10;
                    }
                    if (left < 10) {
                        left = 10;
                    }
                    
                    this.portal.style.top = `${top}px`;
                    this.portal.style.left = `${left}px`;
                    arrow.className = `tooltip-portal-arrow ${placement}`;
                    
                    const arrowLeft = rect.left + (rect.width / 2) - left;
                    arrow.style.left = `${arrowLeft}px`;
                }
            },
            
            performanceSystem: {
			    cache: new Map(),
			    cacheTimestamps: new Map(),
			    cacheMaxAge: 5 * 60 * 1000,
			    renderScheduled: false,
			    
			    createThrottle(func, delay) {
			        let timeoutId;
			        let lastExecTime = 0;
			        let pending = false;
			        
			        return function throttled(...args) {
			            const now = Date.now();
			            const timeSinceLastExec = now - lastExecTime;
			            
			            if (timeSinceLastExec >= delay) {
			                func.apply(this, args);
			                lastExecTime = now;
			                pending = false;
			            } else if (!pending) {
			                pending = true;
			                timeoutId = setTimeout(() => {
			                    func.apply(this, args);
			                    lastExecTime = Date.now();
			                    pending = false;
			                }, delay - timeSinceLastExec);
			            }
			        };
			    },
			    
			    createDebounce(func, delay) {
			        let timeoutId;
			        
			        return function debounced(...args) {
			            clearTimeout(timeoutId);
			            timeoutId = setTimeout(() => {
			                func.apply(this, args);
			            }, delay);
			        };
			    },
			    
			    getCached(key, calculator) {
			        if (this.cache.has(key)) {
			            const timestamp = this.cacheTimestamps.get(key);
			            if (Date.now() - timestamp < this.cacheMaxAge) {
			                return this.cache.get(key);
			            }
			        }
			        
			        const value = calculator();
			        this.cache.set(key, value);
			        this.cacheTimestamps.set(key, Date.now());
			        return value;
			    },
			    
			    invalidateCache(pattern = null) {
			        if (!pattern) {
			            this.cache.clear();
			            this.cacheTimestamps.clear();
			        } else {
			            for (const key of this.cache.keys()) {
			                if (key.includes(pattern)) {
			                    this.cache.delete(key);
			                    this.cacheTimestamps.delete(key);
			                }
			            }
			        }
			    },
			    
			    scheduleRender(renderFunc) {
			        if (this.renderScheduled) return;
			        
			        this.renderScheduled = true;
			        requestAnimationFrame(() => {
			            renderFunc();
			            this.renderScheduled = false;
			        });
			    },
			    
			    measurePerformance(name, func) {
			        if (!window.performance || !window.performance.mark) {
			            return func();
			        }
			        
			        const startMark = `${name}-start`;
			        const endMark = `${name}-end`;
			        
			        performance.mark(startMark);
			        const result = func();
			        performance.mark(endMark);
			        performance.measure(name, startMark, endMark);
			        
			        const measure = performance.getEntriesByName(name)[0];
			        if (measure && measure.duration > 100) {
			            console.warn(`[Performance] ${name} took ${measure.duration.toFixed(2)}ms`);
			        }
			        
			        return result;
			    }
			},

        };

        document.addEventListener('DOMContentLoaded', () => {
            WaterfallCalculator.init();
        });

    </script>
</body>
</html>
